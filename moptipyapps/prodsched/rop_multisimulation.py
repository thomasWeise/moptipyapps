"""
A simulator for multiple runs of the ROP scenario.

Re-Order-Point (ROP) scenarios are such that for each product, a value `X` is
provided. Once there are no more than `X` elements of that product in the
warehouse, one new unit is ordered to be produced.
Therefore, we have `n_products` such `X` values.
A simulation in this scenario is implemented in
:mod:`~moptipyapps.prodsched.rop_simulation` as class
:class:`~moptipyapps.prodsched.rop_simulation.ROPSimulation`.

This module here provides the functionality to simulate this ROP-approach
over *multiple* instances (:class:`~moptipyapps.prodsched.instance.Instance`).
It acts as an :class:`~moptipy.api.encoding.Encoding` that converts a re-order
point into an instance of
:class:`~moptipyapps.prodsched.multistatistics.MultiStatistics` which can then
be used as basis to compute the values of (potentially multiple)
objective functions, such as those given in package
:mod:`~moptipyapps.prodsched.objectives`.

Now, doing a multi-simulation is costly.
It takes from half a second to several seconds.
It is unlikely that we can do more than a million in any run of an
optimization algorithm.
Therefore, we use an internal caching mechanism to store all the input
vectors and output statistics.
This may consume quite some memory, but it might be faster.

>>> from moptipyapps.prodsched.mfc_generator import sample_mfc_instance
>>> from moptipyapps.prodsched.mfc_generator import Product
>>> from moptipyapps.prodsched.mfc_generator import Station
>>> from moptipyapps.utils.sampling import Gamma
>>> from moptipyapps.prodsched.multistatistics import to_stream

>>> inst1 = sample_mfc_instance(seed=100)
>>> inst2 = sample_mfc_instance(seed=200)

>>> instances = (inst1, inst2)
>>> ms = ROPMultiSimulation(instances)
>>> space = MultiStatisticsSpace(instances)

>>> x1 = np.array([4, 6, 3, 4, 4, 6, 3, 5, 6, 10])
>>> y = space.create()
>>> ms.decode(x1, y)
>>> for s in to_stream(y):
...     if "time" not in s:
...         print(s)
-------- Instance 0: 'mfc_10_13_10000_0x64' -------
stat;total;product_0;product_1;product_2;product_3;product_4;product_5;\
product_6;product_7;product_8;product_9
trp.min;5.2184145757182705;5.2184145757182705;8.901258396714184;\
9.297175556856018;7.298761505635412;8.93985302431065;12.606621860129053;\
7.656178022299173;20.904266810249283;19.5732602761791;20.522703426695443
trp.mean;32.405411220867336;22.45718865883824;29.222031978321247;\
25.136275651698107;25.884250065648388;27.37383814423524;32.10269885414455;\
21.905835255853667;45.11627023942567;44.78387873021794;49.465651426661886
trp.max;101.42283298962138;56.30942379913131;74.17811849023519;\
58.955465373336665;60.209164983262326;60.66621167329777;74.4357130671624;\
47.944841355481;83.29062031809917;96.5279603056706;101.42283298962138
trp.sd;14.352456423754838;8.966715472534952;10.260311480773648;\
8.824583884361449;9.375043161957333;9.776116378207652;10.962890512009123;\
6.691465594834237;12.613587720623373;12.30244975508726;13.52381481631245
cwt.min;0.026454757136889384;0.026454757136889384;2.30483638259102;\
0.054286282554130594;0.16648942892061314;0.1385205442725237;\
2.2444075501571206;0.16694429707604286;0.2360807359827959;0.2894682031374032;\
0.7020815078112719
cwt.mean;8.296470547393602;4.437533958350662;12.615320110639914;\
4.7164029806433545;6.611310521050654;8.350460109042185;7.55452574755307;\
5.82304931358363;9.068938196877168;17.21719619156937;6.710247622764048
cwt.max;37.76460269749805;11.383554877750612;25.02207987420161;\
16.22657205109499;24.355088852856625;23.499199642416897;24.507644884798083;\
27.834403782263507;29.068687291493006;37.76460269749805;12.188275706294007
cwt.sd;8.072214752396842;3.8478370296451603;9.569679438559595;\
4.197433045217076;7.324722986150041;6.142260031783497;6.213481379280693;\
7.142777751769366;7.629569041217826;11.995928244823393;5.761419012759379
fill.rate;0.9475719810915342;0.9673295454545454;0.9869565217391304;\
0.9121037463976945;0.9595808383233533;0.93033381712627;0.9775280898876404;\
0.9477401129943502;0.8531073446327684;0.9452449567723343;0.9957983193277311
stocklevel.mean;29.106301317812118;2.760696025360742;4.137393715988243;\
1.5507610335648132;2.5500355305055966;2.3659654563794095;3.7559706390001586;\
1.811228677305335;1.5668982789103876;2.657874734996926;5.949477225800507
fulfilled.rate;1;1;1;1;1;1;1;1;1;1;1
-------- Instance 1: 'mfc_10_13_10000_0xc8' -------
stat;total;product_0;product_1;product_2;product_3;product_4;product_5;\
product_6;product_7;product_8;product_9
trp.min;6.530138861169689;6.530138861169689;9.628902017961991;\
8.559079500931148;9.008831732480758;8.17345928487157;10.857776143797764;\
7.1989408754006945;20.221688833546978;20.764475417566246;18.683929092542712
trp.mean;31.011119751546097;20.636089799689874;27.67447485260846;\
23.897005119242046;24.208477302980572;25.25418917347286;29.761302044694876;\
23.04493364417017;43.39775607053671;45.37848659776272;46.77244686997264
trp.max;82.04580382289168;45.2064686844069;55.755010710267015;\
47.241916696964836;46.46518160018422;56.86270345999128;58.305458902948885;\
52.54891087334727;80.98768370429207;80.62246465566932;82.04580382289168
trp.sd;12.96227404463328;6.684031626500774;7.995431160774385;\
7.132422793760531;7.239745166217043;8.109774006790918;8.249688118912145;\
7.915621083543569;10.500873112173776;10.750658149592526;10.934157433002026
cwt.min;0.011249992165176081;0.5337058348654864;0.8014497560352538;\
0.2827261678148716;1.4241222500077129;0.011249992165176081;7.901938969392177;\
0.041148101390717784;0.08459428467904218;0.10726475210685749;
cwt.mean;7.183224986008803;1.9535417603494485;0.8014497560352538;\
4.619753737796203;9.370441335605987;7.744917661655692;7.901938969392177;\
8.052111019031262;8.505184343659167;5.922113521223626;
cwt.max;31.446190263142853;5.290086057329063;0.8014497560352538;\
10.883639956720799;25.608040164921476;24.178558590047942;7.901938969392177;\
31.446190263142853;21.35684648685401;16.312679904455308;
cwt.sd;6.15364337829274;1.7473126971982065;;3.440991075922831;\
6.485559248771155;6.715154696592823;;7.703968965710594;6.633960138504885;\
3.8259446158453017;
fill.rate;0.9628522630230573;0.9901408450704225;0.9985569985569985;\
0.9544159544159544;0.9635343618513323;0.9702127659574468;0.998546511627907;\
0.9175108538350217;0.9149855907780979;0.919831223628692;1
stocklevel.mean;30.090461520030797;2.907712049060156;4.261495763524114;\
1.6231331746350672;2.565318363579915;2.472060544282644;4.079218485848546;\
1.786007080448915;1.7664180248890007;2.4348085700118425;6.194289463750593
fulfilled.rate;1;1;1;1;1;1;1;1;1;1;1

>>> x2 = np.array([1, 1, 1, 1, 1, 1, 1, 1, 1, 1])
>>> ms.decode(x2, y)
>>> for s in to_stream(y):
...     if "time" not in s:
...         print(s)
-------- Instance 0: 'mfc_10_13_10000_0x64' -------
stat;total;product_0;product_1;product_2;product_3;product_4;product_5;\
product_6;product_7;product_8;product_9
trp.min;7.663287715103252;7.663287715103252;9.095457148523565;\
7.766240497990111;8.562181846958993;9.316040128631357;10.985466232731596;\
7.918294809653162;21.60147394131036;17.547777378904357;21.955240879517987
trp.mean;32.182938074849496;22.140701244808632;28.47300655868274;\
25.03367526681401;25.540081292675946;27.45355145426555;31.790509174952756;\
22.848381852082664;44.52135481443732;44.628532680799054;48.780078255964575
trp.max;90.86353698620042;59.31124925844961;67.52985535834341;\
53.98557871595767;59.61194121202789;59.45241944832833;67.31898313910006;\
56.0614850141219;81.02729637887933;80.10102521519639;90.86353698620042
trp.sd;13.55080270389196;8.168678848316368;9.338600023998156;\
8.450479951599732;8.617636871353389;9.348284373344056;10.208637939870723;\
7.518466597403155;10.930234897788171;10.544143459268716;12.157006455407252
cwt.min;0.011910352755876374;0.052322628985166375;0.011910352755876374;\
0.10146378360695962;0.0524298188602188;0.025453817918787536;\
0.05183870049131656;0.019666362641146407;0.08505119605797518;\
0.041104098391770094;0.35634199392734445
cwt.mean;17.582567285448004;9.404399139690337;13.569942297813908;\
9.604699962010896;10.98311819636398;13.02578680799254;16.36199335629276;\
9.05433728777719;24.801083270074987;24.958902762745797;30.451958550810023
cwt.max;77.9385378023253;38.626600188006705;53.98496252245468;\
38.07134509071511;42.09266935074265;47.99381408201043;48.82502650356764;\
44.910304177168655;61.19671763574479;61.32131436097461;77.9385378023253
cwt.sd;12.680595891084934;6.984547071390763;9.43383821564051;\
7.012918522038577;7.891903498485814;9.033444211571616;9.757435017677162;\
7.598286359665955;11.356538993918976;11.731098098924933;14.099099363785335
fill.rate;0.2175906030654634;0.40767045454545453;0.2492753623188406;\
0.3314121037463977;0.3158682634730539;0.28156748911465895;\
0.17134831460674158;0.3714689265536723;0.002824858757062147;\
0.018731988472622477;0.0350140056022409
stocklevel.mean;1.6302006108805502;0.3367466779925779;0.19929696858529114;\
0.15581052878690257;0.27567206398796995;0.2210582880452966;\
0.14995708383534714;0.261766524058465;0.00048013843604374936;\
0.006324013813991379;0.02308832333866472
fulfilled.rate;0.9982810485603781;0.9985795454545454;1;1;0.9985029940119761;\
0.9985486211901307;0.9929775280898876;1;0.9971751412429378;\
0.9985590778097982;0.9985994397759104
-------- Instance 1: 'mfc_10_13_10000_0xc8' -------
stat;total;product_0;product_1;product_2;product_3;product_4;product_5;\
product_6;product_7;product_8;product_9
trp.min;6.456526072982342;6.456526072982342;10.280447092151007;\
6.8487732247867825;7.0104482929637015;6.928763679217354;10.310002410918969;\
6.5546482603685945;18.98639893585596;20.305760878712135;19.684816736973517
trp.mean;30.62233294764437;20.55618285379736;26.886775958390697;2\
3.309369645366303;23.990410121167177;25.071330781848836;29.668457645437183;\
22.39107965050359;43.25662277895463;44.56350867653903;46.348319919246514
trp.max;78.42550095496154;50.8966871369812;54.1070436589971;\
48.669180978890836;52.42258290758127;55.73600798325697;57.290713516881624;\
53.713961902238225;78.26718994789553;78.42550095496154;76.74843649876311
trp.sd;13.071194037915653;7.013910120253621;8.186009510157717;\
7.519377794772064;7.702542096043028;8.526420667544688;8.8970364463244;\
7.682875953156183;10.548987944489301;10.828886793958864;10.898005970008226
cwt.min;0.0004850386339967372;0.00456283385574352;0.056539264354796614;\
0.005326168571627932;0.008960725403085235;0.08762150885104347;\
0.01698932920680818;0.0004850386339967372;0.2800049970701366;\
0.31679782128776424;0.12185953505104408
cwt.mean;16.459929680370593;8.156568809736969;12.374646871831668;\
8.300740034967504;10.371317340036168;10.931842774336376;14.222659911890325;\
9.16345905328603;23.137826511457558;25.434148525686762;27.66379761065284
cwt.max;60.919637988946306;29.480300784184692;35.16766467176876;\
36.653507062645986;39.00025180235298;45.453680537177206;43.580941370786604;\
45.28946949821329;56.024945551713245;59.28160733189452;60.919637988946306
cwt.sd;12.118506999914882;6.044408962707157;7.728932055062374;\
6.268950876605313;7.854789647395754;7.732399117687471;8.863583544578608;\
7.7525558824150504;11.241315012712777;12.118136175485233;12.596354952532373
fill.rate;0.24110446911471678;0.44084507042253523;0.2712842712842713;\
0.36182336182336183;0.3394109396914446;0.32340425531914896;\
0.21075581395348839;0.4196816208393632;0.002881844380403458;\
0.01969057665260197;0.025034770514603615
stocklevel.mean;1.8113476672429796;0.3802859636659473;0.23439669327549575;\
0.19451906423091544;0.2559188646462229;0.2206691076289149;0.1935442874513864;\
0.3124656055438941;0.00017487014444265826;0.008074900603352099;\
0.011298310052408007
fulfilled.rate;0.9987190435525192;1;0.9985569985569985;1;1;1;1;1;\
0.9985590778097982;0.9929676511954993;0.9972183588317107

Now the caching kicks in:

>>> x2 = np.array([1, 1, 1, 1, 1, 1, 1, 1, 1, 1])
>>> ms.decode(x2, y)
>>> for s in to_stream(y):
...     if "time" not in s:
...         print(s)
-------- Instance 0: 'mfc_10_13_10000_0x64' -------
stat;total;product_0;product_1;product_2;product_3;product_4;product_5;\
product_6;product_7;product_8;product_9
trp.min;7.663287715103252;7.663287715103252;9.095457148523565;\
7.766240497990111;8.562181846958993;9.316040128631357;10.985466232731596;\
7.918294809653162;21.60147394131036;17.547777378904357;21.955240879517987
trp.mean;32.182938074849496;22.140701244808632;28.47300655868274;\
25.03367526681401;25.540081292675946;27.45355145426555;31.790509174952756;\
22.848381852082664;44.52135481443732;44.628532680799054;48.780078255964575
trp.max;90.86353698620042;59.31124925844961;67.52985535834341;\
53.98557871595767;59.61194121202789;59.45241944832833;67.31898313910006;\
56.0614850141219;81.02729637887933;80.10102521519639;90.86353698620042
trp.sd;13.55080270389196;8.168678848316368;9.338600023998156;\
8.450479951599732;8.617636871353389;9.348284373344056;10.208637939870723;\
7.518466597403155;10.930234897788171;10.544143459268716;12.157006455407252
cwt.min;0.011910352755876374;0.052322628985166375;0.011910352755876374;\
0.10146378360695962;0.0524298188602188;0.025453817918787536;\
0.05183870049131656;0.019666362641146407;0.08505119605797518;\
0.041104098391770094;0.35634199392734445
cwt.mean;17.582567285448004;9.404399139690337;13.569942297813908;\
9.604699962010896;10.98311819636398;13.02578680799254;16.36199335629276;\
9.05433728777719;24.801083270074987;24.958902762745797;30.451958550810023
cwt.max;77.9385378023253;38.626600188006705;53.98496252245468;\
38.07134509071511;42.09266935074265;47.99381408201043;48.82502650356764;\
44.910304177168655;61.19671763574479;61.32131436097461;77.9385378023253
cwt.sd;12.680595891084934;6.984547071390763;9.43383821564051;\
7.012918522038577;7.891903498485814;9.033444211571616;9.757435017677162;\
7.598286359665955;11.356538993918976;11.731098098924933;14.099099363785335
fill.rate;0.2175906030654634;0.40767045454545453;0.2492753623188406;\
0.3314121037463977;0.3158682634730539;0.28156748911465895;\
0.17134831460674158;0.3714689265536723;0.002824858757062147;\
0.018731988472622477;0.0350140056022409
stocklevel.mean;1.6302006108805502;0.3367466779925779;0.19929696858529114;\
0.15581052878690257;0.27567206398796995;0.2210582880452966;\
0.14995708383534714;0.261766524058465;0.00048013843604374936;\
0.006324013813991379;0.02308832333866472
fulfilled.rate;0.9982810485603781;0.9985795454545454;1;1;0.9985029940119761;\
0.9985486211901307;0.9929775280898876;1;0.9971751412429378;\
0.9985590778097982;0.9985994397759104
-------- Instance 1: 'mfc_10_13_10000_0xc8' -------
stat;total;product_0;product_1;product_2;product_3;product_4;product_5;\
product_6;product_7;product_8;product_9
trp.min;6.456526072982342;6.456526072982342;10.280447092151007;\
6.8487732247867825;7.0104482929637015;6.928763679217354;10.310002410918969;\
6.5546482603685945;18.98639893585596;20.305760878712135;19.684816736973517
trp.mean;30.62233294764437;20.55618285379736;26.886775958390697;2\
3.309369645366303;23.990410121167177;25.071330781848836;29.668457645437183;\
22.39107965050359;43.25662277895463;44.56350867653903;46.348319919246514
trp.max;78.42550095496154;50.8966871369812;54.1070436589971;\
48.669180978890836;52.42258290758127;55.73600798325697;57.290713516881624;\
53.713961902238225;78.26718994789553;78.42550095496154;76.74843649876311
trp.sd;13.071194037915653;7.013910120253621;8.186009510157717;\
7.519377794772064;7.702542096043028;8.526420667544688;8.8970364463244;\
7.682875953156183;10.548987944489301;10.828886793958864;10.898005970008226
cwt.min;0.0004850386339967372;0.00456283385574352;0.056539264354796614;\
0.005326168571627932;0.008960725403085235;0.08762150885104347;\
0.01698932920680818;0.0004850386339967372;0.2800049970701366;\
0.31679782128776424;0.12185953505104408
cwt.mean;16.459929680370593;8.156568809736969;12.374646871831668;\
8.300740034967504;10.371317340036168;10.931842774336376;14.222659911890325;\
9.16345905328603;23.137826511457558;25.434148525686762;27.66379761065284
cwt.max;60.919637988946306;29.480300784184692;35.16766467176876;\
36.653507062645986;39.00025180235298;45.453680537177206;43.580941370786604;\
45.28946949821329;56.024945551713245;59.28160733189452;60.919637988946306
cwt.sd;12.118506999914882;6.044408962707157;7.728932055062374;\
6.268950876605313;7.854789647395754;7.732399117687471;8.863583544578608;\
7.7525558824150504;11.241315012712777;12.118136175485233;12.596354952532373
fill.rate;0.24110446911471678;0.44084507042253523;0.2712842712842713;\
0.36182336182336183;0.3394109396914446;0.32340425531914896;\
0.21075581395348839;0.4196816208393632;0.002881844380403458;\
0.01969057665260197;0.025034770514603615
stocklevel.mean;1.8113476672429796;0.3802859636659473;0.23439669327549575;\
0.19451906423091544;0.2559188646462229;0.2206691076289149;0.1935442874513864;\
0.3124656055438941;0.00017487014444265826;0.008074900603352099;\
0.011298310052408007
fulfilled.rate;0.9987190435525192;1;0.9985569985569985;1;1;1;1;1;\
0.9985590778097982;0.9929676511954993;0.9972183588317107

>>> x1 = np.array([4, 6, 3, 4, 4, 6, 3, 5, 6, 10])
>>> y = space.create()
>>> ms.decode(x1, y)
>>> for s in to_stream(y):
...     if "time" not in s:
...         print(s)
-------- Instance 0: 'mfc_10_13_10000_0x64' -------
stat;total;product_0;product_1;product_2;product_3;product_4;product_5;\
product_6;product_7;product_8;product_9
trp.min;5.2184145757182705;5.2184145757182705;8.901258396714184;\
9.297175556856018;7.298761505635412;8.93985302431065;12.606621860129053;\
7.656178022299173;20.904266810249283;19.5732602761791;20.522703426695443
trp.mean;32.405411220867336;22.45718865883824;29.222031978321247;\
25.136275651698107;25.884250065648388;27.37383814423524;32.10269885414455;\
21.905835255853667;45.11627023942567;44.78387873021794;49.465651426661886
trp.max;101.42283298962138;56.30942379913131;74.17811849023519;\
58.955465373336665;60.209164983262326;60.66621167329777;74.4357130671624;\
47.944841355481;83.29062031809917;96.5279603056706;101.42283298962138
trp.sd;14.352456423754838;8.966715472534952;10.260311480773648;\
8.824583884361449;9.375043161957333;9.776116378207652;10.962890512009123;\
6.691465594834237;12.613587720623373;12.30244975508726;13.52381481631245
cwt.min;0.026454757136889384;0.026454757136889384;2.30483638259102;\
0.054286282554130594;0.16648942892061314;0.1385205442725237;\
2.2444075501571206;0.16694429707604286;0.2360807359827959;0.2894682031374032;\
0.7020815078112719
cwt.mean;8.296470547393602;4.437533958350662;12.615320110639914;\
4.7164029806433545;6.611310521050654;8.350460109042185;7.55452574755307;\
5.82304931358363;9.068938196877168;17.21719619156937;6.710247622764048
cwt.max;37.76460269749805;11.383554877750612;25.02207987420161;\
16.22657205109499;24.355088852856625;23.499199642416897;24.507644884798083;\
27.834403782263507;29.068687291493006;37.76460269749805;12.188275706294007
cwt.sd;8.072214752396842;3.8478370296451603;9.569679438559595;\
4.197433045217076;7.324722986150041;6.142260031783497;6.213481379280693;\
7.142777751769366;7.629569041217826;11.995928244823393;5.761419012759379
fill.rate;0.9475719810915342;0.9673295454545454;0.9869565217391304;\
0.9121037463976945;0.9595808383233533;0.93033381712627;0.9775280898876404;\
0.9477401129943502;0.8531073446327684;0.9452449567723343;0.9957983193277311
stocklevel.mean;29.106301317812118;2.760696025360742;4.137393715988243;\
1.5507610335648132;2.5500355305055966;2.3659654563794095;3.7559706390001586;\
1.811228677305335;1.5668982789103876;2.657874734996926;5.949477225800507
fulfilled.rate;1;1;1;1;1;1;1;1;1;1;1
-------- Instance 1: 'mfc_10_13_10000_0xc8' -------
stat;total;product_0;product_1;product_2;product_3;product_4;product_5;\
product_6;product_7;product_8;product_9
trp.min;6.530138861169689;6.530138861169689;9.628902017961991;\
8.559079500931148;9.008831732480758;8.17345928487157;10.857776143797764;\
7.1989408754006945;20.221688833546978;20.764475417566246;18.683929092542712
trp.mean;31.011119751546097;20.636089799689874;27.67447485260846;\
23.897005119242046;24.208477302980572;25.25418917347286;29.761302044694876;\
23.04493364417017;43.39775607053671;45.37848659776272;46.77244686997264
trp.max;82.04580382289168;45.2064686844069;55.755010710267015;\
47.241916696964836;46.46518160018422;56.86270345999128;58.305458902948885;\
52.54891087334727;80.98768370429207;80.62246465566932;82.04580382289168
trp.sd;12.96227404463328;6.684031626500774;7.995431160774385;\
7.132422793760531;7.239745166217043;8.109774006790918;8.249688118912145;\
7.915621083543569;10.500873112173776;10.750658149592526;10.934157433002026
cwt.min;0.011249992165176081;0.5337058348654864;0.8014497560352538;\
0.2827261678148716;1.4241222500077129;0.011249992165176081;7.901938969392177;\
0.041148101390717784;0.08459428467904218;0.10726475210685749;
cwt.mean;7.183224986008803;1.9535417603494485;0.8014497560352538;\
4.619753737796203;9.370441335605987;7.744917661655692;7.901938969392177;\
8.052111019031262;8.505184343659167;5.922113521223626;
cwt.max;31.446190263142853;5.290086057329063;0.8014497560352538;\
10.883639956720799;25.608040164921476;24.178558590047942;7.901938969392177;\
31.446190263142853;21.35684648685401;16.312679904455308;
cwt.sd;6.15364337829274;1.7473126971982065;;3.440991075922831;\
6.485559248771155;6.715154696592823;;7.703968965710594;6.633960138504885;\
3.8259446158453017;
fill.rate;0.9628522630230573;0.9901408450704225;0.9985569985569985;\
0.9544159544159544;0.9635343618513323;0.9702127659574468;0.998546511627907;\
0.9175108538350217;0.9149855907780979;0.919831223628692;1
stocklevel.mean;30.090461520030797;2.907712049060156;4.261495763524114;\
1.6231331746350672;2.565318363579915;2.472060544282644;4.079218485848546;\
1.786007080448915;1.7664180248890007;2.4348085700118425;6.194289463750593
fulfilled.rate;1;1;1;1;1;1;1;1;1;1;1
"""
from typing import Final, Iterable

import numpy as np
from moptipy.api.encoding import Encoding
from pycommons.types import type_error

from moptipyapps.prodsched.instance import (
    Instance,
)
from moptipyapps.prodsched.multistatistics import (
    MultiStatistics,
    MultiStatisticsSpace,
)
from moptipyapps.prodsched.rop_simulation import ROPSimulation
from moptipyapps.prodsched.statistics_collector import StatisticsCollector


class ROPMultiSimulation(Encoding):
    """A multi-simulation that caches the results for reuse."""

    def __init__(self, instances: Iterable[Instance]) -> None:
        """
        Instantiate the multi-statistics decoding.

        :param instances: the packing instance
        """
        if not isinstance(instances, Iterable):
            raise type_error(instances, "instances", Iterable)
        #: the statistics collectors
        col: Final[tuple[StatisticsCollector, ...]] = tuple(
            StatisticsCollector(inst) for inst in instances)
        #: the instance set
        self.__instances: Final[tuple[Instance, ...]] = tuple(instances)
        #: the simulations and collectors
        self.__simulations: Final[tuple[tuple[
            ROPSimulation, StatisticsCollector], ...]] = tuple(
            (ROPSimulation(inst, col[i]), col[i])
            for i, inst in enumerate(self.__instances))
        #: the internal cache
        self.__cache: Final[dict[tuple[int, ...], MultiStatistics]] = {}
        #: the internal space
        self.__space: Final[MultiStatisticsSpace] = MultiStatisticsSpace(
            self.__instances)

    def decode(self, x: np.ndarray, y: MultiStatistics) -> None:
        """
        Map a ROP setting to a multi-statistics.

        :param x: the array
        :param y: the Gantt chart
        """
        # First we map the vector to a tuple of integers.
        x_tuple: Final[tuple[int, ...]] = tuple(map(int, x))
        # Now we can look up this tuple in the cache.
        if x_tuple in self.__cache:
            # If we get here, this means we already simulated this ROP.
            # Since the simulations are deterministic, we can re-use the
            # result.
            self.__space.copy(y, self.__cache[x_tuple])
            return  # And we are done.

        # If we get here, the ROP is new.
        # So we simulate it.
        for i, (sim, col) in enumerate(self.__simulations):
            col.set_dest(y.per_instance[i])
            sim.ctrl_reset()
            sim.set_rop(x)
            sim.ctrl_run()

        # The simulation is completed. We can now cache the result.
        cached: Final[MultiStatistics] = self.__space.create()
        self.__space.copy(cached, y)
        self.__cache[x_tuple] = cached

    def __str__(self) -> str:
        """
        Get the name of this decoding.

        :return: `"rms"`
        :rtype: str
        """
        return "rms"
