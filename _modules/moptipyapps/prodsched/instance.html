<!doctype html><html data-content_root=../../../ lang=en><meta charset=utf-8><meta content="width=device-width,initial-scale=1.0"name=viewport><title>moptipyapps.prodsched.instance — moptipyapps 0.8.79 documentation</title><link href="../../../_static/pygments.css?v=b86133f3"rel=stylesheet><link href="../../../_static/bizstyle.css?v=5283bb3d"rel=stylesheet><script src="../../../_static/documentation_options.js?v=38375235"></script><script src="../../../_static/doctools.js?v=9bcbadda"></script><script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script><script src=../../../_static/bizstyle.js></script><link href=https://thomasweise.github.io/moptipyapps/_modules/moptipyapps/prodsched/instance.html rel=canonical><link href=../../../genindex.html rel=index title=Index><link href=../../../search.html rel=search title=Search><meta content="width=device-width,initial-scale=1.0"name=viewport><body><div aria-label=Related class=related role=navigation><h3>Navigation</h3><ul><li class=right style=margin-right:10px><a title="General Index"accesskey=I href=../../../genindex.html>index</a><li class=right><a title="Python Module Index"href=../../../py-modindex.html>modules</a> |<li class="nav-item nav-item-0"><a href=../../../index.html>moptipyapps 0.8.79 documentation</a> »<li class="nav-item nav-item-1"><a accesskey=U href=../../index.html>Module code</a> »<li class="nav-item nav-item-this"><a href>moptipyapps.prodsched.instance</a></ul></div><div class=document><div class=documentwrapper><div class=bodywrapper><div class=body role=main><h1>Source code for moptipyapps.prodsched.instance</h1><div class=highlight><pre>
<span></span><span class=sd>"""</span>
<span class=sd>A production scheduling instance.</span>

<span class=sd>Each production scheduling instance has a given :attr:`~Instance.name`.</span>
<span class=sd>It represents once concrete scenario of a material flow / factory production</span>
<span class=sd>scenario.</span>
<span class=sd>The factory has :attr:`~Instance.n_stations` work stations, e.g., machines</span>
<span class=sd>that perform a certain production step.</span>
<span class=sd>The factory also produces a set of :attr:`~Instance.n_products` different</span>
<span class=sd>products.</span>
<span class=sd>Each product passes through a set of work stations in a certain, pre-defined</span>
<span class=sd>order (and may even pass through the same machine multiple times).</span>
<span class=sd>The route each product takes is defined by the :attr:`~Instance.routes`</span>
<span class=sd>matrix.</span>
<span class=sd>Each product unit requires a certain time at each work station.</span>
<span class=sd>These times follow a certain random distribution.</span>

<span class=sd>Ther are customer demands (:class:`~Demand`) that appear in the system at</span>
<span class=sd>certain :attr:`~Demand.arrival` times. The demand is not known to the system</span>
<span class=sd>before its :attr:`~Demand.arrival` time, so we cannot really anticipate it.</span>
<span class=sd>However, when it arrives at the :attr:`~Demand.arrival` time, it has a certain</span>
<span class=sd>:attr:`~Demand.deadline` by which it should be completed. Normally, this is</span>
<span class=sd>the same as the :attr:`~Demand.arrival` time, but it could also be later in</span>
<span class=sd>some scenarios. Each demand has a unique :attr:`~Demand.demand_id` and is</span>
<span class=sd>issued by a certain customer with a certain :attr:`~Demand.customer_id`.</span>
<span class=sd>In many MFC scenarios, the customers do not matter.</span>
<span class=sd>What always matters is the :attr:`~Demand.product_id`, though, which</span>
<span class=sd>identifies the product that the customer ordered, as well as the</span>
<span class=sd>:attr:`~Demand.amount` of that product that the customer ordered (which is</span>
<span class=sd>normally 1, but could be an arbitary positive integer).</span>

<span class=sd>To summarize so far:</span>
<span class=sd>We have a factory that can produce :attr:`~Instance.n_products` different</span>
<span class=sd>products, which have IDs from `0` to `n_products-1`.</span>
<span class=sd>The factory uses :attr:`~Instance.n_stations` work stations (with IDs from</span>
<span class=sd>`0` to `n_stations-1`) for that purpose.</span>
<span class=sd>The :attr:`~Instance.routes` matrix defines which product is processed by</span>
<span class=sd>which work station and in which order.</span>
<span class=sd>The product with ID `i` passes through the work stations `routes[i]`, which</span>
<span class=sd>is tuple of work station IDs.</span>

<span class=sd>The :attr:`~Instance.n_customers` customers issue :attr:`~Instance.n_demands`</span>
<span class=sd>demands. Each demand has a unique ID :attr:`~Demand.demand_id` and appears in</span>
<span class=sd>the system at the :attr:`~Demand.arrival` time. It is for</span>
<span class=sd>:attr:`~Demand.amount` units of the product with</span>
<span class=sd>ID :attr:`~Demand.product_id`.</span>
<span class=sd>It should be satisfied until :attr:`~Demand.deadline`.</span>

<span class=sd>So the factory is producing the products with the goal to satisfy the demands</span>
<span class=sd>as soon as possible.</span>
<span class=sd>This leaves the last piece of the puzzle:</span>
<span class=sd>How long does it take to manufacture a unit of a given product?</span>
<span class=sd>This is regulated by the three-dimensional matrix</span>
<span class=sd>:attr:`~Instance.station_product_unit_times`.</span>
<span class=sd>If we want to produce one unit of a product with a given ID `p`, we can use</span>
<span class=sd>the :attr:`~Instance.routes` matrix (`routes[p]`) to determine through which</span>
<span class=sd>machines this unit needs to pass.</span>
<span class=sd>If it arrives at a machine with ID `m`, then we look up the</span>
<span class=sd>:class:`~numpy.ndarray` of prodcution slots and times under</span>
<span class=sd>`station_product_unit_times[m][p]`.</span>

<span class=sd>This array stores (flat) pairs of time window ends and unit production times.</span>
<span class=sd>The function :func:`~compute_finish_time` then tells us when the unit of the</span>
<span class=sd>production would be finished on this machine.</span>
<span class=sd>It would pass to the next machine prescribed in `routes[p]` until it has</span>
<span class=sd>passed all machines and is finished.</span>

<span class=sd>Notice that all the elements of an :class:`Instance` are **deterministic**.</span>
<span class=sd>The demands come in at specific, fixed times and are for fixed amounts of</span>
<span class=sd>fixed products.</span>
<span class=sd>They are stored in :attr:`~Instance.demands`.</span>
<span class=sd>Of course, any realistic simulation would only get to *see* them at their</span>
<span class=sd>:attr:`~Demand.arrival` times, but they are from a deterministic sequence</span>
<span class=sd>nonetheless.</span>
<span class=sd>Also, the production times are fixed and stored in the 3D array</span>
<span class=sd>:attr:`~Instance.station_product_unit_times`.</span>

<span class=sd>Even the initial amount :attr:`~Instance.warehous_at_t0` of products that is</span>
<span class=sd>available in the warehouse at time step 0 is fixed.</span>
<span class=sd>Each instance also prescribes a fixed warm-up time</span>
<span class=sd>:attr:`~Instance.time_end_warmup` (that must be ignored during the performance</span>
<span class=sd>metric computation) and end time :attr:`~Instance.time_end_measure` for the</span>
<span class=sd>simulation.</span>

<span class=sd>Everything is specified, deterministic, and fixed.</span>

<span class=sd>Of course, that being said, you can still generate instances randomly.</span>
<span class=sd>Indeed, in :mod:`~moptipyapps.prodsched.mfc_generator`, we do exactly that.</span>
<span class=sd>So you get the best of both worlds:</span>
<span class=sd>You can generate many different instances where work times and demands follow</span>
<span class=sd>the distributions of your liking.</span>
<span class=sd>And you can run fully-reproducible simulations (using the base class</span>
<span class=sd>:class:`~moptipyapps.prodsched.simulation.Simulation`).</span>

<span class=sd>Because if all events and times that would normally be "random" are hard-coded</span>
<span class=sd>in an :class:`~Instance`, then two simulations with the same "factory</span>
<span class=sd>operating system" will yield the exactly same behavior.</span>

<span class=sd>Instances can be converted to a text stream that you can store in a text file</span>
<span class=sd>by using the function :func:`to_stream`.</span>
<span class=sd>You can load them from a text stream using function :func:`from_stream`.</span>
<span class=sd>If you want to store multiple instances in a directory as text files, you can</span>
<span class=sd>use :func:`store_instances`.</span>
<span class=sd>To load a set of instances from a directory, you can use</span>
<span class=sd>:func:`load_instances`.</span>
<span class=sd>The class :class:`~moptipyapps.prodsched.simulation.Simulation` in module</span>
<span class=sd>:mod:`~moptipyapps.prodsched.simulation` offers the ability to run a fully</span>
<span class=sd>reproducible simulation based on an :class:`~Instance` and to pipe out events</span>
<span class=sd>and data via a :class:`~moptipyapps.prodsched.simulation.Listener` interface.</span>

<span class=sd>>>> name = "my_instance"</span>

<span class=sd>The number of products be 3.</span>

<span class=sd>>>> n_products = 3</span>

<span class=sd>The number of customers be 5.</span>

<span class=sd>>>> n_customers = 5</span>

<span class=sd>The number of stations be 4.</span>

<span class=sd>>>> n_stations = 4</span>

<span class=sd>There will be 6 customer demands.</span>

<span class=sd>>>> n_demands = 6</span>

<span class=sd>The end of the warmup period.</span>

<span class=sd>>>> time_end_warmup = 10</span>

<span class=sd>The end of the measurement period.</span>

<span class=sd>>>> time_end_measure = 10000</span>

<span class=sd>Each product may take a different route through different stations.</span>

<span class=sd>>>> route_p0 = [0, 3, 2]</span>
<span class=sd>>>> route_p1 = [0, 2, 1, 3]</span>
<span class=sd>>>> route_p2 = [1, 2, 3]</span>
<span class=sd>>>> routes = [route_p0, route_p1, route_p2]</span>

<span class=sd>Each demand is a tuple of demand_id, customer_id, product_id, amount,</span>
<span class=sd>release time, and deadline.</span>

<span class=sd>>>> d0 = [0, 0, 1, 20, 1240,  3000]</span>
<span class=sd>>>> d1 = [1, 1, 0, 10, 2300,  4000]</span>
<span class=sd>>>> d2 = [2, 2, 2,  7, 8300, 11000]</span>
<span class=sd>>>> d3 = [3, 3, 1, 12, 7300,  9000]</span>
<span class=sd>>>> d4 = [4, 4, 2, 23, 5410, 16720]</span>
<span class=sd>>>> d5 = [5, 3, 0, 19, 4234, 27080]</span>
<span class=sd>>>> demands = [d0, d1, d2, d3, d4, d5]</span>

<span class=sd>There is a fixed amount of each product in the warehouse at time step 0.</span>

<span class=sd>>>> warehous_at_t0 = [10, 0, 6]</span>

<span class=sd>Each station requires a certain working time for each unit of each product.</span>
<span class=sd>This production time may vary over time.</span>
<span class=sd>For example, maybe station 0 needs 10 time units for 1 unit of product 0 from</span>
<span class=sd>time step 0 to time step 19, then 11 time units from time step 20 to 39, then</span>
<span class=sd>8 time units from time step 40 to 59.</span>
<span class=sd>These times are cyclic, meaning that at time step 60 to 79, it will again need</span>
<span class=sd>10 time units, and so on.</span>
<span class=sd>Of course, production times are only specified for stations that a product is</span>
<span class=sd>actually routed through.</span>

<span class=sd>>>> m0_p0 = [10.0, 20.0, 11.0, 40.0,  8.0, 60.0]</span>
<span class=sd>>>> m0_p1 = [12.0, 20.0,  7.0, 40.0, 11.0, 70.0]</span>
<span class=sd>>>> m0_p2 = []</span>
<span class=sd>>>> m1_p0 = []</span>
<span class=sd>>>> m1_p1 = [20.0, 50.0, 30.0, 120.0,  7.0, 200.0]</span>
<span class=sd>>>> m1_p2 = [21.0, 50.0, 29.0, 130.0,  8.0, 190.0]</span>
<span class=sd>>>> m2_p0 = [ 8.0, 20.0,  9.0, 60.0]</span>
<span class=sd>>>> m2_p1 = [10.0, 90.0]</span>
<span class=sd>>>> m2_p2 = [12.0, 70.0,  30.0, 120.0]</span>
<span class=sd>>>> m3_p0 = [70.0, 200.0,  3.0, 220.0]</span>
<span class=sd>>>> m3_p1 = [60.0, 220.0,  5.0, 260.0]</span>
<span class=sd>>>> m3_p2 = [30.0, 210.0, 10.0, 300.0]</span>
<span class=sd>>>> station_product_unit_times = [[m0_p0, m0_p1, m0_p2],</span>
<span class=sd>...                               [m1_p0, m1_p1, m1_p2],</span>
<span class=sd>...                               [m2_p0, m2_p1, m2_p2],</span>
<span class=sd>...                               [m3_p0, m3_p1, m3_p2]]</span>

<span class=sd>We can (but do not need to) provide additional information as key-value pairs.</span>

<span class=sd>>>> infos = {"source": "manually created",</span>
<span class=sd>...          "creation_date": "2025-11-09"}</span>

<span class=sd>From all of this data, we can create the instance.</span>

<span class=sd>>>> instance = Instance(name, n_products, n_customers, n_stations, n_demands,</span>
<span class=sd>...                     time_end_warmup, time_end_measure,</span>
<span class=sd>...                     routes, demands, warehous_at_t0,</span>
<span class=sd>...                     station_product_unit_times, infos)</span>
<span class=sd>>>> instance.name</span>
<span class=sd>'my_instance'</span>

<span class=sd>>>> instance.n_customers</span>
<span class=sd>5</span>

<span class=sd>>>> instance.n_stations</span>
<span class=sd>4</span>

<span class=sd>>>> instance.n_demands</span>
<span class=sd>6</span>

<span class=sd>>>> instance.n_products</span>
<span class=sd>3</span>

<span class=sd>>>> instance.routes</span>
<span class=sd>((0, 3, 2), (0, 2, 1, 3), (1, 2, 3))</span>

<span class=sd>>>> instance.time_end_warmup</span>
<span class=sd>10.0</span>

<span class=sd>>>> instance.time_end_measure</span>
<span class=sd>10000.0</span>

<span class=sd>>>> instance.demands</span>
<span class=sd>(Demand(arrival=1240.0, deadline=3000.0, demand_id=0, customer_id=0,\</span>
<span class=sd> product_id=1, amount=20, measure=True),\</span>
<span class=sd> Demand(arrival=2300.0, deadline=4000.0, demand_id=1, customer_id=1,\</span>
<span class=sd> product_id=0, amount=10, measure=True),\</span>
<span class=sd> Demand(arrival=4234.0, deadline=27080.0, demand_id=5, customer_id=3,\</span>
<span class=sd> product_id=0, amount=19, measure=True),\</span>
<span class=sd> Demand(arrival=5410.0, deadline=16720.0, demand_id=4, customer_id=4,\</span>
<span class=sd> product_id=2, amount=23, measure=True),\</span>
<span class=sd> Demand(arrival=7300.0, deadline=9000.0, demand_id=3, customer_id=3,\</span>
<span class=sd> product_id=1, amount=12, measure=True),\</span>
<span class=sd> Demand(arrival=8300.0, deadline=11000.0, demand_id=2, customer_id=2,\</span>
<span class=sd> product_id=2, amount=7, measure=True))</span>

<span class=sd>>>> instance.warehous_at_t0</span>
<span class=sd>(10, 0, 6)</span>

<span class=sd>>>> instance.station_product_unit_times</span>
<span class=sd>((array([10., 20., 11., 40.,  8., 60.]), \</span>
<span class=sd>array([12., 20.,  7., 40., 11., 70.]), array([], dtype=float64)), (\</span>
<span class=sd>array([], dtype=float64), array([ 20.,  50.,  30., 120.,   7., 200.]), \</span>
<span class=sd>array([ 21.,  50.,  29., 130.,   8., 190.])), (array([ 8., 20.,  9., 60.]), \</span>
<span class=sd>array([10., 90.]), array([ 12.,  70.,  30., 120.])), (\</span>
<span class=sd>array([ 70., 200.,   3., 220.]), array([ 60., 220.,   5., 260.]), array(\</span>
<span class=sd>[ 30., 210.,  10., 300.])))</span>

<span class=sd>>>> instance.n_measurable_demands</span>
<span class=sd>6</span>

<span class=sd>>>> instance.n_measurable_demands_per_product</span>
<span class=sd>(2, 2, 2)</span>

<span class=sd>>>> dict(instance.infos)</span>
<span class=sd>{'source': 'manually created', 'creation_date': '2025-11-09'}</span>

<span class=sd>We can serialize instances to a stream of strings and also load them back</span>
<span class=sd>from a stream of strings.</span>
<span class=sd>Here, we store `instance` to a stream.</span>
<span class=sd>We then load the independent instance `i2` from that stream.</span>

<span class=sd>>>> i2 = from_stream(to_stream(instance))</span>
<span class=sd>>>> i2 is instance</span>
<span class=sd>False</span>
<span class=sd>>>> i2 == instance</span>
<span class=sd>True</span>

<span class=sd>You can see that the loaded instance has the same data as the stored one.</span>

<span class=sd>>>> i2.name == instance.name</span>
<span class=sd>True</span>
<span class=sd>>>> i2.n_customers == instance.n_customers</span>
<span class=sd>True</span>
<span class=sd>>>> i2.n_stations == instance.n_stations</span>
<span class=sd>True</span>
<span class=sd>>>> i2.n_demands == instance.n_demands</span>
<span class=sd>True</span>
<span class=sd>>>> i2.n_products == instance.n_products</span>
<span class=sd>True</span>
<span class=sd>>>> i2.routes == instance.routes</span>
<span class=sd>True</span>
<span class=sd>>>> i2.demands == instance.demands</span>
<span class=sd>True</span>
<span class=sd>>>> i2.time_end_warmup == instance.time_end_warmup</span>
<span class=sd>True</span>
<span class=sd>>>> i2.time_end_measure == instance.time_end_measure</span>
<span class=sd>True</span>
<span class=sd>>>> i2.warehous_at_t0 == instance.warehous_at_t0</span>
<span class=sd>True</span>
<span class=sd>>>> eq: bool = True</span>
<span class=sd>>>> for i in range(i2.n_stations):</span>
<span class=sd>...     ma1 = i2.station_product_unit_times[i]</span>
<span class=sd>...     ma2 = instance.station_product_unit_times[i]</span>
<span class=sd>...     for j in range(i2.n_products):</span>
<span class=sd>...         pr1 = ma1[j]</span>
<span class=sd>...         pr2 = ma2[j]</span>
<span class=sd>...         if not np.array_equal(pr1, pr2):</span>
<span class=sd>...             eq = False</span>
<span class=sd>>>> eq</span>
<span class=sd>True</span>

<span class=sd>True</span>
<span class=sd>>>> i2.infos == instance.infos</span>
<span class=sd>True</span>
<span class=sd>"""</span>

<span class=kn>from</span><span class=w> </span><span class=nn>dataclasses</span><span class=w> </span><span class=kn>import</span> <span class=n>dataclass</span>
<span class=kn>from</span><span class=w> </span><span class=nn>itertools</span><span class=w> </span><span class=kn>import</span> <span class=n>batched</span>
<span class=kn>from</span><span class=w> </span><span class=nn>math</span><span class=w> </span><span class=kn>import</span> <span class=n>ceil</span><span class=p>,</span> <span class=n>isfinite</span>
<span class=kn>from</span><span class=w> </span><span class=nn>string</span><span class=w> </span><span class=kn>import</span> <span class=n>ascii_letters</span><span class=p>,</span> <span class=n>digits</span>
<span class=kn>from</span><span class=w> </span><span class=nn>typing</span><span class=w> </span><span class=kn>import</span> <span class=p>(</span>
    <span class=n>Callable</span><span class=p>,</span>
    <span class=n>Final</span><span class=p>,</span>
    <span class=n>Generator</span><span class=p>,</span>
    <span class=n>Iterable</span><span class=p>,</span>
    <span class=n>Iterator</span><span class=p>,</span>
    <span class=n>Mapping</span><span class=p>,</span>
    <span class=n>cast</span><span class=p>,</span>
<span class=p>)</span>

<span class=kn>import</span><span class=w> </span><span class=nn>numba</span>  <span class=c1># type: ignore</span>
<span class=kn>import</span><span class=w> </span><span class=nn>numpy</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>np</span>
<span class=kn>from</span><span class=w> </span><span class=nn>moptipy.api.component</span><span class=w> </span><span class=kn>import</span> <span class=n>Component</span>
<span class=kn>from</span><span class=w> </span><span class=nn>moptipy.utils.logger</span><span class=w> </span><span class=kn>import</span> <span class=p>(</span>
    <span class=n>COMMENT_START</span><span class=p>,</span>
    <span class=n>KEY_VALUE_SEPARATOR</span><span class=p>,</span>
<span class=p>)</span>
<span class=kn>from</span><span class=w> </span><span class=nn>moptipy.utils.strings</span><span class=w> </span><span class=kn>import</span> <span class=n>sanitize_name</span>
<span class=kn>from</span><span class=w> </span><span class=nn>pycommons.ds.cache</span><span class=w> </span><span class=kn>import</span> <span class=n>repr_cache</span>
<span class=kn>from</span><span class=w> </span><span class=nn>pycommons.ds.immutable_map</span><span class=w> </span><span class=kn>import</span> <span class=n>immutable_mapping</span>
<span class=kn>from</span><span class=w> </span><span class=nn>pycommons.io.csv</span><span class=w> </span><span class=kn>import</span> <span class=n>CSV_SEPARATOR</span>
<span class=kn>from</span><span class=w> </span><span class=nn>pycommons.io.path</span><span class=w> </span><span class=kn>import</span> <span class=n>Path</span><span class=p>,</span> <span class=n>directory_path</span><span class=p>,</span> <span class=n>write_lines</span>
<span class=kn>from</span><span class=w> </span><span class=nn>pycommons.math.int_math</span><span class=w> </span><span class=kn>import</span> <span class=n>try_int</span>
<span class=kn>from</span><span class=w> </span><span class=nn>pycommons.strings.string_conv</span><span class=w> </span><span class=kn>import</span> <span class=n>bool_to_str</span><span class=p>,</span> <span class=n>float_to_str</span><span class=p>,</span> <span class=n>num_to_str</span>
<span class=kn>from</span><span class=w> </span><span class=nn>pycommons.types</span><span class=w> </span><span class=kn>import</span> <span class=n>check_int_range</span><span class=p>,</span> <span class=n>check_to_int_range</span><span class=p>,</span> <span class=n>type_error</span>

<span class=c1>#: The maximum for the number of stations, products, or customers.</span>
<span class=n>MAX_ID</span><span class=p>:</span> <span class=n>Final</span><span class=p>[</span><span class=nb>int</span><span class=p>]</span> <span class=o>=</span> <span class=mi>1_000_000_000</span>

<span class=c1>#: No value bigger than this is permitted in any tuple anywhere.</span>
<span class=n>MAX_VALUE</span><span class=p>:</span> <span class=n>Final</span><span class=p>[</span><span class=nb>int</span><span class=p>]</span> <span class=o>=</span> <span class=mi>2_147_483_647</span>

<span class=c1>#: the index of the demand ID</span>
<span class=n>DEMAND_ID</span><span class=p>:</span> <span class=n>Final</span><span class=p>[</span><span class=nb>int</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span>
<span class=c1>#: the index of the customer ID</span>
<span class=n>DEMAND_CUSTOMER</span><span class=p>:</span> <span class=n>Final</span><span class=p>[</span><span class=nb>int</span><span class=p>]</span> <span class=o>=</span> <span class=mi>1</span>
<span class=c1>#: the index of the product ID</span>
<span class=n>DEMAND_PRODUCT</span><span class=p>:</span> <span class=n>Final</span><span class=p>[</span><span class=nb>int</span><span class=p>]</span> <span class=o>=</span> <span class=mi>2</span>
<span class=c1>#: the index of the demanded amount</span>
<span class=n>DEMAND_AMOUNT</span><span class=p>:</span> <span class=n>Final</span><span class=p>[</span><span class=nb>int</span><span class=p>]</span> <span class=o>=</span> <span class=mi>3</span>
<span class=c1>#: the index of the demand release time</span>
<span class=n>DEMAND_ARRIVAL</span><span class=p>:</span> <span class=n>Final</span><span class=p>[</span><span class=nb>int</span><span class=p>]</span> <span class=o>=</span> <span class=mi>4</span>
<span class=c1>#: the index of the demand deadline</span>
<span class=n>DEMAND_DEADLINE</span><span class=p>:</span> <span class=n>Final</span><span class=p>[</span><span class=nb>int</span><span class=p>]</span> <span class=o>=</span> <span class=mi>5</span>


<div class=viewcode-block id=Demand>
<a class=viewcode-back href=../../../moptipyapps.prodsched.html#moptipyapps.prodsched.instance.Demand>[docs]</a>
<span class=nd>@dataclass</span><span class=p>(</span><span class=n>order</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>frozen</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
<span class=k>class</span><span class=w> </span><span class=nc>Demand</span><span class=p>(</span><span class=n>Iterable</span><span class=p>[</span><span class=nb>int</span> <span class=o>|</span> <span class=nb>float</span><span class=p>]):</span>
<span class=w>    </span><span class=sd>"""</span>
<span class=sd>    The record for demands.</span>

<span class=sd>    Each demand has an :attr:`~Demand.arrival` time at which point it enters</span>
<span class=sd>    the system. It has a unique :attr:`~Demand.demand_id`. It has a</span>
<span class=sd>    :attr:`~Demand.deadline`, at which point the customer</span>
<span class=sd>    :attr:`~Demand.customer_id` who issued the demand expects to receive the</span>
<span class=sd>    :attr:`~Demand.amount` units of the product :attr:`~Demand.product_id`</span>
<span class=sd>    that they ordered.</span>

<span class=sd>    Demands with the :attr:`~Demand.measure` flag set fall into the simulation</span>
<span class=sd>    time window where performance metrics are gathered. Demands where</span>
<span class=sd>    :attr:`~Demand.measure` is `False` will be irgnored during the performance</span>
<span class=sd>    evaluation, because they fall into the setup time. Their processing must</span>
<span class=sd>    still be simulated, though.</span>

<span class=sd>    >>> Demand(arrival=0.6, deadline=0.8, demand_id=1,</span>
<span class=sd>    ...        customer_id=2, product_id=6, amount=12, measure=True)</span>
<span class=sd>    Demand(arrival=0.6, deadline=0.8, demand_id=1, customer_id=2,\</span>
<span class=sd> product_id=6, amount=12, measure=True)</span>
<span class=sd>    >>> Demand(arrival=16, deadline=28, demand_id=1,</span>
<span class=sd>    ...        customer_id=2, product_id=6, amount=12, measure=False)</span>
<span class=sd>    Demand(arrival=16.0, deadline=28.0, demand_id=1, customer_id=2,\</span>
<span class=sd> product_id=6, amount=12, measure=False)</span>
<span class=sd>    """</span>

    <span class=c1>#: the arrival time, i.e., when the demand enters the system</span>
    <span class=n>arrival</span><span class=p>:</span> <span class=nb>float</span>
    <span class=c1>#: the deadline, i.e., when the customer expects the result</span>
    <span class=n>deadline</span><span class=p>:</span> <span class=nb>float</span>
    <span class=c1>#: the ID of the demand</span>
    <span class=n>demand_id</span><span class=p>:</span> <span class=nb>int</span>
    <span class=c1>#: the customer ID</span>
    <span class=n>customer_id</span><span class=p>:</span> <span class=nb>int</span>
    <span class=c1>#: the ID of the product</span>
    <span class=n>product_id</span><span class=p>:</span> <span class=nb>int</span>
    <span class=c1>#: the amount</span>
    <span class=n>amount</span><span class=p>:</span> <span class=nb>int</span>
    <span class=c1>#: is this demand measurement relevant?</span>
    <span class=n>measure</span><span class=p>:</span> <span class=nb>bool</span>

    <span class=k>def</span><span class=w> </span><span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>arrival</span><span class=p>:</span> <span class=nb>int</span> <span class=o>|</span> <span class=nb>float</span><span class=p>,</span>
                 <span class=n>deadline</span><span class=p>:</span> <span class=nb>int</span> <span class=o>|</span> <span class=nb>float</span><span class=p>,</span> <span class=n>demand_id</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span>
                 <span class=n>customer_id</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>product_id</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>amount</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span>
                 <span class=n>measure</span><span class=p>:</span> <span class=nb>bool</span><span class=p>)</span> <span class=o>-></span> <span class=kc>None</span><span class=p>:</span>
<span class=w>        </span><span class=sd>"""</span>
<span class=sd>        Initialize the record.</span>

<span class=sd>        :param arrival: the arrival time</span>
<span class=sd>        :param deadline: the deadline</span>
<span class=sd>        :param demand_id: the demand id</span>
<span class=sd>        :param customer_id: the customer id</span>
<span class=sd>        :param product_id: the product id</span>
<span class=sd>        :param amount: the amount</span>
<span class=sd>        :param measure: is this demand relevant for measurement?</span>
<span class=sd>        """</span>
        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>arrival</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
            <span class=n>t</span><span class=p>:</span> <span class=nb>float</span> <span class=o>=</span> <span class=nb>float</span><span class=p>(</span><span class=n>arrival</span><span class=p>)</span>
            <span class=k>if</span> <span class=n>t</span> <span class=o>!=</span> <span class=n>arrival</span><span class=p>:</span>
                <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=sa>f</span><span class=s2>"invalid arrival time </span><span class=si>{</span><span class=n>arrival</span><span class=si>}</span><span class=s2>"</span><span class=p>)</span>
            <span class=n>arrival</span> <span class=o>=</span> <span class=n>t</span>
        <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>arrival</span><span class=p>,</span> <span class=nb>float</span><span class=p>):</span>
            <span class=k>raise</span> <span class=n>type_error</span><span class=p>(</span><span class=n>arrival</span><span class=p>,</span> <span class=s2>"arrival"</span><span class=p>,</span> <span class=nb>float</span><span class=p>)</span>
        <span class=k>if</span> <span class=ow>not</span> <span class=p>(</span><span class=n>isfinite</span><span class=p>(</span><span class=n>arrival</span><span class=p>)</span> <span class=ow>and</span> <span class=p>(</span>
                <span class=mi>0</span> <span class=o><</span> <span class=n>arrival</span> <span class=o><</span> <span class=n>MAX_VALUE</span><span class=p>)):</span>
            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=sa>f</span><span class=s2>"invalid arrival=</span><span class=si>{</span><span class=n>arrival</span><span class=si>}</span><span class=s2>"</span><span class=p>)</span>

        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>deadline</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
            <span class=n>t</span> <span class=o>=</span> <span class=nb>float</span><span class=p>(</span><span class=n>deadline</span><span class=p>)</span>
            <span class=k>if</span> <span class=n>t</span> <span class=o>!=</span> <span class=n>deadline</span><span class=p>:</span>
                <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=sa>f</span><span class=s2>"invalid deadline time </span><span class=si>{</span><span class=n>deadline</span><span class=si>}</span><span class=s2>"</span><span class=p>)</span>
            <span class=n>deadline</span> <span class=o>=</span> <span class=n>t</span>
        <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>deadline</span><span class=p>,</span> <span class=nb>float</span><span class=p>):</span>
            <span class=k>raise</span> <span class=n>type_error</span><span class=p>(</span><span class=n>deadline</span><span class=p>,</span> <span class=s2>"deadline"</span><span class=p>,</span> <span class=nb>float</span><span class=p>)</span>
        <span class=k>if</span> <span class=ow>not</span> <span class=p>(</span><span class=n>isfinite</span><span class=p>(</span><span class=n>deadline</span><span class=p>)</span> <span class=ow>and</span> <span class=p>(</span><span class=mi>0</span> <span class=o><</span> <span class=n>deadline</span> <span class=o><</span> <span class=n>MAX_VALUE</span><span class=p>)):</span>
            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=sa>f</span><span class=s2>"invalid deadline=</span><span class=si>{</span><span class=n>deadline</span><span class=si>}</span><span class=s2>"</span><span class=p>)</span>

        <span class=k>if</span> <span class=n>deadline</span> <span class=o><</span> <span class=n>arrival</span><span class=p>:</span>
            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span>
                <span class=sa>f</span><span class=s2>"arrival=</span><span class=si>{</span><span class=n>arrival</span><span class=si>}</span><span class=s2> and deadline=</span><span class=si>{</span><span class=n>deadline</span><span class=si>}</span><span class=s2>"</span><span class=p>)</span>
        <span class=nb>object</span><span class=o>.</span><span class=fm>__setattr__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=s2>"arrival"</span><span class=p>,</span> <span class=n>arrival</span><span class=p>)</span>
        <span class=nb>object</span><span class=o>.</span><span class=fm>__setattr__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=s2>"deadline"</span><span class=p>,</span> <span class=n>deadline</span><span class=p>)</span>
        <span class=nb>object</span><span class=o>.</span><span class=fm>__setattr__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=s2>"demand_id"</span><span class=p>,</span> <span class=n>check_int_range</span><span class=p>(</span>
            <span class=n>demand_id</span><span class=p>,</span> <span class=s2>"demand_id"</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>MAX_ID</span><span class=p>))</span>
        <span class=nb>object</span><span class=o>.</span><span class=fm>__setattr__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=s2>"customer_id"</span><span class=p>,</span> <span class=n>check_int_range</span><span class=p>(</span>
            <span class=n>customer_id</span><span class=p>,</span> <span class=s2>"customer_id"</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>MAX_ID</span><span class=p>))</span>
        <span class=nb>object</span><span class=o>.</span><span class=fm>__setattr__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=s2>"product_id"</span><span class=p>,</span> <span class=n>check_int_range</span><span class=p>(</span>
            <span class=n>product_id</span><span class=p>,</span> <span class=s2>"product_id"</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>MAX_ID</span><span class=p>))</span>
        <span class=nb>object</span><span class=o>.</span><span class=fm>__setattr__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=s2>"amount"</span><span class=p>,</span> <span class=n>check_int_range</span><span class=p>(</span>
            <span class=n>amount</span><span class=p>,</span> <span class=s2>"amount"</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=n>MAX_ID</span><span class=p>))</span>
        <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>measure</span><span class=p>,</span> <span class=nb>bool</span><span class=p>):</span>
            <span class=k>raise</span> <span class=n>type_error</span><span class=p>(</span><span class=n>measure</span><span class=p>,</span> <span class=s2>"measure"</span><span class=p>,</span> <span class=nb>bool</span><span class=p>)</span>
        <span class=nb>object</span><span class=o>.</span><span class=fm>__setattr__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=s2>"measure"</span><span class=p>,</span> <span class=n>measure</span><span class=p>)</span>

    <span class=k>def</span><span class=w> </span><span class=fm>__str__</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-></span> <span class=nb>str</span><span class=p>:</span>
<span class=w>        </span><span class=sd>"""</span>
<span class=sd>        Get a short string representation of the demand.</span>

<span class=sd>        :return: the string representation</span>

<span class=sd>        >>> str(Demand(arrival=16, deadline=28.0, demand_id=1,</span>
<span class=sd>        ...     customer_id=2, product_id=6, amount=12, measure=False))</span>
<span class=sd>        'd(id: 1, p: 6, c: 2, am: 12, ar: 16, dl: 28, me: F)'</span>
<span class=sd>        """</span>
        <span class=n>fts</span><span class=p>:</span> <span class=n>Final</span><span class=p>[</span><span class=n>Callable</span><span class=p>]</span> <span class=o>=</span> <span class=n>float_to_str</span>
        <span class=k>return</span> <span class=p>(</span><span class=sa>f</span><span class=s2>"d(id: </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>demand_id</span><span class=si>}</span><span class=s2>, p: </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>product_id</span><span class=si>}</span><span class=s2>, "</span>
                <span class=sa>f</span><span class=s2>"c: </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>customer_id</span><span class=si>}</span><span class=s2>, am: </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>amount</span><span class=si>}</span><span class=s2>, "</span>
                <span class=sa>f</span><span class=s2>"ar: </span><span class=si>{</span><span class=n>fts</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>arrival</span><span class=p>)</span><span class=si>}</span><span class=s2>, dl: </span><span class=si>{</span><span class=n>fts</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>deadline</span><span class=p>)</span><span class=si>}</span><span class=s2>, "</span>
                <span class=sa>f</span><span class=s2>"me: </span><span class=si>{</span><span class=n>bool_to_str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>measure</span><span class=p>)</span><span class=si>}</span><span class=s2>)"</span><span class=p>)</span>

    <span class=k>def</span><span class=w> </span><span class=fm>__getitem__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>item</span><span class=p>:</span> <span class=nb>int</span><span class=p>)</span> <span class=o>-></span> <span class=nb>int</span> <span class=o>|</span> <span class=nb>float</span><span class=p>:</span>
<span class=w>        </span><span class=sd>"""</span>
<span class=sd>        Access an element of this demand via an index.</span>

<span class=sd>        :param item: the index</span>
<span class=sd>        :return: the demand value at that index</span>

<span class=sd>        >>> d = Demand(arrival=16, deadline=28, demand_id=1,</span>
<span class=sd>        ...        customer_id=2, product_id=6, amount=12, measure=True)</span>
<span class=sd>        >>> d[0]</span>
<span class=sd>        1</span>
<span class=sd>        >>> d[1]</span>
<span class=sd>        2</span>
<span class=sd>        >>> d[2]</span>
<span class=sd>        6</span>
<span class=sd>        >>> d[3]</span>
<span class=sd>        12</span>
<span class=sd>        >>> d[4]</span>
<span class=sd>        16</span>
<span class=sd>        >>> d[5]</span>
<span class=sd>        28</span>
<span class=sd>        """</span>
        <span class=k>if</span> <span class=n>item</span> <span class=o>==</span> <span class=n>DEMAND_ID</span><span class=p>:</span>
            <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>demand_id</span>
        <span class=k>if</span> <span class=n>item</span> <span class=o>==</span> <span class=n>DEMAND_CUSTOMER</span><span class=p>:</span>
            <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>customer_id</span>
        <span class=k>if</span> <span class=n>item</span> <span class=o>==</span> <span class=n>DEMAND_PRODUCT</span><span class=p>:</span>
            <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>product_id</span>
        <span class=k>if</span> <span class=n>item</span> <span class=o>==</span> <span class=n>DEMAND_AMOUNT</span><span class=p>:</span>
            <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>amount</span>
        <span class=k>if</span> <span class=n>item</span> <span class=o>==</span> <span class=n>DEMAND_ARRIVAL</span><span class=p>:</span>
            <span class=k>return</span> <span class=n>try_int</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>arrival</span><span class=p>)</span>
        <span class=k>if</span> <span class=n>item</span> <span class=o>==</span> <span class=n>DEMAND_DEADLINE</span><span class=p>:</span>
            <span class=k>return</span> <span class=n>try_int</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>deadline</span><span class=p>)</span>
        <span class=k>raise</span> <span class=ne>IndexError</span><span class=p>(</span>
            <span class=sa>f</span><span class=s2>"index </span><span class=si>{</span><span class=n>item</span><span class=si>}</span><span class=s2> out of bounds [0,</span><span class=si>{</span><span class=n>DEMAND_DEADLINE</span><span class=si>}</span><span class=s2>]."</span><span class=p>)</span>

    <span class=k>def</span><span class=w> </span><span class=fm>__iter__</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-></span> <span class=n>Iterator</span><span class=p>[</span><span class=nb>int</span> <span class=o>|</span> <span class=nb>float</span><span class=p>]:</span>
<span class=w>        </span><span class=sd>"""</span>
<span class=sd>        Iterate over the values in this demand.</span>

<span class=sd>        :return: the demand iterable</span>

<span class=sd>        >>> d = Demand(arrival=16, deadline=28, demand_id=1,</span>
<span class=sd>        ...        customer_id=2, product_id=6, amount=12, measure=True)</span>
<span class=sd>        >>> list(d)</span>
<span class=sd>        [1, 2, 6, 12, 16, 28]</span>
<span class=sd>        """</span>
        <span class=k>yield</span> <span class=bp>self</span><span class=o>.</span><span class=n>demand_id</span>  <span class=c1># DEMAND_ID</span>
        <span class=k>yield</span> <span class=bp>self</span><span class=o>.</span><span class=n>customer_id</span>  <span class=c1># DEMAND_CUSTOMER</span>
        <span class=k>yield</span> <span class=bp>self</span><span class=o>.</span><span class=n>product_id</span>  <span class=c1># DEMAND_PRODUCT:</span>
        <span class=k>yield</span> <span class=bp>self</span><span class=o>.</span><span class=n>amount</span>  <span class=c1># DEMAND_AMOUNT:</span>
        <span class=k>yield</span> <span class=n>try_int</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>arrival</span><span class=p>)</span>  <span class=c1># DEMAND_ARRIVAL</span>
        <span class=k>yield</span> <span class=n>try_int</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>deadline</span><span class=p>)</span>  <span class=c1># DEMAND_DEADLINE</span>

    <span class=k>def</span><span class=w> </span><span class=fm>__len__</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-></span> <span class=nb>int</span><span class=p>:</span>
<span class=w>        </span><span class=sd>"""</span>
<span class=sd>        Get the length of the demand record.</span>

<span class=sd>        :returns `6`: always</span>

<span class=sd>        >>> len(Demand(arrival=16, deadline=28, demand_id=1,</span>
<span class=sd>        ...        customer_id=2, product_id=6, amount=12, measure=True))</span>
<span class=sd>        6</span>
<span class=sd>        """</span>
        <span class=k>return</span> <span class=mi>6</span></div>



<span class=k>def</span><span class=w> </span><span class=nf>__to_tuple</span><span class=p>(</span><span class=n>source</span><span class=p>:</span> <span class=n>Iterable</span><span class=p>[</span><span class=nb>int</span> <span class=o>|</span> <span class=nb>float</span><span class=p>],</span>
               <span class=n>cache</span><span class=p>:</span> <span class=n>Callable</span><span class=p>,</span> <span class=n>empty_ok</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>False</span><span class=p>,</span>
               <span class=n>type_var</span><span class=p>:</span> <span class=nb>type</span> <span class=o>=</span> <span class=nb>int</span><span class=p>)</span> <span class=o>-></span> <span class=nb>tuple</span><span class=p>:</span>
<span class=w>    </span><span class=sd>"""</span>
<span class=sd>    Convert an iterable to a tuple with values of a given type.</span>

<span class=sd>    :param source: the data source</span>
<span class=sd>    :param cache: the cache</span>
<span class=sd>    :param empty_ok: are empty tuples OK?</span>
<span class=sd>    :param type_var: the type variable</span>
<span class=sd>    :return: the tuple</span>

<span class=sd>    >>> ppl = repr_cache()</span>
<span class=sd>    >>> k1 = __to_tuple([1, 2, 3], ppl)</span>
<span class=sd>    >>> print(k1)</span>
<span class=sd>    (1, 2, 3)</span>

<span class=sd>    >>> __to_tuple({2}, ppl)</span>
<span class=sd>    (2,)</span>

<span class=sd>    >>> k2 = __to_tuple([1, 2, 3], ppl)</span>
<span class=sd>    >>> print(k2)</span>
<span class=sd>    (1, 2, 3)</span>
<span class=sd>    >>> k1 is k2</span>
<span class=sd>    True</span>

<span class=sd>    >>> k3 = __to_tuple([3.4, 2.3, 3.1], ppl, type_var=float)</span>
<span class=sd>    >>> print(k3)</span>
<span class=sd>    (3.4, 2.3, 3.1)</span>
<span class=sd>    >>> k1 is k3</span>
<span class=sd>    False</span>

<span class=sd>    >>> k4 = __to_tuple([3.4, 2.3, 3.1], ppl, type_var=float)</span>
<span class=sd>    >>> print(k4)</span>
<span class=sd>    (3.4, 2.3, 3.1)</span>
<span class=sd>    >>> k3 is k4</span>
<span class=sd>    True</span>

<span class=sd>    >>> try:</span>
<span class=sd>    ...     __to_tuple([], ppl)</span>
<span class=sd>    ... except Exception as e:</span>
<span class=sd>    ...     print(e)</span>
<span class=sd>    row has length 0.</span>

<span class=sd>    >>> __to_tuple([], ppl, empty_ok=True)</span>
<span class=sd>    ()</span>

<span class=sd>    >>> try:</span>
<span class=sd>    ...     __to_tuple([1, 2.0], ppl)</span>
<span class=sd>    ... except Exception as e:</span>
<span class=sd>    ...     print(e)</span>
<span class=sd>    row[1] should be an instance of int but is float, namely 2.0.</span>

<span class=sd>    >>> try:</span>
<span class=sd>    ...     __to_tuple([1.1, 2.0, 4, 3.4], ppl, type_var=float)</span>
<span class=sd>    ... except Exception as e:</span>
<span class=sd>    ...     print(e)</span>
<span class=sd>    row[2] should be an instance of float but is int, namely 4.</span>
<span class=sd>    """</span>
    <span class=n>use_row</span> <span class=o>=</span> <span class=n>source</span> <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>source</span><span class=p>,</span> <span class=nb>tuple</span><span class=p>)</span> <span class=k>else</span> <span class=nb>tuple</span><span class=p>(</span><span class=n>source</span><span class=p>)</span>
    <span class=k>if</span> <span class=p>(</span><span class=nb>tuple</span><span class=o>.</span><span class=fm>__len__</span><span class=p>(</span><span class=n>use_row</span><span class=p>)</span> <span class=o><=</span> <span class=mi>0</span><span class=p>)</span> <span class=ow>and</span> <span class=p>(</span><span class=ow>not</span> <span class=n>empty_ok</span><span class=p>):</span>
        <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>"row has length 0."</span><span class=p>)</span>
    <span class=k>for</span> <span class=n>j</span><span class=p>,</span> <span class=n>v</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>use_row</span><span class=p>):</span>
        <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>v</span><span class=p>,</span> <span class=n>type_var</span><span class=p>):</span>
            <span class=k>raise</span> <span class=n>type_error</span><span class=p>(</span><span class=n>v</span><span class=p>,</span> <span class=sa>f</span><span class=s2>"row[</span><span class=si>{</span><span class=n>j</span><span class=si>}</span><span class=s2>]"</span><span class=p>,</span> <span class=n>type_var</span><span class=p>)</span>
        <span class=k>if</span> <span class=ow>not</span> <span class=p>(</span><span class=n>isfinite</span><span class=p>(</span><span class=n>v</span><span class=p>)</span> <span class=ow>and</span> <span class=p>(</span><span class=mi>0</span> <span class=o><=</span> <span class=n>v</span> <span class=o><=</span> <span class=n>MAX_VALUE</span><span class=p>)):</span>  <span class=c1># type: ignore</span>
            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=sa>f</span><span class=s2>"row[</span><span class=si>{</span><span class=n>j</span><span class=si>}</span><span class=s2>]=</span><span class=si>{</span><span class=n>v</span><span class=si>}</span><span class=s2> not in 0..</span><span class=si>{</span><span class=n>MAX_VALUE</span><span class=si>}</span><span class=s2>"</span><span class=p>)</span>

    <span class=k>return</span> <span class=n>cache</span><span class=p>(</span><span class=n>use_row</span><span class=p>)</span>


<span class=k>def</span><span class=w> </span><span class=nf>__to_npfloats</span><span class=p>(</span><span class=n>source</span><span class=p>:</span> <span class=n>Iterable</span><span class=p>[</span><span class=nb>int</span> <span class=o>|</span> <span class=nb>float</span><span class=p>],</span>  <span class=c1># pylint: disable=W1113</span>
                  <span class=n>cache</span><span class=p>:</span> <span class=n>Callable</span><span class=p>,</span> <span class=n>empty_ok</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>False</span><span class=p>,</span>
                  <span class=o>*</span><span class=n>_</span><span class=p>)</span> <span class=o>-></span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>:</span>  <span class=c1># pylint: disable=W1113</span>
<span class=w>    </span><span class=sd>"""</span>
<span class=sd>    Convert to numpy floats.</span>

<span class=sd>    :param source: the source data</span>
<span class=sd>    :param cache: the cache</span>
<span class=sd>    :param empty_ok: are empty arrays OK?</span>
<span class=sd>    :return: the arrays</span>

<span class=sd>    >>> ppl = repr_cache()</span>
<span class=sd>    >>> a = __to_npfloats([3.4, 2.3, 3.1], ppl)</span>
<span class=sd>    >>> a</span>
<span class=sd>    array([3.4, 2.3, 3.1])</span>
<span class=sd>    >>> b = __to_npfloats([3.4, 2.3, 3.1], ppl)</span>
<span class=sd>    >>> b is a</span>
<span class=sd>    True</span>

<span class=sd>    >>> c = __to_npfloats([], ppl, empty_ok=True)</span>
<span class=sd>    >>> c</span>
<span class=sd>    array([], dtype=float64)</span>

<span class=sd>    >>> d = __to_npfloats([], ppl, empty_ok=True)</span>
<span class=sd>    >>> d is c</span>
<span class=sd>    True</span>
<span class=sd>    """</span>
    <span class=k>return</span> <span class=n>cache</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>(</span><span class=n>__to_tuple</span><span class=p>(</span>
        <span class=n>source</span><span class=p>,</span> <span class=n>cache</span><span class=p>,</span> <span class=n>empty_ok</span><span class=p>,</span> <span class=nb>float</span><span class=p>),</span> <span class=n>np</span><span class=o>.</span><span class=n>float64</span><span class=p>))</span>


<span class=k>def</span><span class=w> </span><span class=nf>__to_nested_tuples</span><span class=p>(</span><span class=n>source</span><span class=p>:</span> <span class=n>Iterable</span><span class=p>,</span>
                       <span class=n>cache</span><span class=p>:</span> <span class=n>Callable</span><span class=p>,</span> <span class=n>empty_ok</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>False</span><span class=p>,</span>
                       <span class=n>type_var</span><span class=p>:</span> <span class=nb>type</span> <span class=o>=</span> <span class=nb>int</span><span class=p>,</span>
                       <span class=n>inner</span><span class=p>:</span> <span class=n>Callable</span> <span class=o>=</span> <span class=n>__to_tuple</span><span class=p>)</span> <span class=o>-></span> <span class=nb>tuple</span><span class=p>:</span>
<span class=w>    </span><span class=sd>"""</span>
<span class=sd>    Turn nested iterables of ints into nested tuples.</span>

<span class=sd>    :param source: the source list</span>
<span class=sd>    :param cache: the cache</span>
<span class=sd>    :param empty_ok: are empty tuples OK?</span>
<span class=sd>    :param type_var: the type variable</span>
<span class=sd>    :param inner: the inner function</span>
<span class=sd>    :return: the tuple or array</span>

<span class=sd>    >>> ppl = repr_cache()</span>
<span class=sd>    >>> k1 = __to_nested_tuples([(1, 2), [3, 2]], ppl)</span>
<span class=sd>    >>> print(k1)</span>
<span class=sd>    ((1, 2), (3, 2))</span>

<span class=sd>    >>> k2 = __to_nested_tuples([(1, 2), (1, 2, 4),  (1, 2)], ppl)</span>
<span class=sd>    >>> print(k2)</span>
<span class=sd>    ((1, 2), (1, 2, 4), (1, 2))</span>

<span class=sd>    >>> k2[0] is k2[2]</span>
<span class=sd>    True</span>

<span class=sd>    >>> k1[0] is k2[0]</span>
<span class=sd>    True</span>
<span class=sd>    >>> k1[0] is k2[2]</span>
<span class=sd>    True</span>

<span class=sd>    >>> __to_nested_tuples([(1, 2), (1, 2, 4),  (1, 2), []], ppl, True)</span>
<span class=sd>    ((1, 2), (1, 2, 4), (1, 2), ())</span>

<span class=sd>    >>> __to_nested_tuples([(), {}, []], ppl, True)</span>
<span class=sd>    ()</span>

<span class=sd>    >>> __to_nested_tuples([(1.0, 2.4), (1.0, 2.2)], ppl, True, float)</span>
<span class=sd>    ((1.0, 2.4), (1.0, 2.2))</span>
<span class=sd>    """</span>
    <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>source</span><span class=p>,</span> <span class=n>Iterable</span><span class=p>):</span>
        <span class=k>raise</span> <span class=n>type_error</span><span class=p>(</span><span class=n>source</span><span class=p>,</span> <span class=s2>"source"</span><span class=p>,</span> <span class=n>Iterable</span><span class=p>)</span>
    <span class=n>dest</span><span class=p>:</span> <span class=nb>list</span> <span class=o>=</span> <span class=p>[]</span>
    <span class=n>ins</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>0</span>
    <span class=k>for</span> <span class=n>row</span> <span class=ow>in</span> <span class=n>source</span><span class=p>:</span>
        <span class=n>use_row</span> <span class=o>=</span> <span class=n>inner</span><span class=p>(</span><span class=n>row</span><span class=p>,</span> <span class=n>cache</span><span class=p>,</span> <span class=n>empty_ok</span><span class=p>,</span> <span class=n>type_var</span><span class=p>)</span>
        <span class=n>ins</span> <span class=o>+=</span> <span class=nb>len</span><span class=p>(</span><span class=n>use_row</span><span class=p>)</span>
        <span class=n>dest</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>use_row</span><span class=p>)</span>

    <span class=k>if</span> <span class=p>(</span><span class=n>ins</span> <span class=o><=</span> <span class=mi>0</span><span class=p>)</span> <span class=ow>and</span> <span class=n>empty_ok</span><span class=p>:</span>  <span class=c1># if all inner tuples are empty,</span>
        <span class=n>dest</span><span class=o>.</span><span class=n>clear</span><span class=p>()</span>             <span class=c1># clear the tuple source</span>

    <span class=n>n_rows</span><span class=p>:</span> <span class=n>Final</span><span class=p>[</span><span class=nb>int</span><span class=p>]</span> <span class=o>=</span> <span class=nb>list</span><span class=o>.</span><span class=fm>__len__</span><span class=p>(</span><span class=n>dest</span><span class=p>)</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>n_rows</span> <span class=o><=</span> <span class=mi>0</span><span class=p>)</span> <span class=ow>and</span> <span class=p>(</span><span class=ow>not</span> <span class=n>empty_ok</span><span class=p>):</span>
        <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>"Got empty set of rows!"</span><span class=p>)</span>

    <span class=k>return</span> <span class=n>cache</span><span class=p>(</span><span class=nb>tuple</span><span class=p>(</span><span class=n>dest</span><span class=p>))</span>


<span class=k>def</span><span class=w> </span><span class=nf>__to_tuples</span><span class=p>(</span><span class=n>source</span><span class=p>:</span> <span class=n>Iterable</span><span class=p>[</span><span class=n>Iterable</span><span class=p>],</span>
                <span class=n>cache</span><span class=p>:</span> <span class=n>Callable</span><span class=p>,</span> <span class=n>empty_ok</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>False</span><span class=p>,</span> <span class=n>type_var</span><span class=o>=</span><span class=nb>int</span><span class=p>,</span>
                <span class=n>inner</span><span class=p>:</span> <span class=n>Callable</span> <span class=o>=</span> <span class=n>__to_tuple</span><span class=p>)</span> \
        <span class=o>-></span> <span class=nb>tuple</span><span class=p>[</span><span class=nb>tuple</span><span class=p>,</span> <span class=o>...</span><span class=p>]:</span>
<span class=w>    </span><span class=sd>"""</span>
<span class=sd>    Turn 2D nested iterables into 2D nested tuples.</span>

<span class=sd>    :param source: the source</span>
<span class=sd>    :param cache: the cache</span>
<span class=sd>    :param empty_ok: are empty tuples OK?</span>
<span class=sd>    :param type_var: the type variable</span>
<span class=sd>    :param inner: the inner callable</span>
<span class=sd>    :return: the nested tuples</span>

<span class=sd>    >>> ppl = repr_cache()</span>
<span class=sd>    >>> k1 = __to_tuples([(1, 2), [3, 2]], ppl)</span>
<span class=sd>    >>> print(k1)</span>
<span class=sd>    ((1, 2), (3, 2))</span>

<span class=sd>    >>> k2 = __to_tuples([(1, 2), (1, 2, 4),  (1, 2)], ppl)</span>
<span class=sd>    >>> print(k2)</span>
<span class=sd>    ((1, 2), (1, 2, 4), (1, 2))</span>

<span class=sd>    >>> k2[0] is k2[2]</span>
<span class=sd>    True</span>
<span class=sd>    >>> k1[0] is k2[0]</span>
<span class=sd>    True</span>
<span class=sd>    >>> k1[0] is k2[2]</span>
<span class=sd>    True</span>
<span class=sd>    """</span>
    <span class=k>return</span> <span class=n>__to_nested_tuples</span><span class=p>(</span><span class=n>source</span><span class=p>,</span> <span class=n>cache</span><span class=p>,</span> <span class=n>empty_ok</span><span class=p>,</span> <span class=n>type_var</span><span class=p>,</span> <span class=n>inner</span><span class=p>)</span>


<span class=k>def</span><span class=w> </span><span class=nf>__to_2d_npfloat</span><span class=p>(</span><span class=n>source</span><span class=p>:</span> <span class=n>Iterable</span><span class=p>[</span><span class=n>Iterable</span><span class=p>],</span>  <span class=c1># pylint: disable=W1113</span>
                    <span class=n>cache</span><span class=p>:</span> <span class=n>Callable</span><span class=p>,</span> <span class=n>empty_ok</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>False</span><span class=p>,</span>
                    <span class=o>*</span><span class=n>_</span><span class=p>)</span> <span class=o>-></span> <span class=nb>tuple</span><span class=p>[</span><span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>,</span> <span class=o>...</span><span class=p>]:</span>  <span class=c1># pylint: disable=W1113</span>
<span class=w>    </span><span class=sd>"""</span>
<span class=sd>    Turn 2D nested iterables into 2D nested tuples.</span>

<span class=sd>    :param source: the source</span>
<span class=sd>    :param cache: the cache</span>
<span class=sd>    :param empty_ok: are empty tuples OK?</span>
<span class=sd>    :param inner: the inner callable</span>
<span class=sd>    :return: the nested tuples</span>

<span class=sd>    >>> ppl = repr_cache()</span>
<span class=sd>    >>> k2 = __to_2d_npfloat([(1.0, 2.0), (1.0, 2.0, 4.0),  (1.0, 0.2)], ppl)</span>
<span class=sd>    >>> print(k2)</span>
<span class=sd>    (array([1., 2.]), array([1., 2., 4.]), array([1. , 0.2]))</span>
<span class=sd>    """</span>
    <span class=k>return</span> <span class=n>__to_nested_tuples</span><span class=p>(</span><span class=n>source</span><span class=p>,</span> <span class=n>cache</span><span class=p>,</span> <span class=n>empty_ok</span><span class=p>,</span> <span class=nb>float</span><span class=p>,</span> <span class=n>__to_npfloats</span><span class=p>)</span>


<span class=k>def</span><span class=w> </span><span class=nf>__to_3d_npfloat</span><span class=p>(</span><span class=n>source</span><span class=p>:</span> <span class=n>Iterable</span><span class=p>[</span><span class=n>Iterable</span><span class=p>[</span><span class=n>Iterable</span><span class=p>]],</span>
                    <span class=n>cache</span><span class=p>:</span> <span class=n>Callable</span><span class=p>,</span> <span class=n>empty_ok</span><span class=p>:</span> <span class=nb>bool</span><span class=p>)</span> \
        <span class=o>-></span> <span class=nb>tuple</span><span class=p>[</span><span class=nb>tuple</span><span class=p>[</span><span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>,</span> <span class=o>...</span><span class=p>],</span> <span class=o>...</span><span class=p>]:</span>
<span class=w>    </span><span class=sd>"""</span>
<span class=sd>    Turn 3D nested iterables into 3D nested tuples.</span>

<span class=sd>    :param source: the source</span>
<span class=sd>    :param cache: the cache</span>
<span class=sd>    :param empty_ok: are empty tuples OK?</span>
<span class=sd>    :return: the nested tuples</span>

<span class=sd>    >>> ppl = repr_cache()</span>
<span class=sd>    >>> k1 = __to_3d_npfloat([[[3.0, 2.0], [44.0, 5.0], [2.0]],</span>
<span class=sd>    ...                        [[2.0], [5.0, 7.0]]], ppl, False)</span>
<span class=sd>    >>> print(k1)</span>
<span class=sd>    ((array([3., 2.]), array([44.,  5.]), array([2.])), \</span>
<span class=sd>(array([2.]), array([5., 7.])))</span>
<span class=sd>    >>> k1[0][2] is k1[1][0]</span>
<span class=sd>    True</span>
<span class=sd>    """</span>
    <span class=k>return</span> <span class=n>__to_nested_tuples</span><span class=p>(</span><span class=n>source</span><span class=p>,</span> <span class=n>cache</span><span class=p>,</span> <span class=n>empty_ok</span><span class=p>,</span> <span class=nb>float</span><span class=p>,</span> <span class=n>__to_2d_npfloat</span><span class=p>)</span>


<span class=k>def</span><span class=w> </span><span class=nf>_make_routes</span><span class=p>(</span>
        <span class=n>n_products</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>n_stations</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span>
        <span class=n>source</span><span class=p>:</span> <span class=n>Iterable</span><span class=p>[</span><span class=n>Iterable</span><span class=p>[</span><span class=nb>int</span><span class=p>]],</span>
        <span class=n>cache</span><span class=p>:</span> <span class=n>Callable</span><span class=p>)</span> <span class=o>-></span> <span class=nb>tuple</span><span class=p>[</span><span class=nb>tuple</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=o>...</span><span class=p>],</span> <span class=o>...</span><span class=p>]:</span>
<span class=w>    </span><span class=sd>"""</span>
<span class=sd>    Create the routes through stations for the products.</span>

<span class=sd>    Each product passes through a set of stations. It can pass through each</span>
<span class=sd>    station at most once. It can only pass through valid stations.</span>

<span class=sd>    :param n_products: the number of products</span>
<span class=sd>    :param n_stations: the number of stations</span>
<span class=sd>    :param source: the source data</span>
<span class=sd>    :param cache: the cache</span>
<span class=sd>    :return: the routes, a tuple of tuples</span>

<span class=sd>    >>> ppl = repr_cache()</span>
<span class=sd>    >>> _make_routes(2, 3, ((1, 2), (1, 0)), ppl)</span>
<span class=sd>    ((1, 2), (1, 0))</span>

<span class=sd>    >>> _make_routes(3, 3, ((1, 2), (1, 0), (0, 1, 2)), ppl)</span>
<span class=sd>    ((1, 2), (1, 0), (0, 1, 2))</span>

<span class=sd>    >>> k = _make_routes(3, 3, ((1, 2), (1, 2), (0, 1, 2)), ppl)</span>
<span class=sd>    >>> k[0] is k[1]</span>
<span class=sd>    True</span>
<span class=sd>    """</span>
    <span class=n>check_int_range</span><span class=p>(</span><span class=n>n_products</span><span class=p>,</span> <span class=s2>"n_products"</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=n>MAX_ID</span><span class=p>)</span>
    <span class=n>check_int_range</span><span class=p>(</span><span class=n>n_stations</span><span class=p>,</span> <span class=s2>"n_stations"</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=n>MAX_ID</span><span class=p>)</span>
    <span class=n>dest</span><span class=p>:</span> <span class=nb>tuple</span><span class=p>[</span><span class=nb>tuple</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=o>...</span><span class=p>],</span> <span class=o>...</span><span class=p>]</span> <span class=o>=</span> <span class=n>__to_tuples</span><span class=p>(</span><span class=n>source</span><span class=p>,</span> <span class=n>cache</span><span class=p>)</span>

    <span class=n>n_rows</span><span class=p>:</span> <span class=n>Final</span><span class=p>[</span><span class=nb>int</span><span class=p>]</span> <span class=o>=</span> <span class=nb>tuple</span><span class=o>.</span><span class=fm>__len__</span><span class=p>(</span><span class=n>dest</span><span class=p>)</span>
    <span class=k>if</span> <span class=n>n_rows</span> <span class=o>!=</span> <span class=n>n_products</span><span class=p>:</span>
        <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>n_products</span><span class=si>}</span><span class=s2> products, but </span><span class=si>{</span><span class=n>n_rows</span><span class=si>}</span><span class=s2> routes."</span><span class=p>)</span>
    <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>route</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>dest</span><span class=p>):</span>
        <span class=n>stations</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=nb>tuple</span><span class=o>.</span><span class=fm>__len__</span><span class=p>(</span><span class=n>route</span><span class=p>)</span>
        <span class=k>if</span> <span class=n>stations</span> <span class=o><=</span> <span class=mi>0</span><span class=p>:</span>
            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span>
                <span class=sa>f</span><span class=s2>"len(row[</span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s2>])=</span><span class=si>{</span><span class=n>stations</span><span class=si>}</span><span class=s2> but n_stations=</span><span class=si>{</span><span class=n>n_stations</span><span class=si>}</span><span class=s2>"</span><span class=p>)</span>
        <span class=k>for</span> <span class=n>j</span><span class=p>,</span> <span class=n>v</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>route</span><span class=p>):</span>
            <span class=k>if</span> <span class=ow>not</span> <span class=mi>0</span> <span class=o><=</span> <span class=n>v</span> <span class=o><</span> <span class=n>n_stations</span><span class=p>:</span>
                <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span>
                    <span class=sa>f</span><span class=s2>"row[</span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s2>,</span><span class=si>{</span><span class=n>j</span><span class=si>}</span><span class=s2>]=</span><span class=si>{</span><span class=n>v</span><span class=si>}</span><span class=s2>, but n_stations=</span><span class=si>{</span><span class=n>n_stations</span><span class=si>}</span><span class=s2>"</span><span class=p>)</span>
    <span class=k>return</span> <span class=n>dest</span>


<span class=k>def</span><span class=w> </span><span class=nf>__to_demand</span><span class=p>(</span>
        <span class=n>source</span><span class=p>:</span> <span class=n>Iterable</span><span class=p>[</span><span class=nb>int</span> <span class=o>|</span> <span class=nb>float</span><span class=p>],</span> <span class=n>time_end_warmup</span><span class=p>:</span> <span class=nb>float</span><span class=p>,</span>
        <span class=n>cache</span><span class=p>:</span> <span class=n>Callable</span><span class=p>)</span> <span class=o>-></span> <span class=n>Demand</span><span class=p>:</span>
<span class=w>    </span><span class=sd>"""</span>
<span class=sd>    Convert an integer source to a tuple or a demand.</span>

<span class=sd>    :param source: the source</span>
<span class=sd>    :param time_end_warmup: the end of the warmup time</span>
<span class=sd>    :param cache: the cache</span>
<span class=sd>    :return: the Demand</span>

<span class=sd>    >>> ppl = repr_cache()</span>
<span class=sd>    >>> d1 = __to_demand([1, 2, 3, 20, 10, 100], 10.0, ppl)</span>
<span class=sd>    >>> d1</span>
<span class=sd>    Demand(arrival=10.0, deadline=100.0, demand_id=1, \</span>
<span class=sd>customer_id=2, product_id=3, amount=20, measure=True)</span>
<span class=sd>    >>> d2 = __to_demand([1, 2, 3, 20, 10, 100], 10.0, ppl)</span>
<span class=sd>    >>> d1 is d2</span>
<span class=sd>    True</span>
<span class=sd>    """</span>
    <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>source</span><span class=p>,</span> <span class=n>Demand</span><span class=p>):</span>
        <span class=k>return</span> <span class=n>cast</span><span class=p>(</span><span class=s2>"Demand"</span><span class=p>,</span> <span class=n>source</span><span class=p>)</span>
    <span class=n>tup</span><span class=p>:</span> <span class=nb>tuple</span><span class=p>[</span><span class=nb>int</span> <span class=o>|</span> <span class=nb>float</span><span class=p>,</span> <span class=o>...</span><span class=p>]</span> <span class=o>=</span> <span class=nb>tuple</span><span class=p>(</span><span class=n>source</span><span class=p>)</span>
    <span class=n>dl</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=nb>tuple</span><span class=o>.</span><span class=fm>__len__</span><span class=p>(</span><span class=n>tup</span><span class=p>)</span>
    <span class=k>if</span> <span class=n>dl</span> <span class=o>!=</span> <span class=mi>6</span><span class=p>:</span>
        <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=sa>f</span><span class=s2>"Expected 6 values, got </span><span class=si>{</span><span class=n>dl</span><span class=si>}</span><span class=s2>."</span><span class=p>)</span>
    <span class=n>arrival</span><span class=p>:</span> <span class=nb>int</span> <span class=o>|</span> <span class=nb>float</span> <span class=o>=</span> <span class=n>tup</span><span class=p>[</span><span class=n>DEMAND_ARRIVAL</span><span class=p>]</span>
    <span class=k>return</span> <span class=n>cache</span><span class=p>(</span><span class=n>Demand</span><span class=p>(</span>
        <span class=n>demand_id</span><span class=o>=</span><span class=n>cast</span><span class=p>(</span><span class=s2>"int"</span><span class=p>,</span> <span class=n>tup</span><span class=p>[</span><span class=n>DEMAND_ID</span><span class=p>]),</span>
        <span class=n>customer_id</span><span class=o>=</span><span class=n>cast</span><span class=p>(</span><span class=s2>"int"</span><span class=p>,</span> <span class=n>tup</span><span class=p>[</span><span class=n>DEMAND_CUSTOMER</span><span class=p>]),</span>
        <span class=n>product_id</span><span class=o>=</span><span class=n>cast</span><span class=p>(</span><span class=s2>"int"</span><span class=p>,</span> <span class=n>tup</span><span class=p>[</span><span class=n>DEMAND_PRODUCT</span><span class=p>]),</span>
        <span class=n>amount</span><span class=o>=</span><span class=n>cast</span><span class=p>(</span><span class=s2>"int"</span><span class=p>,</span> <span class=n>tup</span><span class=p>[</span><span class=n>DEMAND_AMOUNT</span><span class=p>]),</span>
        <span class=n>arrival</span><span class=o>=</span><span class=n>arrival</span><span class=p>,</span> <span class=n>deadline</span><span class=o>=</span><span class=n>tup</span><span class=p>[</span><span class=n>DEMAND_DEADLINE</span><span class=p>],</span>
        <span class=n>measure</span><span class=o>=</span><span class=n>time_end_warmup</span> <span class=o><=</span> <span class=n>arrival</span><span class=p>))</span>


<span class=k>def</span><span class=w> </span><span class=nf>_make_demands</span><span class=p>(</span><span class=n>n_products</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>n_customers</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>n_demands</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span>
                  <span class=n>source</span><span class=p>:</span> <span class=n>Iterable</span><span class=p>[</span><span class=n>Iterable</span><span class=p>[</span><span class=nb>int</span> <span class=o>|</span> <span class=nb>float</span><span class=p>]],</span>
                  <span class=n>time_end_warmup</span><span class=p>:</span> <span class=nb>float</span><span class=p>,</span>
                  <span class=n>time_end_measure</span><span class=p>:</span> <span class=nb>float</span><span class=p>,</span> <span class=n>cache</span><span class=p>:</span> <span class=n>Callable</span><span class=p>)</span> \
        <span class=o>-></span> <span class=nb>tuple</span><span class=p>[</span><span class=n>Demand</span><span class=p>,</span> <span class=o>...</span><span class=p>]:</span>
<span class=w>    </span><span class=sd>"""</span>
<span class=sd>    Create the demand records, sorted by release time.</span>

<span class=sd>    Each demand is a tuple of demand_id, customer_id, product_id, amount,</span>
<span class=sd>    release time, and deadline.</span>

<span class=sd>    :param n_products: the number of products</span>
<span class=sd>    :param n_customers: the number of customers</span>
<span class=sd>    :param n_demands: the number of demands</span>
<span class=sd>    :param time_end_warmup: the end of the warmup time</span>
<span class=sd>    :param time_end_measure: the end of the measure time period</span>
<span class=sd>    :param source: the source data</span>
<span class=sd>    :param cache: the cache</span>
<span class=sd>    :return: the demand tuples</span>

<span class=sd>    >>> ppl = repr_cache()</span>
<span class=sd>    >>> _make_demands(10, 10, 4, [[0, 2, 1, 4, 20, 21],</span>
<span class=sd>    ...     [2, 5, 2, 6, 17, 27],</span>
<span class=sd>    ...     [1, 6, 7, 12, 17, 21],</span>
<span class=sd>    ...     [3, 7, 3, 23, 5, 21]], 10.0, 1000.0, ppl)</span>
<span class=sd>    (Demand(arrival=5.0, deadline=21.0, demand_id=3, customer_id=7,\</span>
<span class=sd> product_id=3, amount=23, measure=False),\</span>
<span class=sd> Demand(arrival=17.0, deadline=21.0, demand_id=1, customer_id=6,\</span>
<span class=sd> product_id=7, amount=12, measure=True),\</span>
<span class=sd> Demand(arrival=17.0, deadline=27.0, demand_id=2, customer_id=5,\</span>
<span class=sd> product_id=2, amount=6, measure=True),\</span>
<span class=sd> Demand(arrival=20.0, deadline=21.0, demand_id=0, customer_id=2,\</span>
<span class=sd> product_id=1, amount=4, measure=True))</span>
<span class=sd>    """</span>
    <span class=n>check_int_range</span><span class=p>(</span><span class=n>n_products</span><span class=p>,</span> <span class=s2>"n_products"</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=n>MAX_ID</span><span class=p>)</span>
    <span class=n>check_int_range</span><span class=p>(</span><span class=n>n_customers</span><span class=p>,</span> <span class=s2>"n_customers"</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=n>MAX_ID</span><span class=p>)</span>
    <span class=n>check_int_range</span><span class=p>(</span><span class=n>n_demands</span><span class=p>,</span> <span class=s2>"n_demands"</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=n>MAX_ID</span><span class=p>)</span>

    <span class=k>def</span><span class=w> </span><span class=nf>__make_demand</span><span class=p>(</span><span class=n>ssss</span><span class=p>:</span> <span class=n>Iterable</span><span class=p>[</span><span class=nb>int</span> <span class=o>|</span> <span class=nb>float</span><span class=p>],</span>
                      <span class=n>ccc</span><span class=p>:</span> <span class=n>Callable</span><span class=p>,</span> <span class=o>*</span><span class=n>_</span><span class=p>)</span> <span class=o>-></span> <span class=n>Demand</span><span class=p>:</span>
        <span class=k>return</span> <span class=n>__to_demand</span><span class=p>(</span><span class=n>ssss</span><span class=p>,</span> <span class=n>time_end_warmup</span><span class=p>,</span> <span class=n>ccc</span><span class=p>)</span>

    <span class=n>temp</span><span class=p>:</span> <span class=nb>tuple</span><span class=p>[</span><span class=n>Demand</span><span class=p>,</span> <span class=o>...</span><span class=p>]</span> <span class=o>=</span> <span class=n>__to_nested_tuples</span><span class=p>(</span>
        <span class=n>source</span><span class=p>,</span> <span class=n>cache</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=n>inner</span><span class=o>=</span><span class=n>__make_demand</span><span class=p>)</span>
    <span class=n>n_dem</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=nb>tuple</span><span class=o>.</span><span class=fm>__len__</span><span class=p>(</span><span class=n>temp</span><span class=p>)</span>
    <span class=k>if</span> <span class=n>n_dem</span> <span class=o>!=</span> <span class=n>n_demands</span><span class=p>:</span>
        <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=sa>f</span><span class=s2>"Expected </span><span class=si>{</span><span class=n>n_demands</span><span class=si>}</span><span class=s2> demands, got </span><span class=si>{</span><span class=n>n_dem</span><span class=si>}</span><span class=s2>?"</span><span class=p>)</span>

    <span class=n>used_ids</span><span class=p>:</span> <span class=nb>set</span><span class=p>[</span><span class=nb>int</span><span class=p>]</span> <span class=o>=</span> <span class=nb>set</span><span class=p>()</span>
    <span class=n>min_id</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>1000</span> <span class=o>*</span> <span class=n>MAX_ID</span>
    <span class=n>max_id</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1000</span> <span class=o>*</span> <span class=n>MAX_ID</span>
    <span class=n>dest</span><span class=p>:</span> <span class=nb>list</span><span class=p>[</span><span class=n>Demand</span><span class=p>]</span> <span class=o>=</span> <span class=p>[]</span>

    <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>demand</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>temp</span><span class=p>):</span>
        <span class=n>d_id</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=n>demand</span><span class=o>.</span><span class=n>demand_id</span>
        <span class=k>if</span> <span class=ow>not</span> <span class=mi>0</span> <span class=o><=</span> <span class=n>d_id</span> <span class=o><</span> <span class=n>n_demands</span><span class=p>:</span>
            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=sa>f</span><span class=s2>"demand[</span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s2>].id = </span><span class=si>{</span><span class=n>d_id</span><span class=si>}</span><span class=s2>"</span><span class=p>)</span>
        <span class=k>if</span> <span class=n>d_id</span> <span class=ow>in</span> <span class=n>used_ids</span><span class=p>:</span>
            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=sa>f</span><span class=s2>"demand[</span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s2>].id </span><span class=si>{</span><span class=n>d_id</span><span class=si>}</span><span class=s2> appears twice!"</span><span class=p>)</span>
        <span class=n>used_ids</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>d_id</span><span class=p>)</span>
        <span class=n>min_id</span> <span class=o>=</span> <span class=nb>min</span><span class=p>(</span><span class=n>min_id</span><span class=p>,</span> <span class=n>d_id</span><span class=p>)</span>
        <span class=n>max_id</span> <span class=o>=</span> <span class=nb>max</span><span class=p>(</span><span class=n>max_id</span><span class=p>,</span> <span class=n>d_id</span><span class=p>)</span>

        <span class=n>c_id</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=n>demand</span><span class=o>.</span><span class=n>customer_id</span>
        <span class=k>if</span> <span class=ow>not</span> <span class=mi>0</span> <span class=o><=</span> <span class=n>c_id</span> <span class=o><</span> <span class=n>n_customers</span><span class=p>:</span>
            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=sa>f</span><span class=s2>"demand[</span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s2>].customer = </span><span class=si>{</span><span class=n>c_id</span><span class=si>}</span><span class=s2>, "</span>
                             <span class=sa>f</span><span class=s2>"but n_customers=</span><span class=si>{</span><span class=n>n_customers</span><span class=si>}</span><span class=s2>"</span><span class=p>)</span>

        <span class=n>p_id</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=n>demand</span><span class=o>.</span><span class=n>product_id</span>
        <span class=k>if</span> <span class=ow>not</span> <span class=mi>0</span> <span class=o><=</span> <span class=n>p_id</span> <span class=o><</span> <span class=n>n_products</span><span class=p>:</span>
            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=sa>f</span><span class=s2>"demand[</span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s2>].product = </span><span class=si>{</span><span class=n>p_id</span><span class=si>}</span><span class=s2>, "</span>
                             <span class=sa>f</span><span class=s2>"but n_products=</span><span class=si>{</span><span class=n>n_products</span><span class=si>}</span><span class=s2>"</span><span class=p>)</span>

        <span class=n>amount</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=n>demand</span><span class=o>.</span><span class=n>amount</span>
        <span class=k>if</span> <span class=ow>not</span> <span class=mi>0</span> <span class=o><</span> <span class=n>amount</span> <span class=o><</span> <span class=n>MAX_ID</span><span class=p>:</span>
            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=sa>f</span><span class=s2>"demand[</span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s2>].amount = </span><span class=si>{</span><span class=n>amount</span><span class=si>}</span><span class=s2>."</span><span class=p>)</span>

        <span class=n>arrival</span><span class=p>:</span> <span class=nb>float</span> <span class=o>=</span> <span class=n>demand</span><span class=o>.</span><span class=n>arrival</span>
        <span class=k>if</span> <span class=ow>not</span> <span class=p>(</span><span class=n>isfinite</span><span class=p>(</span><span class=n>arrival</span><span class=p>)</span> <span class=ow>and</span> <span class=p>(</span><span class=mi>0</span> <span class=o><</span> <span class=n>arrival</span> <span class=o><</span> <span class=n>MAX_ID</span><span class=p>)):</span>
            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=sa>f</span><span class=s2>"demand[</span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s2>].arrival = </span><span class=si>{</span><span class=n>arrival</span><span class=si>}</span><span class=s2>."</span><span class=p>)</span>

        <span class=n>deadline</span><span class=p>:</span> <span class=nb>float</span> <span class=o>=</span> <span class=n>demand</span><span class=o>.</span><span class=n>deadline</span>
        <span class=k>if</span> <span class=ow>not</span> <span class=p>(</span><span class=n>isfinite</span><span class=p>(</span><span class=n>deadline</span><span class=p>)</span> <span class=ow>and</span> <span class=n>arrival</span> <span class=o><=</span> <span class=n>deadline</span> <span class=o><</span> <span class=n>MAX_ID</span><span class=p>):</span>
            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=sa>f</span><span class=s2>"demand[</span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s2>].deadline = </span><span class=si>{</span><span class=n>deadline</span><span class=si>}</span><span class=s2>."</span><span class=p>)</span>

        <span class=k>if</span> <span class=n>arrival</span> <span class=o>>=</span> <span class=n>time_end_measure</span><span class=p>:</span>
            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=sa>f</span><span class=s2>"Demand[</span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s2>]=</span><span class=si>{</span><span class=n>demand</span><span class=si>!r}</span><span class=s2> has arrival after "</span>
                             <span class=s2>"end of measurement period."</span><span class=p>)</span>
        <span class=n>dest</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>demand</span><span class=p>)</span>

    <span class=n>sl</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=nb>set</span><span class=o>.</span><span class=fm>__len__</span><span class=p>(</span><span class=n>used_ids</span><span class=p>)</span>
    <span class=k>if</span> <span class=n>sl</span> <span class=o>!=</span> <span class=n>n_demands</span><span class=p>:</span>
        <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=sa>f</span><span class=s2>"Got </span><span class=si>{</span><span class=n>n_demands</span><span class=si>}</span><span class=s2> demands, but </span><span class=si>{</span><span class=n>sl</span><span class=si>}</span><span class=s2> ids???"</span><span class=p>)</span>
    <span class=k>if</span> <span class=p>((</span><span class=n>max_id</span> <span class=o>-</span> <span class=n>min_id</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=o>!=</span> <span class=n>n_demands</span><span class=p>)</span> <span class=ow>or</span> <span class=p>(</span><span class=n>min_id</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>):</span>
        <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=sa>f</span><span class=s2>"Invalid demand id range [</span><span class=si>{</span><span class=n>min_id</span><span class=si>}</span><span class=s2>, </span><span class=si>{</span><span class=n>max_id</span><span class=si>}</span><span class=s2>]."</span><span class=p>)</span>
    <span class=n>dest</span><span class=o>.</span><span class=n>sort</span><span class=p>()</span>
    <span class=k>return</span> <span class=n>cache</span><span class=p>(</span><span class=nb>tuple</span><span class=p>(</span><span class=n>dest</span><span class=p>))</span>


<span class=k>def</span><span class=w> </span><span class=nf>_make_in_warehouse</span><span class=p>(</span><span class=n>n_products</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>source</span><span class=p>:</span> <span class=n>Iterable</span><span class=p>[</span><span class=nb>int</span><span class=p>],</span>
                       <span class=n>cache</span><span class=p>:</span> <span class=n>Callable</span><span class=p>)</span> \
        <span class=o>-></span> <span class=nb>tuple</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=o>...</span><span class=p>]:</span>
<span class=w>    </span><span class=sd>"""</span>
<span class=sd>    Make the amount of product in the warehouse at time 0.</span>

<span class=sd>    :param n_products: the total number of products</span>
<span class=sd>    :param source: the data source</span>
<span class=sd>    :param cache: the tuple cache</span>
<span class=sd>    :return: the amount of products in the warehouse</span>

<span class=sd>    >>> _make_in_warehouse(3, [1, 2, 3], repr_cache())</span>
<span class=sd>    (1, 2, 3)</span>
<span class=sd>    """</span>
    <span class=n>ret</span><span class=p>:</span> <span class=nb>tuple</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=o>...</span><span class=p>]</span> <span class=o>=</span> <span class=n>__to_tuple</span><span class=p>(</span><span class=n>source</span><span class=p>,</span> <span class=n>cache</span><span class=p>)</span>
    <span class=n>rl</span><span class=p>:</span> <span class=n>Final</span><span class=p>[</span><span class=nb>int</span><span class=p>]</span> <span class=o>=</span> <span class=nb>tuple</span><span class=o>.</span><span class=fm>__len__</span><span class=p>(</span><span class=n>ret</span><span class=p>)</span>
    <span class=k>if</span> <span class=n>rl</span> <span class=o>!=</span> <span class=n>n_products</span><span class=p>:</span>
        <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=sa>f</span><span class=s2>"We have </span><span class=si>{</span><span class=n>n_products</span><span class=si>}</span><span class=s2> products, "</span>
                         <span class=sa>f</span><span class=s2>"but the warehouse list length is </span><span class=si>{</span><span class=n>rl</span><span class=si>}</span><span class=s2>."</span><span class=p>)</span>
    <span class=k>for</span> <span class=n>p</span><span class=p>,</span> <span class=n>v</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>ret</span><span class=p>):</span>
        <span class=k>if</span> <span class=ow>not</span> <span class=mi>0</span> <span class=o><=</span> <span class=n>v</span> <span class=o><=</span> <span class=n>MAX_ID</span><span class=p>:</span>
            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=sa>f</span><span class=s2>"Got </span><span class=si>{</span><span class=n>v</span><span class=si>}</span><span class=s2> units of product </span><span class=si>{</span><span class=n>p</span><span class=si>}</span><span class=s2> in warehouse?"</span><span class=p>)</span>
    <span class=k>return</span> <span class=n>ret</span>


<span class=k>def</span><span class=w> </span><span class=nf>_make_station_product_unit_times</span><span class=p>(</span>
        <span class=n>n_products</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>n_stations</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span>
        <span class=n>routes</span><span class=p>:</span> <span class=nb>tuple</span><span class=p>[</span><span class=nb>tuple</span><span class=p>[</span><span class=nb>float</span><span class=p>,</span> <span class=o>...</span><span class=p>],</span> <span class=o>...</span><span class=p>],</span>
        <span class=n>source</span><span class=p>:</span> <span class=n>Iterable</span><span class=p>[</span><span class=n>Iterable</span><span class=p>[</span><span class=n>Iterable</span><span class=p>[</span><span class=nb>float</span><span class=p>]]],</span>
        <span class=n>cache</span><span class=p>:</span> <span class=n>Callable</span><span class=p>)</span> <span class=o>-></span> <span class=nb>tuple</span><span class=p>[</span><span class=nb>tuple</span><span class=p>[</span><span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>,</span> <span class=o>...</span><span class=p>],</span> <span class=o>...</span><span class=p>]:</span>
<span class=w>    </span><span class=sd>"""</span>
<span class=sd>    Create the structure for the work times per product unit per station.</span>

<span class=sd>    Here we have for each station, for each product, a sequence of per-unit</span>
<span class=sd>    production settings. Each such "production settings" is a tuple with a</span>
<span class=sd>    per-unit production time and an end time index until which it is valid.</span>
<span class=sd>    Production times cycle, so if we produce something after the last end</span>
<span class=sd>    time index, we begin again at production time index 0.</span>

<span class=sd>    :param n_products: the number of products</span>
<span class=sd>    :param n_stations: the number of stations</span>
<span class=sd>    :param routes: the routes of the products through the stations</span>
<span class=sd>    :param source: the source array</span>
<span class=sd>    :param cache: the cache</span>
<span class=sd>    :return: the station unit times</span>

<span class=sd>    >>> ppl = repr_cache()</span>
<span class=sd>    >>> rts = _make_routes(3, 2, [[0, 1], [0], [1, 0]], ppl)</span>
<span class=sd>    >>> print(rts)</span>
<span class=sd>    ((0, 1), (0,), (1, 0))</span>

<span class=sd>    >>> mpt1 = _make_station_product_unit_times(3, 2, rts, [</span>
<span class=sd>    ...     [[1.0, 2.0, 3.0, 5.0], [1.0, 2.0, 3.0, 5.0],</span>
<span class=sd>    ...      [1.0, 10.0, 2.0, 30.0]],</span>
<span class=sd>    ...     [[2.0, 20.0, 3.0, 40.0], [], [4.0, 56.0, 34.0, 444.0]]], ppl)</span>
<span class=sd>    >>> print(mpt1)</span>
<span class=sd>    ((array([1., 2., 3., 5.]), array([1., 2., 3., 5.]), \</span>
<span class=sd>array([ 1., 10.,  2., 30.])), (array([ 2., 20.,  3., 40.]), \</span>
<span class=sd>array([], dtype=float64), array([  4.,  56.,  34., 444.])))</span>
<span class=sd>    >>> mpt1[0][0] is mpt1[0][1]</span>
<span class=sd>    True</span>

<span class=sd>    >>> mpt2 = _make_station_product_unit_times(3, 2, rts, [</span>
<span class=sd>    ...     [[1.0, 2.0, 3.0, 5.0], [1.0, 2.0, 3.0, 5.0],</span>
<span class=sd>    ...      [1.0, 10.0, 2.0, 30.0]],</span>
<span class=sd>    ...     [[2.0, 20.0, 3.0, 40.0], [], [4.0, 56.0, 34.0, 444.0]]], ppl)</span>
<span class=sd>    >>> print(mpt2)</span>
<span class=sd>    ((array([1., 2., 3., 5.]), array([1., 2., 3., 5.]), \</span>
<span class=sd>array([ 1., 10.,  2., 30.])), (array([ 2., 20.,  3., 40.]), \</span>
<span class=sd>array([], dtype=float64), array([  4.,  56.,  34., 444.])))</span>
<span class=sd>    >>> mpt1 is mpt2</span>
<span class=sd>    True</span>
<span class=sd>    """</span>
    <span class=n>ret</span><span class=p>:</span> <span class=nb>tuple</span><span class=p>[</span><span class=nb>tuple</span><span class=p>[</span><span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>,</span> <span class=o>...</span><span class=p>],</span> <span class=o>...</span><span class=p>]</span> <span class=o>=</span> <span class=n>__to_3d_npfloat</span><span class=p>(</span>
        <span class=n>source</span><span class=p>,</span> <span class=n>cache</span><span class=p>,</span> <span class=kc>True</span><span class=p>)</span>

    <span class=k>if</span> <span class=nb>tuple</span><span class=o>.</span><span class=fm>__len__</span><span class=p>(</span><span class=n>routes</span><span class=p>)</span> <span class=o>!=</span> <span class=n>n_products</span><span class=p>:</span>
        <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>"invalid routes!"</span><span class=p>)</span>

    <span class=n>d1</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=nb>tuple</span><span class=o>.</span><span class=fm>__len__</span><span class=p>(</span><span class=n>ret</span><span class=p>)</span>
    <span class=k>if</span> <span class=n>d1</span> <span class=o>!=</span> <span class=n>n_stations</span><span class=p>:</span>
        <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span>
            <span class=sa>f</span><span class=s2>"Got </span><span class=si>{</span><span class=n>d1</span><span class=si>}</span><span class=s2> station-times, but </span><span class=si>{</span><span class=n>n_stations</span><span class=si>}</span><span class=s2> stations."</span><span class=p>)</span>
    <span class=k>for</span> <span class=n>mid</span><span class=p>,</span> <span class=n>station</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>ret</span><span class=p>):</span>
        <span class=n>d2</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=nb>tuple</span><span class=o>.</span><span class=fm>__len__</span><span class=p>(</span><span class=n>station</span><span class=p>)</span>
        <span class=k>if</span> <span class=n>d2</span> <span class=o><=</span> <span class=mi>0</span><span class=p>:</span>
            <span class=k>for</span> <span class=n>pid</span><span class=p>,</span> <span class=n>r</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>routes</span><span class=p>):</span>
                <span class=k>if</span> <span class=n>mid</span> <span class=ow>in</span> <span class=n>r</span><span class=p>:</span>
                    <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span>
                        <span class=sa>f</span><span class=s2>"Station </span><span class=si>{</span><span class=n>mid</span><span class=si>}</span><span class=s2> in route for product </span><span class=si>{</span><span class=n>pid</span><span class=si>}</span><span class=s2>, "</span>
                        <span class=s2>"but has no production time"</span><span class=p>)</span>
            <span class=k>continue</span>
        <span class=k>if</span> <span class=n>d2</span> <span class=o>!=</span> <span class=n>n_products</span><span class=p>:</span>
            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=sa>f</span><span class=s2>"got </span><span class=si>{</span><span class=n>d2</span><span class=si>}</span><span class=s2> products for station </span><span class=si>{</span><span class=n>mid</span><span class=si>}</span><span class=s2>, "</span>
                             <span class=sa>f</span><span class=s2>"but have </span><span class=si>{</span><span class=n>n_products</span><span class=si>}</span><span class=s2> products"</span><span class=p>)</span>
        <span class=k>for</span> <span class=n>pid</span><span class=p>,</span> <span class=n>product</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>station</span><span class=p>):</span>
            <span class=n>needs_times</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=n>mid</span> <span class=ow>in</span> <span class=n>routes</span><span class=p>[</span><span class=n>pid</span><span class=p>]</span>
            <span class=n>d3</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=o>.</span><span class=fm>__len__</span><span class=p>(</span><span class=n>product</span><span class=p>)</span>
            <span class=k>if</span> <span class=p>(</span><span class=ow>not</span> <span class=n>needs_times</span><span class=p>)</span> <span class=ow>and</span> <span class=p>(</span><span class=n>d3</span> <span class=o>></span> <span class=mi>0</span><span class=p>):</span>
                <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span>
                    <span class=sa>f</span><span class=s2>"product </span><span class=si>{</span><span class=n>pid</span><span class=si>}</span><span class=s2> does not pass through station </span><span class=si>{</span><span class=n>mid</span><span class=si>}</span><span class=s2>, "</span>
                    <span class=s2>"so there must not be production times!"</span><span class=p>)</span>
            <span class=k>if</span> <span class=n>needs_times</span> <span class=ow>and</span> <span class=p>(</span><span class=n>d3</span> <span class=o><=</span> <span class=mi>0</span><span class=p>):</span>
                <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span>
                    <span class=sa>f</span><span class=s2>"product </span><span class=si>{</span><span class=n>pid</span><span class=si>}</span><span class=s2> does pass through station </span><span class=si>{</span><span class=n>mid</span><span class=si>}</span><span class=s2>, "</span>
                    <span class=s2>"so there must be production times!"</span><span class=p>)</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>d3</span> <span class=o>%</span> <span class=mi>2</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>:</span>
                <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span>
                    <span class=sa>f</span><span class=s2>"production times for </span><span class=si>{</span><span class=n>pid</span><span class=si>}</span><span class=s2> does pass through station "</span>
                    <span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>mid</span><span class=si>}</span><span class=s2>, must be of even length, but got length </span><span class=si>{</span><span class=n>d3</span><span class=si>}</span><span class=s2>."</span><span class=p>)</span>
            <span class=n>last_end</span> <span class=o>=</span> <span class=mi>0</span>
            <span class=k>for</span> <span class=n>pt</span><span class=p>,</span> <span class=n>time</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>batched</span><span class=p>(</span><span class=n>product</span><span class=p>,</span> <span class=mi>2</span><span class=p>)):</span>
                <span class=k>if</span> <span class=nb>tuple</span><span class=o>.</span><span class=fm>__len__</span><span class=p>(</span><span class=n>time</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>2</span><span class=p>:</span>
                    <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=sa>f</span><span class=s2>"production times must be 2-tuples, "</span>
                                     <span class=sa>f</span><span class=s2>"but got </span><span class=si>{</span><span class=n>time</span><span class=si>}</span><span class=s2> for product </span><span class=si>{</span><span class=n>pid</span><span class=si>}</span><span class=s2> on "</span>
                                     <span class=sa>f</span><span class=s2>"station </span><span class=si>{</span><span class=n>mid</span><span class=si>}</span><span class=s2> at position </span><span class=si>{</span><span class=n>pt</span><span class=si>}</span><span class=s2>"</span><span class=p>)</span>
                <span class=n>unit_time</span><span class=p>,</span> <span class=n>end</span> <span class=o>=</span> <span class=n>time</span>
                <span class=k>if</span> <span class=ow>not</span> <span class=p>((</span><span class=n>unit_time</span> <span class=o>></span> <span class=mi>0</span><span class=p>)</span> <span class=ow>and</span> <span class=p>(</span><span class=n>last_end</span> <span class=o><</span> <span class=n>end</span> <span class=o><</span> <span class=n>MAX_ID</span><span class=p>)):</span>
                    <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span>
                        <span class=sa>f</span><span class=s2>"Invalid unit time </span><span class=si>{</span><span class=n>unit_time</span><span class=si>}</span><span class=s2> and end time "</span>
                        <span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>end</span><span class=si>}</span><span class=s2> for product </span><span class=si>{</span><span class=n>pid</span><span class=si>}</span><span class=s2> on station </span><span class=si>{</span><span class=n>mid</span><span class=si>}</span><span class=s2>"</span><span class=p>)</span>
                <span class=n>last_end</span> <span class=o>=</span> <span class=n>end</span>

    <span class=k>return</span> <span class=n>ret</span>


<span class=k>def</span><span class=w> </span><span class=nf>_make_infos</span><span class=p>(</span><span class=n>source</span><span class=p>:</span> <span class=n>Iterable</span><span class=p>[</span><span class=nb>tuple</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=nb>str</span><span class=p>]]</span> <span class=o>|</span> <span class=n>Mapping</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=nb>str</span><span class=p>]</span> <span class=o>|</span> <span class=kc>None</span><span class=p>)</span>\
        <span class=o>-></span> <span class=n>Mapping</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=nb>str</span><span class=p>]:</span>
<span class=w>    </span><span class=sd>"""</span>
<span class=sd>    Make the additional information record.</span>

<span class=sd>    :param source: the information to represent</span>
<span class=sd>    :return: the information record</span>
<span class=sd>    """</span>
    <span class=n>use_source</span><span class=p>:</span> <span class=n>Iterable</span><span class=p>[</span><span class=nb>tuple</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=nb>str</span><span class=p>]]</span> <span class=o>=</span> <span class=p>()</span> <span class=k>if</span> <span class=n>source</span> <span class=ow>is</span> <span class=kc>None</span> <span class=k>else</span> <span class=p>(</span>
        <span class=n>source</span><span class=o>.</span><span class=n>items</span><span class=p>()</span> <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>source</span><span class=p>,</span> <span class=n>Mapping</span><span class=p>)</span> <span class=k>else</span> <span class=n>source</span><span class=p>)</span>
    <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>use_source</span><span class=p>,</span> <span class=n>Iterable</span><span class=p>):</span>
        <span class=k>raise</span> <span class=n>type_error</span><span class=p>(</span><span class=n>source</span><span class=p>,</span> <span class=s2>"infos"</span><span class=p>,</span> <span class=n>Iterable</span><span class=p>)</span>
    <span class=n>dst</span><span class=p>:</span> <span class=nb>dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=p>{}</span>
    <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>tup</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>use_source</span><span class=p>):</span>
        <span class=k>if</span> <span class=nb>tuple</span><span class=o>.</span><span class=fm>__len__</span><span class=p>(</span><span class=n>tup</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>2</span><span class=p>:</span>
            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=sa>f</span><span class=s2>"Invalid tuple </span><span class=si>{</span><span class=n>tup</span><span class=si>}</span><span class=s2> at index </span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s2> in infos."</span><span class=p>)</span>
        <span class=n>k</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=nb>str</span><span class=o>.</span><span class=n>strip</span><span class=p>(</span><span class=n>tup</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>
        <span class=n>v</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=nb>str</span><span class=o>.</span><span class=n>strip</span><span class=p>(</span><span class=n>tup</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span>
        <span class=k>if</span> <span class=p>(</span><span class=nb>str</span><span class=o>.</span><span class=fm>__len__</span><span class=p>(</span><span class=n>k</span><span class=p>)</span> <span class=o><=</span> <span class=mi>0</span><span class=p>)</span> <span class=ow>or</span> <span class=p>(</span><span class=nb>str</span><span class=o>.</span><span class=fm>__len__</span><span class=p>(</span><span class=n>v</span><span class=p>)</span> <span class=o><=</span> <span class=mi>0</span><span class=p>):</span>
            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=sa>f</span><span class=s2>"Invalid key/values </span><span class=si>{</span><span class=n>k</span><span class=si>!r}</span><span class=s2>/</span><span class=si>{</span><span class=n>v</span><span class=si>!r}</span><span class=s2> in tuple "</span>
                             <span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>tup</span><span class=si>}</span><span class=s2> at index </span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s2> in infos."</span><span class=p>)</span>
        <span class=k>if</span> <span class=n>__FORBIDDEN_INFO_KEYS</span><span class=p>(</span><span class=nb>str</span><span class=o>.</span><span class=n>lower</span><span class=p>(</span><span class=n>k</span><span class=p>)):</span>
            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span>
                <span class=sa>f</span><span class=s2>"Info key </span><span class=si>{</span><span class=n>k</span><span class=si>!r}</span><span class=s2> in tuple </span><span class=si>{</span><span class=n>tup</span><span class=si>}</span><span class=s2> forbidden at index </span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s2>."</span><span class=p>)</span>
        <span class=k>if</span> <span class=ow>not</span> <span class=nb>all</span><span class=p>(</span><span class=nb>map</span><span class=p>(</span><span class=n>__ALLOWED_INFO_KEY_CHARS</span><span class=p>,</span> <span class=n>k</span><span class=p>)):</span>
            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span>
                <span class=sa>f</span><span class=s2>"Malformed info key </span><span class=si>{</span><span class=n>k</span><span class=si>!r}</span><span class=s2> in tuple </span><span class=si>{</span><span class=n>tup</span><span class=si>}</span><span class=s2> at index </span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s2>."</span><span class=p>)</span>
        <span class=k>if</span> <span class=n>k</span> <span class=ow>in</span> <span class=n>dst</span><span class=p>:</span>
            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=sa>f</span><span class=s2>"Duplicate key </span><span class=si>{</span><span class=n>k</span><span class=si>!r}</span><span class=s2> found in tuple </span><span class=si>{</span><span class=n>tup</span><span class=si>}</span><span class=s2> "</span>
                             <span class=sa>f</span><span class=s2>"at index </span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s2> in infos."</span><span class=p>)</span>
        <span class=n>dst</span><span class=p>[</span><span class=n>k</span><span class=p>]</span> <span class=o>=</span> <span class=n>v</span>
    <span class=k>return</span> <span class=n>immutable_mapping</span><span class=p>(</span><span class=n>dst</span><span class=p>)</span>


<div class=viewcode-block id=Instance>
<a class=viewcode-back href=../../../moptipyapps.prodsched.html#moptipyapps.prodsched.instance.Instance>[docs]</a>
<span class=k>class</span><span class=w> </span><span class=nc>Instance</span><span class=p>(</span><span class=n>Component</span><span class=p>):</span>
<span class=w>    </span><span class=sd>"""An instance of the Production Scheduling Problem."""</span>

    <span class=k>def</span><span class=w> </span><span class=fm>__init__</span><span class=p>(</span>
            <span class=bp>self</span><span class=p>,</span> <span class=n>name</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
            <span class=n>n_products</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>n_customers</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>n_stations</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span>
            <span class=n>n_demands</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span>
            <span class=n>time_end_warmup</span><span class=p>:</span> <span class=nb>int</span> <span class=o>|</span> <span class=nb>float</span><span class=p>,</span> <span class=n>time_end_measure</span><span class=p>:</span> <span class=nb>int</span> <span class=o>|</span> <span class=nb>float</span><span class=p>,</span>
            <span class=n>routes</span><span class=p>:</span> <span class=n>Iterable</span><span class=p>[</span><span class=n>Iterable</span><span class=p>[</span><span class=nb>int</span><span class=p>]],</span>
            <span class=n>demands</span><span class=p>:</span> <span class=n>Iterable</span><span class=p>[</span><span class=n>Iterable</span><span class=p>[</span><span class=nb>int</span> <span class=o>|</span> <span class=nb>float</span><span class=p>]],</span>
            <span class=n>warehous_at_t0</span><span class=p>:</span> <span class=n>Iterable</span><span class=p>[</span><span class=nb>int</span><span class=p>],</span>
            <span class=n>station_product_unit_times</span><span class=p>:</span> <span class=n>Iterable</span><span class=p>[</span><span class=n>Iterable</span><span class=p>[</span><span class=n>Iterable</span><span class=p>[</span><span class=nb>float</span><span class=p>]]],</span>
            <span class=n>infos</span><span class=p>:</span> <span class=n>Iterable</span><span class=p>[</span><span class=nb>tuple</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=nb>str</span><span class=p>]]</span> <span class=o>|</span> <span class=n>Mapping</span><span class=p>[</span>
                <span class=nb>str</span><span class=p>,</span> <span class=nb>str</span><span class=p>]</span> <span class=o>|</span> <span class=kc>None</span> <span class=o>=</span> <span class=kc>None</span><span class=p>)</span> \
            <span class=o>-></span> <span class=kc>None</span><span class=p>:</span>
<span class=w>        </span><span class=sd>"""</span>
<span class=sd>        Create an instance of the production scheduling time.</span>

<span class=sd>        :param name: the instance name</span>
<span class=sd>        :param n_products: the number of products</span>
<span class=sd>        :param n_customers: the number of customers</span>
<span class=sd>        :param n_stations: the number of stations</span>
<span class=sd>        :param n_demands: the number of demand records</span>
<span class=sd>        :param time_end_warmup: the time unit when the warmup time ends and the</span>
<span class=sd>            actual measurement begins</span>
<span class=sd>        :param time_end_measure: the time unit when the actual measure time</span>
<span class=sd>            ends</span>
<span class=sd>        :param routes: for each product, the sequence of stations that it has</span>
<span class=sd>            to pass</span>
<span class=sd>        :param demands: a sequences of demands of the form (</span>
<span class=sd>            customer_id, product_id, product_amount, release_time) OR a</span>
<span class=sd>            sequence of :class:`Demand` records.</span>
<span class=sd>        :param warehous_at_t0: the amount of products in the warehouse at time</span>
<span class=sd>            0 for each product</span>
<span class=sd>        :param station_product_unit_times: for each station and each product</span>
<span class=sd>            the per-unit-production time schedule, in the form of</span>
<span class=sd>            "per_unit_time, duration", where duration is the number of time</span>
<span class=sd>            units for which the per_unit_time is value</span>
<span class=sd>        :param station_product_unit_times: the cycling unit times for each</span>
<span class=sd>            product on each station, each with a validity duration</span>
<span class=sd>        :param infos: additional infos to be stored with the instance.</span>
<span class=sd>            These are key-value pairs with keys that are not used by the</span>
<span class=sd>            instance. They have no impact on the instance performance, but may</span>
<span class=sd>            explain settings of an instance generator.</span>
<span class=sd>        :raises ValueError: If the data is inconsistent or otherwise not</span>
<span class=sd>            permissible.</span>
<span class=sd>        """</span>
        <span class=n>use_name</span><span class=p>:</span> <span class=n>Final</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=n>sanitize_name</span><span class=p>(</span><span class=n>name</span><span class=p>)</span>
        <span class=k>if</span> <span class=n>name</span> <span class=o>!=</span> <span class=n>use_name</span><span class=p>:</span>
            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=sa>f</span><span class=s2>"Name </span><span class=si>{</span><span class=n>name</span><span class=si>!r}</span><span class=s2> is not a valid name."</span><span class=p>)</span>
        <span class=k>if</span> <span class=ow>not</span> <span class=nb>all</span><span class=p>(</span><span class=nb>map</span><span class=p>(</span><span class=n>_ALLOWED_NAME_CHARS</span><span class=p>,</span> <span class=n>name</span><span class=p>)):</span>
            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=sa>f</span><span class=s2>"Name </span><span class=si>{</span><span class=n>name</span><span class=si>!r}</span><span class=s2> contains invalid characters."</span><span class=p>)</span>
        <span class=c1>#: the name of this instance</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>name</span><span class=p>:</span> <span class=n>Final</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=n>name</span>

        <span class=c1>#: the number of products in the scenario</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>n_products</span><span class=p>:</span> <span class=n>Final</span><span class=p>[</span><span class=nb>int</span><span class=p>]</span> <span class=o>=</span> <span class=n>check_int_range</span><span class=p>(</span>
            <span class=n>n_products</span><span class=p>,</span> <span class=s2>"n_products"</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=n>MAX_ID</span><span class=p>)</span>
        <span class=c1>#: the number of customers in the scenario</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>n_customers</span><span class=p>:</span> <span class=n>Final</span><span class=p>[</span><span class=nb>int</span><span class=p>]</span> <span class=o>=</span> <span class=n>check_int_range</span><span class=p>(</span>
            <span class=n>n_customers</span><span class=p>,</span> <span class=s2>"n_customers"</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=n>MAX_ID</span><span class=p>)</span>
        <span class=c1>#: the number of stations or workstations in the scenario</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>n_stations</span><span class=p>:</span> <span class=n>Final</span><span class=p>[</span><span class=nb>int</span><span class=p>]</span> <span class=o>=</span> <span class=n>check_int_range</span><span class=p>(</span>
            <span class=n>n_stations</span><span class=p>,</span> <span class=s2>"n_stations"</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=n>MAX_ID</span><span class=p>)</span>
        <span class=c1>#: the number of demands in the scenario</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>n_demands</span><span class=p>:</span> <span class=n>Final</span><span class=p>[</span><span class=nb>int</span><span class=p>]</span> <span class=o>=</span> <span class=n>check_int_range</span><span class=p>(</span>
            <span class=n>n_demands</span><span class=p>,</span> <span class=s2>"n_demands"</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=n>MAX_ID</span><span class=p>)</span>

        <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>time_end_warmup</span><span class=p>,</span> <span class=nb>int</span> <span class=o>|</span> <span class=nb>float</span><span class=p>):</span>
            <span class=k>raise</span> <span class=n>type_error</span><span class=p>(</span><span class=n>time_end_warmup</span><span class=p>,</span> <span class=s2>"time_end_warmup"</span><span class=p>,</span> <span class=p>(</span><span class=nb>int</span><span class=p>,</span> <span class=nb>float</span><span class=p>))</span>
        <span class=n>time_end_warmup</span> <span class=o>=</span> <span class=nb>float</span><span class=p>(</span><span class=n>time_end_warmup</span><span class=p>)</span>
        <span class=k>if</span> <span class=ow>not</span> <span class=p>(</span><span class=n>isfinite</span><span class=p>(</span><span class=n>time_end_warmup</span><span class=p>)</span> <span class=ow>and</span> <span class=p>(</span>
                <span class=mi>0</span> <span class=o><=</span> <span class=n>time_end_warmup</span> <span class=o><</span> <span class=n>MAX_VALUE</span><span class=p>)):</span>
            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=sa>f</span><span class=s2>"Invalid time_end_warmup=</span><span class=si>{</span><span class=n>time_end_warmup</span><span class=si>}</span><span class=s2>."</span><span class=p>)</span>
        <span class=c1>#: the end of the warmup time</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>time_end_warmup</span><span class=p>:</span> <span class=n>Final</span><span class=p>[</span><span class=nb>float</span><span class=p>]</span> <span class=o>=</span> <span class=n>time_end_warmup</span>

        <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>time_end_measure</span><span class=p>,</span> <span class=nb>int</span> <span class=o>|</span> <span class=nb>float</span><span class=p>):</span>
            <span class=k>raise</span> <span class=n>type_error</span><span class=p>(</span><span class=n>time_end_measure</span><span class=p>,</span> <span class=s2>"time_end_measure"</span><span class=p>,</span> <span class=p>(</span>
                <span class=nb>int</span><span class=p>,</span> <span class=nb>float</span><span class=p>))</span>
        <span class=n>time_end_measure</span> <span class=o>=</span> <span class=nb>float</span><span class=p>(</span><span class=n>time_end_measure</span><span class=p>)</span>
        <span class=k>if</span> <span class=ow>not</span> <span class=p>(</span><span class=n>isfinite</span><span class=p>(</span><span class=n>time_end_measure</span><span class=p>)</span> <span class=ow>and</span> <span class=p>(</span>
                <span class=n>time_end_warmup</span> <span class=o><</span> <span class=n>time_end_measure</span> <span class=o><</span> <span class=n>MAX_VALUE</span><span class=p>)):</span>
            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=sa>f</span><span class=s2>"Invalid time_end_measure=</span><span class=si>{</span><span class=n>time_end_measure</span><span class=si>}</span><span class=s2> "</span>
                             <span class=sa>f</span><span class=s2>"for time_end_warmup=</span><span class=si>{</span><span class=n>time_end_warmup</span><span class=si>}</span><span class=s2>."</span><span class=p>)</span>
        <span class=c1>#: the end of the measurement time</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>time_end_measure</span><span class=p>:</span> <span class=n>Final</span><span class=p>[</span><span class=nb>float</span><span class=p>]</span> <span class=o>=</span> <span class=n>time_end_measure</span>

        <span class=n>cache</span><span class=p>:</span> <span class=n>Final</span><span class=p>[</span><span class=n>Callable</span><span class=p>]</span> <span class=o>=</span> <span class=n>repr_cache</span><span class=p>()</span>  <span class=c1># the pool for resolving tuples</span>

        <span class=c1>#: the product routes, i.e., the stations through which each product</span>
        <span class=c1>#: must pass</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>routes</span><span class=p>:</span> <span class=n>Final</span><span class=p>[</span><span class=nb>tuple</span><span class=p>[</span><span class=nb>tuple</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=o>...</span><span class=p>],</span> <span class=o>...</span><span class=p>]]</span> <span class=o>=</span> <span class=n>_make_routes</span><span class=p>(</span>
            <span class=n>n_products</span><span class=p>,</span> <span class=n>n_stations</span><span class=p>,</span> <span class=n>routes</span><span class=p>,</span> <span class=n>cache</span><span class=p>)</span>

        <span class=c1>#: The demands: Each demand stores the :attr:`~Demand.demand_id`,</span>
        <span class=c1>#: :attr:`~Demand.customer_id`, :attr:`~Demand.product_id`,</span>
        <span class=c1>#: :attr:`~Demand.amount`, :attr:`~Demand.arrival` time, and</span>
        <span class=c1>#: :attr:`~Demand.deadline`, as well as whether it should be</span>
        <span class=c1>#: measured during the simulation (:attr:`~Demand.measure`).</span>
        <span class=c1>#: The customer makes their order at time step</span>
        <span class=c1>#: :attr:`~Demand.arrival`.</span>
        <span class=c1>#: They expect to receive their product by the</span>
        <span class=c1>#: :attr:`~Demand.deadline` .</span>
        <span class=c1>#: The demands are sorted by :attr:`~Demand.arrival` and then</span>
        <span class=c1>#: :attr:`~Demand.deadline` .</span>
        <span class=c1>#: The release time is always > 0.</span>
        <span class=c1>#: The :attr:`~Demand.arrival` is always >=</span>
        <span class=c1>#: :attr:`~Demand.deadline` .</span>
        <span class=c1>#: Demand ids are unique.</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>demands</span><span class=p>:</span> <span class=n>Final</span><span class=p>[</span><span class=nb>tuple</span><span class=p>[</span><span class=n>Demand</span><span class=p>,</span> <span class=o>...</span><span class=p>]]</span> <span class=o>=</span> <span class=n>_make_demands</span><span class=p>(</span>
            <span class=n>n_products</span><span class=p>,</span> <span class=n>n_customers</span><span class=p>,</span> <span class=n>n_demands</span><span class=p>,</span> <span class=n>demands</span><span class=p>,</span> <span class=n>time_end_warmup</span><span class=p>,</span>
            <span class=n>time_end_measure</span><span class=p>,</span> <span class=n>cache</span><span class=p>)</span>

        <span class=c1># count the demands that fall in the measure time window</span>
        <span class=n>n_measure</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>0</span>
        <span class=n>n_measures</span><span class=p>:</span> <span class=nb>list</span><span class=p>[</span><span class=nb>int</span><span class=p>]</span> <span class=o>=</span> <span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>*</span> <span class=n>n_products</span>
        <span class=k>for</span> <span class=n>d</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>demands</span><span class=p>:</span>
            <span class=k>if</span> <span class=n>d</span><span class=o>.</span><span class=n>arrival</span> <span class=o>>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>time_end_measure</span><span class=p>:</span>
                <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=sa>f</span><span class=s2>"Invalid arrival time of demand </span><span class=si>{</span><span class=n>d</span><span class=si>!r}</span><span class=s2>."</span><span class=p>)</span>
            <span class=k>if</span> <span class=n>d</span><span class=o>.</span><span class=n>measure</span> <span class=o>!=</span> <span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>time_end_warmup</span> <span class=o><=</span> <span class=n>d</span><span class=o>.</span><span class=n>arrival</span><span class=p>):</span>
                <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span>
                    <span class=sa>f</span><span class=s2>"Inconsistent measure property for demand </span><span class=si>{</span><span class=n>d</span><span class=si>!r}</span><span class=s2>."</span><span class=p>)</span>
            <span class=k>if</span> <span class=n>d</span><span class=o>.</span><span class=n>measure</span><span class=p>:</span>
                <span class=n>n_measure</span> <span class=o>+=</span> <span class=mi>1</span>
                <span class=n>n_measures</span><span class=p>[</span><span class=n>d</span><span class=o>.</span><span class=n>product_id</span><span class=p>]</span> <span class=o>+=</span> <span class=mi>1</span>
        <span class=k>if</span> <span class=n>n_measure</span> <span class=o><=</span> <span class=mi>0</span><span class=p>:</span>
            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>"There are no measurable demands!"</span><span class=p>)</span>
        <span class=k>for</span> <span class=n>pid</span><span class=p>,</span> <span class=n>npm</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>n_measures</span><span class=p>):</span>
            <span class=k>if</span> <span class=n>npm</span> <span class=o><=</span> <span class=mi>0</span><span class=p>:</span>
                <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=sa>f</span><span class=s2>"No measurable demand for product </span><span class=si>{</span><span class=n>pid</span><span class=si>}</span><span class=s2>!"</span><span class=p>)</span>
        <span class=c1>#: the number of demands that actually fall into the time measured</span>
        <span class=c1>#: window</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>n_measurable_demands</span><span class=p>:</span> <span class=n>Final</span><span class=p>[</span><span class=nb>int</span><span class=p>]</span> <span class=o>=</span> <span class=n>n_measure</span>
        <span class=c1>#: the measurable demands on a per-product basis</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>n_measurable_demands_per_product</span><span class=p>:</span> <span class=n>Final</span><span class=p>[</span><span class=nb>tuple</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=o>...</span><span class=p>]]</span> <span class=o>=</span> <span class=nb>tuple</span><span class=p>(</span>
            <span class=n>n_measures</span><span class=p>)</span>

        <span class=c1>#: The units of product in the warehouse at time step 0.</span>
        <span class=c1>#: For each product, we have either 0 or a positive amount of product.</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>warehous_at_t0</span><span class=p>:</span> <span class=n>Final</span><span class=p>[</span><span class=nb>tuple</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=o>...</span><span class=p>]]</span> <span class=o>=</span> <span class=n>_make_in_warehouse</span><span class=p>(</span>
            <span class=n>n_products</span><span class=p>,</span> <span class=n>warehous_at_t0</span><span class=p>,</span> <span class=n>cache</span><span class=p>)</span>

        <span class=c1>#: The per-station unit production times for each product.</span>
        <span class=c1>#: Each station can have different production times per product.</span>
        <span class=c1>#: Let's say that this is tuple `A`.</span>
        <span class=c1>#: For each product, it has a tuple `B` at the index of the product</span>
        <span class=c1>#: id.</span>
        <span class=c1>#: If the product does not pass through the station, `B` is empty.</span>
        <span class=c1>#: Otherwise, it holds one or multiple tuples `C`.</span>
        <span class=c1>#: Each tuple `C` consists of two numbers:</span>
        <span class=c1>#: A per-unit-production time for the product.</span>
        <span class=c1>#: An end time index for this production time.</span>
        <span class=c1>#: Once the real time surpasses the end time of the last of these</span>
        <span class=c1>#: production specs, the production specs are recycled and begin</span>
        <span class=c1>#: again.</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>station_product_unit_times</span><span class=p>:</span> <span class=n>Final</span><span class=p>[</span><span class=nb>tuple</span><span class=p>[</span><span class=nb>tuple</span><span class=p>[</span>
            <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>,</span> <span class=o>...</span><span class=p>],</span> <span class=o>...</span><span class=p>]]</span> <span class=o>=</span> <span class=n>_make_station_product_unit_times</span><span class=p>(</span>
            <span class=n>n_products</span><span class=p>,</span> <span class=n>n_stations</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>routes</span><span class=p>,</span> <span class=n>station_product_unit_times</span><span class=p>,</span>
            <span class=n>cache</span><span class=p>)</span>

        <span class=c1>#: Additional information about the nature of the instance can be</span>
        <span class=c1>#: stored here. This has no impact on the behavior of the instance,</span>
        <span class=c1>#: but it may explain, e.g., settings of an instance generator.</span>
        <span class=c1>#: The module :mod:`~moptipyapps.prodsched.mfc_generator` which is</span>
        <span class=c1>#: used to randomly generate instances, for example, makes use of this</span>
        <span class=c1>#: data to store the random number seed as well as the distributions</span>
        <span class=c1>#: that were used to create the instances.</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>infos</span><span class=p>:</span> <span class=n>Final</span><span class=p>[</span><span class=n>Mapping</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=nb>str</span><span class=p>]]</span> <span class=o>=</span> <span class=n>_make_infos</span><span class=p>(</span><span class=n>infos</span><span class=p>)</span>

    <span class=k>def</span><span class=w> </span><span class=fm>__str__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<span class=w>        </span><span class=sd>"""</span>
<span class=sd>        Get the name of this instance.</span>

<span class=sd>        :return: the name of this instance</span>
<span class=sd>        """</span>
        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>name</span>

    <span class=k>def</span><span class=w> </span><span class=nf>_tuple</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-></span> <span class=nb>tuple</span><span class=p>:</span>
<span class=w>        </span><span class=sd>"""</span>
<span class=sd>        Convert this object to a tuple.</span>

<span class=sd>        :return: the tuple</span>

<span class=sd>        >>> Instance(name="test1", n_products=1, n_customers=1, n_stations=2,</span>
<span class=sd>        ...         n_demands=1, time_end_warmup=12, time_end_measure=30,</span>
<span class=sd>        ...         routes=[[0, 1]], demands=[[0, 0, 0, 10, 20, 100]],</span>
<span class=sd>        ...         warehous_at_t0=[0],</span>
<span class=sd>        ...     station_product_unit_times=[[[10.0, 10000.0]],</span>
<span class=sd>        ...                                 [[30.0, 10000.0]]])._tuple()</span>
<span class=sd>        ('test1', 2, 1, 1, 1, 12.0, 30.0, (Demand(arrival=20.0,\</span>
<span class=sd> deadline=100.0, demand_id=0, customer_id=0, product_id=0, amount=10,\</span>
<span class=sd> measure=True),), ((0, 1),), (0,), (), ((10.0, 10000.0), (30.0, 10000.0)))</span>
<span class=sd>        """</span>
        <span class=k>return</span> <span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>name</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>n_stations</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>n_products</span><span class=p>,</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>n_demands</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>n_customers</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>time_end_warmup</span><span class=p>,</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>time_end_measure</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>demands</span><span class=p>,</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>routes</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>warehous_at_t0</span><span class=p>,</span> <span class=nb>tuple</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>infos</span><span class=o>.</span><span class=n>items</span><span class=p>()),</span>
                <span class=nb>tuple</span><span class=p>(</span><span class=nb>tuple</span><span class=p>(</span><span class=nb>float</span><span class=p>(</span><span class=n>x</span><span class=p>)</span> <span class=k>for</span> <span class=n>x</span> <span class=ow>in</span> <span class=n>a2</span><span class=p>)</span> <span class=k>for</span> <span class=n>a1</span> <span class=ow>in</span>
                      <span class=bp>self</span><span class=o>.</span><span class=n>station_product_unit_times</span> <span class=k>for</span> <span class=n>a2</span> <span class=ow>in</span> <span class=n>a1</span><span class=p>))</span>

    <span class=k>def</span><span class=w> </span><span class=fm>__eq__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>other</span><span class=p>):</span>
<span class=w>        </span><span class=sd>"""</span>
<span class=sd>        Compare this object with another object.</span>

<span class=sd>        :param other: the other object</span>
<span class=sd>        :return: `NotImplemented` if the other object is not an `Instance`,</span>
<span class=sd>            otherwise the equality comparison result.</span>

<span class=sd>        >>> i1 = Instance(name="test1", n_products=1, n_customers=1,</span>
<span class=sd>        ...         n_stations=2, n_demands=1,</span>
<span class=sd>        ...         time_end_warmup=12, time_end_measure=30,</span>
<span class=sd>        ...         routes=[[0, 1]],</span>
<span class=sd>        ...         demands=[[0, 0, 0, 10, 20, 100]],</span>
<span class=sd>        ...         warehous_at_t0=[0],</span>
<span class=sd>        ...     station_product_unit_times=[[[10.0, 10000.0]],</span>
<span class=sd>        ...                                 [[30.0, 10000.0]]])</span>
<span class=sd>        >>> i2 = Instance(name="test1", n_products=1, n_customers=1,</span>
<span class=sd>        ...         n_stations=2, n_demands=1,</span>
<span class=sd>        ...         time_end_warmup=12, time_end_measure=30,</span>
<span class=sd>        ...         routes=[[0, 1]],</span>
<span class=sd>        ...         demands=[[0, 0, 0, 10, 20, 100]],</span>
<span class=sd>        ...         warehous_at_t0=[0],</span>
<span class=sd>        ...     station_product_unit_times=[[[10.0, 10000.0]],</span>
<span class=sd>        ...                                 [[30.0, 10000.0]]])</span>
<span class=sd>        >>> i1 == i2</span>
<span class=sd>        True</span>
<span class=sd>        >>> i3 = Instance(name="test1", n_products=1, n_customers=1,</span>
<span class=sd>        ...         n_stations=2, n_demands=1,</span>
<span class=sd>        ...         time_end_warmup=12, time_end_measure=30,</span>
<span class=sd>        ...         routes=[[0, 1]],</span>
<span class=sd>        ...         demands=[[0, 0, 0, 10, 20, 100]],</span>
<span class=sd>        ...         warehous_at_t0=[0],</span>
<span class=sd>        ...     station_product_unit_times=[[[10.0, 10000.1]],</span>
<span class=sd>        ...                                 [[30.0, 10000.0]]])</span>
<span class=sd>        >>> i1 == i3</span>
<span class=sd>        False</span>
<span class=sd>        """</span>
        <span class=k>if</span> <span class=n>other</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
            <span class=k>return</span> <span class=kc>False</span>
        <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>other</span><span class=p>,</span> <span class=n>Instance</span><span class=p>):</span>
            <span class=k>return</span> <span class=bp>NotImplemented</span>
        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tuple</span><span class=p>()</span> <span class=o>==</span> <span class=n>cast</span><span class=p>(</span><span class=s2>"Instance"</span><span class=p>,</span> <span class=n>other</span><span class=p>)</span><span class=o>.</span><span class=n>_tuple</span><span class=p>()</span>

    <span class=k>def</span><span class=w> </span><span class=fm>__hash__</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-></span> <span class=nb>int</span><span class=p>:</span>
<span class=w>        </span><span class=sd>"""</span>
<span class=sd>        Get the hash code of this object.</span>

<span class=sd>        :return: the hash code of this object</span>
<span class=sd>        """</span>
        <span class=k>return</span> <span class=nb>hash</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_tuple</span><span class=p>())</span></div>



<span class=c1>#: the instance name key</span>
<span class=n>KEY_NAME</span><span class=p>:</span> <span class=n>Final</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=s2>"name"</span>
<span class=c1>#: the key for the number of products</span>
<span class=n>KEY_N_PRODUCTS</span><span class=p>:</span> <span class=n>Final</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=s2>"n_products"</span>
<span class=c1>#: the key for the number of customers</span>
<span class=n>KEY_N_CUSTOMERS</span><span class=p>:</span> <span class=n>Final</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=s2>"n_customers"</span>
<span class=c1>#: the key for the number of stations</span>
<span class=n>KEY_N_STATIONS</span><span class=p>:</span> <span class=n>Final</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=s2>"n_stations"</span>
<span class=c1>#: the number of demands in the scenario</span>
<span class=n>KEY_N_DEMANDS</span><span class=p>:</span> <span class=n>Final</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=s2>"n_demands"</span>
<span class=c1>#: the end of the warmup period</span>
<span class=n>KEY_TIME_END_WARMUP</span><span class=p>:</span> <span class=n>Final</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=s2>"time_end_warmup"</span>
<span class=c1>#: the end of the measure period</span>
<span class=n>KEY_TIME_END_MEASURE</span><span class=p>:</span> <span class=n>Final</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=s2>"time_end_measure"</span>
<span class=c1>#: the start of a key index</span>
<span class=n>KEY_IDX_START</span><span class=p>:</span> <span class=n>Final</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=s2>"["</span>
<span class=c1>#: the end of a key index</span>
<span class=n>KEY_IDX_END</span><span class=p>:</span> <span class=n>Final</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=s2>"]"</span>
<span class=c1>#: the first part of the product route key</span>
<span class=n>KEY_ROUTE</span><span class=p>:</span> <span class=n>Final</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=s2>"product_route"</span>
<span class=c1>#: the first part of the demand key</span>
<span class=n>KEY_DEMAND</span><span class=p>:</span> <span class=n>Final</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=s2>"demand"</span>
<span class=c1>#: The amount of products in the warehouse at time step 0.</span>
<span class=n>KEY_IN_WAREHOUSE</span><span class=p>:</span> <span class=n>Final</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=s2>"products_in_warehouse_at_t0"</span>
<span class=c1>#: the first part of the production time</span>
<span class=n>KEY_PRODUCTION_TIME</span><span class=p>:</span> <span class=n>Final</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=s2>"production_time"</span>

<span class=c1>#: the key value split string</span>
<span class=n>_KEY_VALUE_SPLIT</span><span class=p>:</span> <span class=n>Final</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=nb>str</span><span class=o>.</span><span class=n>strip</span><span class=p>(</span><span class=n>KEY_VALUE_SEPARATOR</span><span class=p>)</span>

<span class=c1>#: the forbidden keys</span>
<span class=n>__FORBIDDEN_INFO_KEYS</span><span class=p>:</span> <span class=n>Final</span><span class=p>[</span><span class=n>Callable</span><span class=p>[[</span><span class=nb>str</span><span class=p>],</span> <span class=nb>bool</span><span class=p>]]</span> <span class=o>=</span> <span class=p>{</span>
    <span class=n>KEY_NAME</span><span class=p>,</span> <span class=n>KEY_N_PRODUCTS</span><span class=p>,</span> <span class=n>KEY_N_CUSTOMERS</span><span class=p>,</span> <span class=n>KEY_N_STATIONS</span><span class=p>,</span>
    <span class=n>KEY_N_DEMANDS</span><span class=p>,</span> <span class=n>KEY_TIME_END_MEASURE</span><span class=p>,</span> <span class=n>KEY_TIME_END_WARMUP</span><span class=p>,</span>
    <span class=n>KEY_ROUTE</span><span class=p>,</span> <span class=n>KEY_DEMAND</span><span class=p>,</span> <span class=n>KEY_IN_WAREHOUSE</span><span class=p>,</span> <span class=n>KEY_PRODUCTION_TIME</span><span class=p>}</span><span class=o>.</span><span class=fm>__contains__</span>

<span class=c1>#: the allowed information key characters</span>
<span class=n>__ALLOWED_INFO_KEY_CHARS</span><span class=p>:</span> <span class=n>Final</span><span class=p>[</span><span class=n>Callable</span><span class=p>[[</span><span class=nb>str</span><span class=p>],</span> <span class=nb>bool</span><span class=p>]]</span> <span class=o>=</span> <span class=nb>set</span><span class=p>(</span>
    <span class=n>ascii_letters</span> <span class=o>+</span> <span class=n>digits</span> <span class=o>+</span> <span class=s2>"_."</span> <span class=o>+</span> <span class=n>KEY_IDX_START</span> <span class=o>+</span> <span class=n>KEY_IDX_END</span><span class=p>)</span><span class=o>.</span><span class=fm>__contains__</span>

<span class=c1>#: the allowed characters in names</span>
<span class=n>_ALLOWED_NAME_CHARS</span><span class=p>:</span> <span class=n>Final</span><span class=p>[</span><span class=n>Callable</span><span class=p>[[</span><span class=nb>str</span><span class=p>],</span> <span class=nb>bool</span><span class=p>]]</span> <span class=o>=</span> <span class=nb>set</span><span class=p>(</span>
    <span class=n>ascii_letters</span> <span class=o>+</span> <span class=n>digits</span> <span class=o>+</span> <span class=s2>"_"</span><span class=p>)</span><span class=o>.</span><span class=fm>__contains__</span>


<div class=viewcode-block id=to_stream>
<a class=viewcode-back href=../../../moptipyapps.prodsched.html#moptipyapps.prodsched.instance.to_stream>[docs]</a>
<span class=k>def</span><span class=w> </span><span class=nf>to_stream</span><span class=p>(</span><span class=n>instance</span><span class=p>:</span> <span class=n>Instance</span><span class=p>)</span> <span class=o>-></span> <span class=n>Generator</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=kc>None</span><span class=p>,</span> <span class=kc>None</span><span class=p>]:</span>
<span class=w>    </span><span class=sd>"""</span>
<span class=sd>    Convert an instance to a stream of data.</span>

<span class=sd>    :param instance: the instance to convert to a stream</span>
<span class=sd>    :return: the stream of data</span>
<span class=sd>    """</span>
    <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>instance</span><span class=p>,</span> <span class=n>Instance</span><span class=p>):</span>
        <span class=k>raise</span> <span class=n>type_error</span><span class=p>(</span><span class=n>instance</span><span class=p>,</span> <span class=s2>"instance"</span><span class=p>,</span> <span class=n>Instance</span><span class=p>)</span>

    <span class=k>yield</span> <span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>COMMENT_START</span><span class=si>}</span><span class=s2> --- the data of instance </span><span class=si>{</span><span class=n>instance</span><span class=o>.</span><span class=n>name</span><span class=si>!r}</span><span class=s2> ---"</span>
    <span class=k>yield</span> <span class=n>COMMENT_START</span>
    <span class=k>yield</span> <span class=p>(</span><span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>COMMENT_START</span><span class=si>}</span><span class=s2> Lines beginning with </span><span class=si>{</span><span class=n>COMMENT_START</span><span class=si>!r}</span><span class=s2> are "</span>
           <span class=sa>f</span><span class=s2>"comments."</span><span class=p>)</span>
    <span class=k>yield</span> <span class=n>COMMENT_START</span>
    <span class=k>yield</span> <span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>COMMENT_START</span><span class=si>}</span><span class=s2> the unique identifying name of the instance"</span>
    <span class=k>yield</span> <span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>KEY_NAME</span><span class=si>}{</span><span class=n>KEY_VALUE_SEPARATOR</span><span class=si>}{</span><span class=n>instance</span><span class=o>.</span><span class=n>name</span><span class=si>}</span><span class=s2>"</span>
    <span class=k>yield</span> <span class=n>COMMENT_START</span>
    <span class=k>yield</span> <span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>COMMENT_START</span><span class=si>}</span><span class=s2> the number of products in the instance, > 0"</span>
    <span class=k>yield</span> <span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>KEY_N_PRODUCTS</span><span class=si>}{</span><span class=n>KEY_VALUE_SEPARATOR</span><span class=si>}{</span><span class=n>instance</span><span class=o>.</span><span class=n>n_products</span><span class=si>}</span><span class=s2>"</span>
    <span class=k>yield</span> <span class=p>(</span><span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>COMMENT_START</span><span class=si>}</span><span class=s2> Valid product indices are in 0.."</span>
           <span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>instance</span><span class=o>.</span><span class=n>n_products</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>1</span><span class=si>}</span><span class=s2>."</span><span class=p>)</span>
    <span class=k>yield</span> <span class=n>COMMENT_START</span>
    <span class=k>yield</span> <span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>COMMENT_START</span><span class=si>}</span><span class=s2> the number of customers in the instance, > 0"</span>
    <span class=k>yield</span> <span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>KEY_N_CUSTOMERS</span><span class=si>}{</span><span class=n>KEY_VALUE_SEPARATOR</span><span class=si>}{</span><span class=n>instance</span><span class=o>.</span><span class=n>n_customers</span><span class=si>}</span><span class=s2>"</span>
    <span class=k>yield</span> <span class=p>(</span><span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>COMMENT_START</span><span class=si>}</span><span class=s2> Valid customer indices are in 0.."</span>
           <span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>instance</span><span class=o>.</span><span class=n>n_customers</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>1</span><span class=si>}</span><span class=s2>."</span><span class=p>)</span>
    <span class=k>yield</span> <span class=n>COMMENT_START</span>
    <span class=k>yield</span> <span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>COMMENT_START</span><span class=si>}</span><span class=s2> the number of stations in the instance, > 0"</span>
    <span class=k>yield</span> <span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>KEY_N_STATIONS</span><span class=si>}{</span><span class=n>KEY_VALUE_SEPARATOR</span><span class=si>}{</span><span class=n>instance</span><span class=o>.</span><span class=n>n_stations</span><span class=si>}</span><span class=s2>"</span>
    <span class=k>yield</span> <span class=p>(</span><span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>COMMENT_START</span><span class=si>}</span><span class=s2> Valid station indices are in 0.."</span>
           <span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>instance</span><span class=o>.</span><span class=n>n_stations</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>1</span><span class=si>}</span><span class=s2>."</span><span class=p>)</span>
    <span class=k>yield</span> <span class=n>COMMENT_START</span>
    <span class=k>yield</span> <span class=p>(</span><span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>COMMENT_START</span><span class=si>}</span><span class=s2> the number of customer orders (demands) issued "</span>
           <span class=sa>f</span><span class=s2>"by the customers, > 0"</span><span class=p>)</span>
    <span class=k>yield</span> <span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>KEY_N_DEMANDS</span><span class=si>}{</span><span class=n>KEY_VALUE_SEPARATOR</span><span class=si>}{</span><span class=n>instance</span><span class=o>.</span><span class=n>n_demands</span><span class=si>}</span><span class=s2>"</span>
    <span class=k>yield</span> <span class=p>(</span><span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>COMMENT_START</span><span class=si>}</span><span class=s2> Valid demand/order indices are in 0.."</span>
           <span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>instance</span><span class=o>.</span><span class=n>n_demands</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>1</span><span class=si>}</span><span class=s2>."</span><span class=p>)</span>
    <span class=k>yield</span> <span class=n>COMMENT_START</span>
    <span class=k>yield</span> <span class=p>(</span><span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>COMMENT_START</span><span class=si>}</span><span class=s2> end of the warmup period in the simulations, "</span>
           <span class=sa>f</span><span class=s2>">= 0"</span><span class=p>)</span>
    <span class=n>wm</span><span class=p>:</span> <span class=n>Final</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=n>float_to_str</span><span class=p>(</span><span class=n>instance</span><span class=o>.</span><span class=n>time_end_warmup</span><span class=p>)</span>
    <span class=k>yield</span> <span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>KEY_TIME_END_WARMUP</span><span class=si>}{</span><span class=n>KEY_VALUE_SEPARATOR</span><span class=si>}{</span><span class=n>wm</span><span class=si>}</span><span class=s2>"</span>
    <span class=k>yield</span> <span class=p>(</span><span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>COMMENT_START</span><span class=si>}</span><span class=s2> The simulation will not measure anything "</span>
           <span class=sa>f</span><span class=s2>"during the first </span><span class=si>{</span><span class=n>wm</span><span class=si>}</span><span class=s2> time units."</span><span class=p>)</span>
    <span class=k>yield</span> <span class=n>COMMENT_START</span>
    <span class=k>yield</span> <span class=p>(</span><span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>COMMENT_START</span><span class=si>}</span><span class=s2> end of the measurement period in the "</span>
           <span class=sa>f</span><span class=s2>"simulations, > </span><span class=si>{</span><span class=n>wm</span><span class=si>}</span><span class=s2>"</span><span class=p>)</span>
    <span class=n>meas</span><span class=p>:</span> <span class=n>Final</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=n>float_to_str</span><span class=p>(</span><span class=n>instance</span><span class=o>.</span><span class=n>time_end_measure</span><span class=p>)</span>
    <span class=k>yield</span> <span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>KEY_TIME_END_MEASURE</span><span class=si>}{</span><span class=n>KEY_VALUE_SEPARATOR</span><span class=si>}{</span><span class=n>meas</span><span class=si>}</span><span class=s2>"</span>
    <span class=k>yield</span> <span class=p>(</span><span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>COMMENT_START</span><span class=si>}</span><span class=s2> The simulation will only measure things during "</span>
           <span class=sa>f</span><span class=s2>" left-closed and right-open interval [</span><span class=si>{</span><span class=n>wm</span><span class=si>}</span><span class=s2>,</span><span class=si>{</span><span class=n>meas</span><span class=si>}</span><span class=s2>)."</span><span class=p>)</span>

    <span class=k>yield</span> <span class=n>COMMENT_START</span>
    <span class=k>yield</span> <span class=p>(</span><span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>COMMENT_START</span><span class=si>}</span><span class=s2> For each product, we now specify the indices of "</span>
           <span class=sa>f</span><span class=s2>"the stations by which it will be processed, in the order in "</span>
           <span class=sa>f</span><span class=s2>"which it will be processed by them."</span><span class=p>)</span>
    <span class=k>yield</span> <span class=p>(</span><span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>COMMENT_START</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=n>KEY_ROUTE</span><span class=si>}{</span><span class=n>KEY_IDX_START</span><span class=si>}</span><span class=s2>0"</span>
           <span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>KEY_IDX_END</span><span class=si>}</span><span class=s2> is the production route by the first product, "</span>
           <span class=s2>"which has index 0."</span><span class=p>)</span>
    <span class=n>route_0</span><span class=p>:</span> <span class=nb>tuple</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=o>...</span><span class=p>]</span> <span class=o>=</span> <span class=n>instance</span><span class=o>.</span><span class=n>routes</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
    <span class=k>yield</span> <span class=p>(</span><span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>COMMENT_START</span><span class=si>}</span><span class=s2> This product is processed by "</span>
           <span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=nb>tuple</span><span class=o>.</span><span class=fm>__len__</span><span class=p>(</span><span class=n>route_0</span><span class=p>)</span><span class=si>}</span><span class=s2> stations, namely first by the "</span>
           <span class=sa>f</span><span class=s2>"station with index </span><span class=si>{</span><span class=nb>int</span><span class=p>(</span><span class=n>route_0</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span><span class=si>}</span><span class=s2> and last by the station "</span>
           <span class=sa>f</span><span class=s2>"with index </span><span class=si>{</span><span class=nb>int</span><span class=p>(</span><span class=n>route_0</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>])</span><span class=si>}</span><span class=s2>."</span><span class=p>)</span>
    <span class=k>for</span> <span class=n>p</span><span class=p>,</span> <span class=n>route</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>instance</span><span class=o>.</span><span class=n>routes</span><span class=p>):</span>
        <span class=k>yield</span> <span class=p>(</span><span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>KEY_ROUTE</span><span class=si>}{</span><span class=n>KEY_IDX_START</span><span class=si>}{</span><span class=n>p</span><span class=si>}{</span><span class=n>KEY_IDX_END</span><span class=si>}</span><span class=s2>"</span>
               <span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>KEY_VALUE_SEPARATOR</span><span class=si>}</span><span class=s2>"</span>
               <span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>CSV_SEPARATOR</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=nb>map</span><span class=p>(</span><span class=nb>str</span><span class=p>,</span><span class=w> </span><span class=n>route</span><span class=p>))</span><span class=si>}</span><span class=s2>"</span><span class=p>)</span>

    <span class=k>yield</span> <span class=n>COMMENT_START</span>
    <span class=k>yield</span> <span class=p>(</span><span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>COMMENT_START</span><span class=si>}</span><span class=s2> For each customer order/demand, we now "</span>
           <span class=sa>f</span><span class=s2>"specify the following values:"</span><span class=p>)</span>
    <span class=k>yield</span> <span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>COMMENT_START</span><span class=si>}</span><span class=s2> 1. the demand ID in square brackets"</span>
    <span class=k>yield</span> <span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>COMMENT_START</span><span class=si>}</span><span class=s2> 2. the ID of the customer who made the order"</span>
    <span class=k>yield</span> <span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>COMMENT_START</span><span class=si>}</span><span class=s2> 3. the ID of the product that the customer ordered"</span>
    <span class=k>yield</span> <span class=p>(</span><span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>COMMENT_START</span><span class=si>}</span><span class=s2> 4. the amount of the product that the customer"</span>
           <span class=s2>" ordered"</span><span class=p>)</span>
    <span class=k>yield</span> <span class=p>(</span><span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>COMMENT_START</span><span class=si>}</span><span class=s2> 5. the arrival time of the demand, > 0, i.e., "</span>
           <span class=sa>f</span><span class=s2>"the moment in time when the customer informed us that they want "</span>
           <span class=sa>f</span><span class=s2>"the product"</span><span class=p>)</span>
    <span class=k>yield</span> <span class=p>(</span><span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>COMMENT_START</span><span class=si>}</span><span class=s2> 6. the deadline, i.e., when the customer expects "</span>
           <span class=sa>f</span><span class=s2>"the product, >= arrival time"</span><span class=p>)</span>
    <span class=n>srt</span><span class=p>:</span> <span class=nb>list</span><span class=p>[</span><span class=n>Demand</span><span class=p>]</span> <span class=o>=</span> <span class=nb>sorted</span><span class=p>(</span><span class=n>instance</span><span class=o>.</span><span class=n>demands</span><span class=p>,</span> <span class=n>key</span><span class=o>=</span><span class=k>lambda</span> <span class=n>d</span><span class=p>:</span> <span class=n>d</span><span class=o>.</span><span class=n>demand_id</span><span class=p>)</span>
    <span class=n>fd</span><span class=p>:</span> <span class=n>Demand</span> <span class=o>=</span> <span class=n>srt</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
    <span class=k>yield</span> <span class=p>(</span><span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>COMMENT_START</span><span class=si>}</span><span class=s2> For example, the demand with ID </span><span class=si>{</span><span class=n>fd</span><span class=o>.</span><span class=n>demand_id</span><span class=si>}</span><span class=s2> "</span>
           <span class=sa>f</span><span class=s2>"was issued by the customer with ID </span><span class=si>{</span><span class=n>fd</span><span class=o>.</span><span class=n>customer_id</span><span class=si>}</span><span class=s2> for "</span>
           <span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>fd</span><span class=o>.</span><span class=n>amount</span><span class=si>}</span><span class=s2> units of the product with ID "</span>
           <span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>fd</span><span class=o>.</span><span class=n>product_id</span><span class=si>}</span><span class=s2>."</span><span class=p>)</span>
    <span class=k>yield</span> <span class=p>(</span><span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>COMMENT_START</span><span class=si>}</span><span class=s2> The order comes into the "</span>
           <span class=sa>f</span><span class=s2>"system at time unit </span><span class=si>{</span><span class=n>fd</span><span class=o>.</span><span class=n>arrival</span><span class=si>}</span><span class=s2> and the customer expects "</span>
           <span class=sa>f</span><span class=s2>"the product to be ready at time unit </span><span class=si>{</span><span class=n>fd</span><span class=o>.</span><span class=n>deadline</span><span class=si>}</span><span class=s2>."</span><span class=p>)</span>
    <span class=k>for</span> <span class=n>demand</span> <span class=ow>in</span> <span class=n>srt</span><span class=p>:</span>
        <span class=n>it</span> <span class=o>=</span> <span class=nb>iter</span><span class=p>(</span><span class=n>demand</span><span class=p>)</span>
        <span class=nb>next</span><span class=p>(</span><span class=n>it</span><span class=p>)</span>  <span class=c1># pylint: disable=R1708</span>
        <span class=n>row</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=n>CSV_SEPARATOR</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=nb>map</span><span class=p>(</span><span class=n>num_to_str</span><span class=p>,</span> <span class=n>it</span><span class=p>))</span>
        <span class=k>yield</span> <span class=p>(</span><span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>KEY_DEMAND</span><span class=si>}{</span><span class=n>KEY_IDX_START</span><span class=si>}{</span><span class=n>demand</span><span class=o>.</span><span class=n>demand_id</span><span class=si>}{</span><span class=n>KEY_IDX_END</span><span class=si>}</span><span class=s2>"</span>
               <span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>KEY_VALUE_SEPARATOR</span><span class=si>}</span><span class=s2>"</span>
               <span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>row</span><span class=si>}</span><span class=s2>"</span><span class=p>)</span>

    <span class=k>yield</span> <span class=n>COMMENT_START</span>
    <span class=k>yield</span> <span class=p>(</span><span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>COMMENT_START</span><span class=si>}</span><span class=s2> For each product, we now specify the amount "</span>
           <span class=sa>f</span><span class=s2>"that is in the warehouse at time step 0."</span><span class=p>)</span>
    <span class=k>yield</span> <span class=p>(</span><span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>COMMENT_START</span><span class=si>}</span><span class=s2> For example, there are "</span>
           <span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>instance</span><span class=o>.</span><span class=n>warehous_at_t0</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=si>}</span><span class=s2> units of product 0 in the "</span>
           <span class=sa>f</span><span class=s2>"warehouse at the beginning of the simulation."</span><span class=p>)</span>
    <span class=k>yield</span> <span class=p>(</span><span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>KEY_IN_WAREHOUSE</span><span class=si>}{</span><span class=n>KEY_VALUE_SEPARATOR</span><span class=si>}</span><span class=s2>"</span>
           <span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>CSV_SEPARATOR</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=nb>map</span><span class=p>(</span><span class=nb>str</span><span class=p>,</span><span class=w> </span><span class=n>instance</span><span class=o>.</span><span class=n>warehous_at_t0</span><span class=p>))</span><span class=si>}</span><span class=s2>"</span><span class=p>)</span>

    <span class=k>yield</span> <span class=n>COMMENT_START</span>
    <span class=k>yield</span> <span class=p>(</span><span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>COMMENT_START</span><span class=si>}</span><span class=s2> For each station, we now specify the production "</span>
           <span class=sa>f</span><span class=s2>"times for each product that passes through the station."</span><span class=p>)</span>
    <span class=n>empty_pdx</span><span class=p>:</span> <span class=nb>tuple</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>int</span><span class=p>]</span> <span class=o>|</span> <span class=kc>None</span> <span class=o>=</span> <span class=kc>None</span>
    <span class=n>filled_pdx</span><span class=p>:</span> <span class=nb>tuple</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>int</span><span class=p>,</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>]</span> <span class=o>|</span> <span class=kc>None</span> <span class=o>=</span> <span class=kc>None</span>
    <span class=n>need</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>2</span>
    <span class=k>for</span> <span class=n>mid</span><span class=p>,</span> <span class=n>station</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>instance</span><span class=o>.</span><span class=n>station_product_unit_times</span><span class=p>):</span>
        <span class=k>for</span> <span class=n>pid</span><span class=p>,</span> <span class=n>product</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>station</span><span class=p>):</span>
            <span class=n>pdl</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=o>.</span><span class=fm>__len__</span><span class=p>(</span><span class=n>product</span><span class=p>)</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>pdl</span> <span class=o><=</span> <span class=mi>0</span><span class=p>)</span> <span class=ow>and</span> <span class=p>(</span><span class=n>empty_pdx</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>):</span>
                <span class=n>empty_pdx</span> <span class=o>=</span> <span class=n>mid</span><span class=p>,</span> <span class=n>pid</span>
                <span class=n>need</span> <span class=o>-=</span> <span class=mi>1</span>
                <span class=k>if</span> <span class=n>need</span> <span class=o><=</span> <span class=mi>0</span><span class=p>:</span>
                    <span class=k>break</span>
            <span class=k>elif</span> <span class=p>(</span><span class=n>pdl</span> <span class=o>></span> <span class=mi>0</span><span class=p>)</span> <span class=ow>and</span> <span class=p>(</span><span class=n>filled_pdx</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>):</span>
                <span class=n>filled_pdx</span> <span class=o>=</span> <span class=n>mid</span><span class=p>,</span> <span class=n>pid</span><span class=p>,</span> <span class=n>product</span>
                <span class=n>need</span> <span class=o>-=</span> <span class=mi>1</span>
                <span class=k>if</span> <span class=n>need</span> <span class=o><=</span> <span class=mi>0</span><span class=p>:</span>
                    <span class=k>break</span>
        <span class=k>if</span> <span class=n>need</span> <span class=o><=</span> <span class=mi>0</span><span class=p>:</span>
            <span class=k>break</span>
    <span class=k>if</span> <span class=n>empty_pdx</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
        <span class=k>yield</span> <span class=p>(</span><span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>COMMENT_START</span><span class=si>}</span><span class=s2> For example, product </span><span class=si>{</span><span class=n>empty_pdx</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=si>}</span><span class=s2> does "</span>
               <span class=sa>f</span><span class=s2>"not pass through station </span><span class=si>{</span><span class=n>empty_pdx</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=si>}</span><span class=s2>, so it is not "</span>
               <span class=s2>"listed here."</span><span class=p>)</span>
    <span class=k>if</span> <span class=n>filled_pdx</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
        <span class=k>yield</span> <span class=p>(</span><span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>COMMENT_START</span><span class=si>}</span><span class=s2> For example, one unit of product "</span>
               <span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>filled_pdx</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=si>}</span><span class=s2> passes through station </span><span class=si>{</span><span class=n>filled_pdx</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=si>}</span><span class=s2>."</span><span class=p>)</span>
        <span class=k>yield</span> <span class=p>(</span><span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>COMMENT_START</span><span class=si>}</span><span class=s2> There, it needs </span><span class=si>{</span><span class=n>filled_pdx</span><span class=p>[</span><span class=mi>2</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span><span class=si>}</span><span class=s2> time "</span>
               <span class=sa>f</span><span class=s2>"units per product unit from t=0 to t=</span><span class=si>{</span><span class=n>filled_pdx</span><span class=p>[</span><span class=mi>2</span><span class=p>][</span><span class=mi>1</span><span class=p>]</span><span class=si>}</span><span class=s2>."</span><span class=p>)</span>
        <span class=k>if</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=o>.</span><span class=fm>__len__</span><span class=p>(</span><span class=n>filled_pdx</span><span class=p>[</span><span class=mi>2</span><span class=p>])</span> <span class=o>></span> <span class=mi>2</span><span class=p>:</span>
            <span class=k>yield</span> <span class=p>(</span><span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>COMMENT_START</span><span class=si>}</span><span class=s2> After that, it needs </span><span class=si>{</span><span class=n>filled_pdx</span><span class=p>[</span><span class=mi>2</span><span class=p>][</span><span class=mi>2</span><span class=p>]</span><span class=si>}</span><span class=s2>"</span>
                   <span class=s2>" time units per product unit until t="</span>
                   <span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>filled_pdx</span><span class=p>[</span><span class=mi>2</span><span class=p>][</span><span class=mi>3</span><span class=p>]</span><span class=si>}</span><span class=s2>."</span><span class=p>)</span>

    <span class=n>cache</span><span class=p>:</span> <span class=nb>dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=p>{}</span>
    <span class=k>for</span> <span class=n>mid</span><span class=p>,</span> <span class=n>station</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>instance</span><span class=o>.</span><span class=n>station_product_unit_times</span><span class=p>):</span>
        <span class=k>for</span> <span class=n>pid</span><span class=p>,</span> <span class=n>product</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>station</span><span class=p>):</span>
            <span class=k>if</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=o>.</span><span class=fm>__len__</span><span class=p>(</span><span class=n>product</span><span class=p>)</span> <span class=o><=</span> <span class=mi>0</span><span class=p>:</span>
                <span class=k>continue</span>
            <span class=n>value</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=n>CSV_SEPARATOR</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=nb>map</span><span class=p>(</span><span class=n>num_to_str</span><span class=p>,</span> <span class=nb>map</span><span class=p>(</span>
                <span class=n>try_int</span><span class=p>,</span> <span class=nb>map</span><span class=p>(</span><span class=nb>float</span><span class=p>,</span> <span class=n>product</span><span class=p>))))</span>
            <span class=n>key</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=p>(</span><span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>KEY_PRODUCTION_TIME</span><span class=si>}{</span><span class=n>KEY_IDX_START</span><span class=si>}{</span><span class=n>mid</span><span class=si>}</span><span class=s2>"</span>
                        <span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>CSV_SEPARATOR</span><span class=si>}{</span><span class=n>pid</span><span class=si>}{</span><span class=n>KEY_IDX_END</span><span class=si>}</span><span class=s2>"</span><span class=p>)</span>
            <span class=k>if</span> <span class=n>value</span> <span class=ow>in</span> <span class=n>cache</span><span class=p>:</span>
                <span class=n>value</span> <span class=o>=</span> <span class=n>cache</span><span class=p>[</span><span class=n>value</span><span class=p>]</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>cache</span><span class=p>[</span><span class=n>value</span><span class=p>]</span> <span class=o>=</span> <span class=n>key</span>
            <span class=k>yield</span> <span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>key</span><span class=si>}{</span><span class=n>KEY_VALUE_SEPARATOR</span><span class=si>}{</span><span class=n>value</span><span class=si>}</span><span class=s2>"</span>

    <span class=n>n_infos</span><span class=p>:</span> <span class=n>Final</span><span class=p>[</span><span class=nb>int</span><span class=p>]</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>instance</span><span class=o>.</span><span class=n>infos</span><span class=p>)</span>
    <span class=k>if</span> <span class=n>n_infos</span> <span class=o>></span> <span class=mi>0</span><span class=p>:</span>
        <span class=k>yield</span> <span class=n>COMMENT_START</span>
        <span class=k>yield</span> <span class=p>(</span><span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>COMMENT_START</span><span class=si>}</span><span class=s2> The following </span><span class=si>{</span><span class=n>n_infos</span><span class=si>}</span><span class=s2> key/value pairs "</span>
               <span class=s2>"denote additional information about the instance."</span><span class=p>)</span>
        <span class=k>yield</span> <span class=p>(</span><span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>COMMENT_START</span><span class=si>}</span><span class=s2> They have no impact whatsoever on the "</span>
               <span class=s2>"instance behavior."</span><span class=p>)</span>
        <span class=k>yield</span> <span class=p>(</span><span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>COMMENT_START</span><span class=si>}</span><span class=s2> A common use case is that we may have "</span>
               <span class=s2>"used a method to randomly sample the instance."</span><span class=p>)</span>
        <span class=k>yield</span> <span class=p>(</span><span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>COMMENT_START</span><span class=si>}</span><span class=s2> In this case, we could store the parameters "</span>
               <span class=sa>f</span><span class=s2>"of the instance generator, such as the random seed and/or "</span>
               <span class=sa>f</span><span class=s2>"the distributions used in this section."</span><span class=p>)</span>
        <span class=k>for</span> <span class=n>k</span><span class=p>,</span> <span class=n>v</span> <span class=ow>in</span> <span class=n>instance</span><span class=o>.</span><span class=n>infos</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
            <span class=k>yield</span> <span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>k</span><span class=si>}{</span><span class=n>KEY_VALUE_SEPARATOR</span><span class=si>}{</span><span class=n>v</span><span class=si>}</span><span class=s2>"</span></div>



<span class=k>def</span><span class=w> </span><span class=nf>__get_key_index</span><span class=p>(</span><span class=n>full_key</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-></span> <span class=nb>str</span><span class=p>:</span>
<span class=w>    </span><span class=sd>"""</span>
<span class=sd>    Extract the key index from a key.</span>

<span class=sd>    :param full_key: the full key</span>
<span class=sd>    :return: the key index</span>

<span class=sd>    >>> __get_key_index("s[12 ]")</span>
<span class=sd>    '12'</span>
<span class=sd>    """</span>
    <span class=n>start</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=nb>str</span><span class=o>.</span><span class=n>index</span><span class=p>(</span><span class=n>full_key</span><span class=p>,</span> <span class=n>KEY_IDX_START</span><span class=p>)</span>
    <span class=n>end</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=nb>str</span><span class=o>.</span><span class=n>index</span><span class=p>(</span><span class=n>full_key</span><span class=p>,</span> <span class=n>KEY_IDX_END</span><span class=p>,</span> <span class=n>start</span><span class=p>)</span>
    <span class=k>if</span> <span class=ow>not</span> <span class=mi>0</span> <span class=o><</span> <span class=n>start</span> <span class=o><</span> <span class=n>end</span> <span class=o><</span> <span class=nb>str</span><span class=o>.</span><span class=fm>__len__</span><span class=p>(</span><span class=n>full_key</span><span class=p>):</span>
        <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=sa>f</span><span class=s2>"Invalid key </span><span class=si>{</span><span class=n>full_key</span><span class=si>!r}</span><span class=s2>."</span><span class=p>)</span>
    <span class=n>idx</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=nb>str</span><span class=o>.</span><span class=n>strip</span><span class=p>(</span><span class=n>full_key</span><span class=p>[</span><span class=n>start</span> <span class=o>+</span> <span class=mi>1</span><span class=p>:</span><span class=n>end</span><span class=p>])</span>
    <span class=k>if</span> <span class=nb>str</span><span class=o>.</span><span class=fm>__len__</span><span class=p>(</span><span class=n>idx</span><span class=p>)</span> <span class=o><=</span> <span class=mi>0</span><span class=p>:</span>
        <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=sa>f</span><span class=s2>"Invalid index in key </span><span class=si>{</span><span class=n>full_key</span><span class=si>!r}</span><span class=s2>."</span><span class=p>)</span>
    <span class=k>return</span> <span class=n>idx</span>


<span class=k>def</span><span class=w> </span><span class=nf>__pe</span><span class=p>(</span><span class=n>message</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>oline</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>line_idx</span><span class=p>:</span> <span class=nb>int</span><span class=p>)</span> <span class=o>-></span> <span class=ne>ValueError</span><span class=p>:</span>
<span class=w>    </span><span class=sd>"""</span>
<span class=sd>    Create a value error to be raised inside the parser.</span>

<span class=sd>    :param message: the message</span>
<span class=sd>    :param oline: the original line</span>
<span class=sd>    :param line_idx: the line index</span>
<span class=sd>    :return: the error</span>
<span class=sd>    """</span>
    <span class=k>return</span> <span class=ne>ValueError</span><span class=p>(</span><span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>message</span><span class=si>}</span><span class=s2> at line </span><span class=si>{</span><span class=n>line_idx</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=si>}</span><span class=s2> (</span><span class=si>{</span><span class=n>oline</span><span class=si>!r}</span><span class=s2>)"</span><span class=p>)</span>


<div class=viewcode-block id=from_stream>
<a class=viewcode-back href=../../../moptipyapps.prodsched.html#moptipyapps.prodsched.instance.from_stream>[docs]</a>
<span class=k>def</span><span class=w> </span><span class=nf>from_stream</span><span class=p>(</span><span class=n>stream</span><span class=p>:</span> <span class=n>Iterable</span><span class=p>[</span><span class=nb>str</span><span class=p>])</span> <span class=o>-></span> <span class=n>Instance</span><span class=p>:</span>
<span class=w>    </span><span class=sd>"""</span>
<span class=sd>    Read an instance from a data stream.</span>

<span class=sd>    :param stream: the data stream</span>
<span class=sd>    :return: the instance</span>
<span class=sd>    """</span>
    <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>stream</span><span class=p>,</span> <span class=n>Iterable</span><span class=p>):</span>
        <span class=k>raise</span> <span class=n>type_error</span><span class=p>(</span><span class=n>stream</span><span class=p>,</span> <span class=s2>"stream"</span><span class=p>,</span> <span class=n>Iterable</span><span class=p>)</span>
    <span class=n>name</span><span class=p>:</span> <span class=nb>str</span> <span class=o>|</span> <span class=kc>None</span> <span class=o>=</span> <span class=kc>None</span>
    <span class=n>n_products</span><span class=p>:</span> <span class=nb>int</span> <span class=o>|</span> <span class=kc>None</span> <span class=o>=</span> <span class=kc>None</span>
    <span class=n>n_customers</span><span class=p>:</span> <span class=nb>int</span> <span class=o>|</span> <span class=kc>None</span> <span class=o>=</span> <span class=kc>None</span>
    <span class=n>n_stations</span><span class=p>:</span> <span class=nb>int</span> <span class=o>|</span> <span class=kc>None</span> <span class=o>=</span> <span class=kc>None</span>
    <span class=n>n_demands</span><span class=p>:</span> <span class=nb>int</span> <span class=o>|</span> <span class=kc>None</span> <span class=o>=</span> <span class=kc>None</span>
    <span class=n>time_end_warmup</span><span class=p>:</span> <span class=nb>int</span> <span class=o>|</span> <span class=nb>float</span> <span class=o>|</span> <span class=kc>None</span> <span class=o>=</span> <span class=kc>None</span>
    <span class=n>time_end_measure</span><span class=p>:</span> <span class=nb>int</span> <span class=o>|</span> <span class=nb>float</span> <span class=o>|</span> <span class=kc>None</span> <span class=o>=</span> <span class=kc>None</span>
    <span class=n>routes</span><span class=p>:</span> <span class=nb>list</span><span class=p>[</span><span class=nb>list</span><span class=p>[</span><span class=nb>int</span><span class=p>]]</span> <span class=o>|</span> <span class=kc>None</span> <span class=o>=</span> <span class=kc>None</span>
    <span class=n>demands</span><span class=p>:</span> <span class=nb>list</span><span class=p>[</span><span class=nb>list</span><span class=p>[</span><span class=nb>int</span> <span class=o>|</span> <span class=nb>float</span><span class=p>]]</span> <span class=o>|</span> <span class=kc>None</span> <span class=o>=</span> <span class=kc>None</span>
    <span class=n>in_warehouse</span><span class=p>:</span> <span class=nb>list</span><span class=p>[</span><span class=nb>int</span><span class=p>]</span> <span class=o>|</span> <span class=kc>None</span> <span class=o>=</span> <span class=kc>None</span>
    <span class=n>station_product_times</span><span class=p>:</span> <span class=nb>list</span><span class=p>[</span><span class=nb>list</span><span class=p>[</span><span class=nb>list</span><span class=p>[</span><span class=nb>float</span><span class=p>]]]</span> <span class=o>|</span> <span class=kc>None</span> <span class=o>=</span> <span class=kc>None</span>
    <span class=n>infos</span><span class=p>:</span> <span class=nb>dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=p>{}</span>

    <span class=k>for</span> <span class=n>line_idx</span><span class=p>,</span> <span class=n>oline</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>stream</span><span class=p>):</span>
        <span class=n>line</span> <span class=o>=</span> <span class=nb>str</span><span class=o>.</span><span class=n>strip</span><span class=p>(</span><span class=n>oline</span><span class=p>)</span>
        <span class=k>if</span> <span class=nb>str</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=n>line</span><span class=p>,</span> <span class=n>COMMENT_START</span><span class=p>):</span>
            <span class=k>continue</span>

        <span class=n>split_idx</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=nb>str</span><span class=o>.</span><span class=n>find</span><span class=p>(</span><span class=n>line</span><span class=p>,</span> <span class=n>_KEY_VALUE_SPLIT</span><span class=p>)</span>
        <span class=k>if</span> <span class=n>split_idx</span> <span class=o>></span> <span class=o>-</span><span class=mi>1</span><span class=p>:</span>
            <span class=n>key</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=nb>str</span><span class=o>.</span><span class=n>lower</span><span class=p>(</span><span class=nb>str</span><span class=o>.</span><span class=n>strip</span><span class=p>(</span><span class=n>line</span><span class=p>[:</span><span class=n>split_idx</span><span class=p>]))</span>
            <span class=n>value</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=nb>str</span><span class=o>.</span><span class=n>strip</span><span class=p>(</span>
                <span class=n>line</span><span class=p>[</span><span class=n>split_idx</span> <span class=o>+</span> <span class=nb>str</span><span class=o>.</span><span class=fm>__len__</span><span class=p>(</span><span class=n>_KEY_VALUE_SPLIT</span><span class=p>):])</span>
            <span class=k>if</span> <span class=p>(</span><span class=nb>str</span><span class=o>.</span><span class=fm>__len__</span><span class=p>(</span><span class=n>key</span><span class=p>)</span> <span class=o><=</span> <span class=mi>0</span><span class=p>)</span> <span class=ow>or</span> <span class=p>(</span><span class=nb>str</span><span class=o>.</span><span class=fm>__len__</span><span class=p>(</span><span class=n>value</span><span class=p>)</span> <span class=o><=</span> <span class=mi>0</span><span class=p>):</span>
                <span class=k>raise</span> <span class=n>__pe</span><span class=p>(</span><span class=sa>f</span><span class=s2>"Invalid key/value pair </span><span class=si>{</span><span class=n>key</span><span class=si>!r}</span><span class=s2>/</span><span class=si>{</span><span class=n>value</span><span class=si>!r}</span><span class=s2>"</span><span class=p>,</span>
                           <span class=n>oline</span><span class=p>,</span> <span class=n>line_idx</span><span class=p>)</span>

            <span class=k>if</span> <span class=n>key</span> <span class=o>==</span> <span class=n>KEY_NAME</span><span class=p>:</span>
                <span class=k>if</span> <span class=n>name</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
                    <span class=k>raise</span> <span class=n>__pe</span><span class=p>(</span><span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>KEY_NAME</span><span class=si>}</span><span class=s2> already defined as </span><span class=si>{</span><span class=n>name</span><span class=si>!r}</span><span class=s2>, "</span>
                               <span class=sa>f</span><span class=s2>"cannot be set to </span><span class=si>{</span><span class=n>value</span><span class=si>!r}</span><span class=s2>"</span><span class=p>,</span> <span class=n>oline</span><span class=p>,</span> <span class=n>line_idx</span><span class=p>)</span>
                <span class=n>name</span> <span class=o>=</span> <span class=n>value</span>

            <span class=k>elif</span> <span class=n>key</span> <span class=o>==</span> <span class=n>KEY_N_STATIONS</span><span class=p>:</span>
                <span class=k>if</span> <span class=n>n_stations</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
                    <span class=k>raise</span> <span class=n>__pe</span><span class=p>(</span>
                        <span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>KEY_N_STATIONS</span><span class=si>}</span><span class=s2> already defined as </span><span class=si>{</span><span class=n>n_stations</span><span class=si>!r}</span><span class=s2>,"</span>
                        <span class=sa>f</span><span class=s2>" cannot be set to </span><span class=si>{</span><span class=n>value</span><span class=si>!r}</span><span class=s2>"</span><span class=p>,</span> <span class=n>oline</span><span class=p>,</span> <span class=n>line_idx</span><span class=p>)</span>
                <span class=n>n_stations</span> <span class=o>=</span> <span class=n>check_to_int_range</span><span class=p>(</span>
                    <span class=n>value</span><span class=p>,</span> <span class=n>KEY_N_STATIONS</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1_000_000</span><span class=p>)</span>

            <span class=k>elif</span> <span class=n>key</span> <span class=o>==</span> <span class=n>KEY_N_PRODUCTS</span><span class=p>:</span>
                <span class=k>if</span> <span class=n>n_products</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
                    <span class=k>raise</span> <span class=n>__pe</span><span class=p>(</span>
                        <span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>KEY_N_PRODUCTS</span><span class=si>}</span><span class=s2> already defined as </span><span class=si>{</span><span class=n>n_products</span><span class=si>!r}</span><span class=s2>,"</span>
                        <span class=sa>f</span><span class=s2>" cannot be set to </span><span class=si>{</span><span class=n>value</span><span class=si>!r}</span><span class=s2>"</span><span class=p>,</span> <span class=n>oline</span><span class=p>,</span> <span class=n>line_idx</span><span class=p>)</span>
                <span class=n>n_products</span> <span class=o>=</span> <span class=n>check_to_int_range</span><span class=p>(</span>
                    <span class=n>value</span><span class=p>,</span> <span class=n>KEY_N_PRODUCTS</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1_000_000</span><span class=p>)</span>

            <span class=k>elif</span> <span class=n>key</span> <span class=o>==</span> <span class=n>KEY_N_CUSTOMERS</span><span class=p>:</span>
                <span class=k>if</span> <span class=n>n_customers</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
                    <span class=k>raise</span> <span class=n>__pe</span><span class=p>(</span>
                        <span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>KEY_N_CUSTOMERS</span><span class=si>}</span><span class=s2> already defined as "</span>
                        <span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>n_customers</span><span class=si>!r}</span><span class=s2>, cannot be set to </span><span class=si>{</span><span class=n>value</span><span class=si>!r}</span><span class=s2>"</span><span class=p>,</span>
                        <span class=n>oline</span><span class=p>,</span> <span class=n>line_idx</span><span class=p>)</span>
                <span class=n>n_customers</span> <span class=o>=</span> <span class=n>check_to_int_range</span><span class=p>(</span>
                    <span class=n>value</span><span class=p>,</span> <span class=n>KEY_N_CUSTOMERS</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1_000_000</span><span class=p>)</span>

            <span class=k>elif</span> <span class=n>key</span> <span class=o>==</span> <span class=n>KEY_N_DEMANDS</span><span class=p>:</span>
                <span class=k>if</span> <span class=n>n_demands</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
                    <span class=k>raise</span> <span class=n>__pe</span><span class=p>(</span>
                        <span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>KEY_N_DEMANDS</span><span class=si>}</span><span class=s2> already defined as </span><span class=si>{</span><span class=n>n_demands</span><span class=si>!r}</span><span class=s2>, "</span>
                        <span class=sa>f</span><span class=s2>"cannot be set to </span><span class=si>{</span><span class=n>value</span><span class=si>!r}</span><span class=s2>"</span><span class=p>,</span> <span class=n>oline</span><span class=p>,</span> <span class=n>line_idx</span><span class=p>)</span>
                <span class=n>n_demands</span> <span class=o>=</span> <span class=n>check_to_int_range</span><span class=p>(</span>
                    <span class=n>value</span><span class=p>,</span> <span class=n>KEY_N_DEMANDS</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1_000_000</span><span class=p>)</span>

            <span class=k>elif</span> <span class=n>key</span> <span class=o>==</span> <span class=n>KEY_TIME_END_WARMUP</span><span class=p>:</span>
                <span class=k>if</span> <span class=n>time_end_warmup</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
                    <span class=k>raise</span> <span class=n>__pe</span><span class=p>(</span><span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>KEY_TIME_END_WARMUP</span><span class=si>}</span><span class=s2> already defined"</span><span class=p>,</span>
                               <span class=n>oline</span><span class=p>,</span> <span class=n>line_idx</span><span class=p>)</span>
                <span class=n>time_end_warmup</span> <span class=o>=</span> <span class=nb>float</span><span class=p>(</span><span class=n>value</span><span class=p>)</span>
                <span class=k>if</span> <span class=ow>not</span> <span class=p>(</span><span class=n>isfinite</span><span class=p>(</span><span class=n>time_end_warmup</span><span class=p>)</span> <span class=ow>and</span> <span class=p>(</span><span class=n>time_end_warmup</span> <span class=o>></span> <span class=mi>0</span><span class=p>)):</span>
                    <span class=k>raise</span> <span class=n>__pe</span><span class=p>(</span><span class=sa>f</span><span class=s2>"time_end_warmup=</span><span class=si>{</span><span class=n>time_end_warmup</span><span class=si>}</span><span class=s2> invalid"</span><span class=p>,</span>
                               <span class=n>oline</span><span class=p>,</span> <span class=n>line_idx</span><span class=p>)</span>

            <span class=k>elif</span> <span class=n>key</span> <span class=o>==</span> <span class=n>KEY_TIME_END_MEASURE</span><span class=p>:</span>
                <span class=k>if</span> <span class=n>time_end_measure</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
                    <span class=k>raise</span> <span class=n>__pe</span><span class=p>(</span><span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>KEY_TIME_END_MEASURE</span><span class=si>}</span><span class=s2> already defined"</span><span class=p>,</span>
                               <span class=n>oline</span><span class=p>,</span> <span class=n>line_idx</span><span class=p>)</span>
                <span class=n>time_end_measure</span> <span class=o>=</span> <span class=nb>float</span><span class=p>(</span><span class=n>value</span><span class=p>)</span>
                <span class=k>if</span> <span class=ow>not</span> <span class=p>(</span><span class=n>isfinite</span><span class=p>(</span><span class=n>time_end_measure</span><span class=p>)</span> <span class=ow>and</span> <span class=p>(</span>
                        <span class=n>time_end_measure</span> <span class=o>></span> <span class=mi>0</span><span class=p>)):</span>
                    <span class=k>raise</span> <span class=n>__pe</span><span class=p>(</span><span class=sa>f</span><span class=s2>"time_end_measure=</span><span class=si>{</span><span class=n>time_end_measure</span><span class=si>}</span><span class=s2> invalid"</span><span class=p>,</span>
                               <span class=n>oline</span><span class=p>,</span> <span class=n>line_idx</span><span class=p>)</span>
                <span class=k>if</span> <span class=p>(</span><span class=n>time_end_warmup</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>)</span> <span class=ow>and</span> <span class=p>(</span>
                        <span class=n>time_end_measure</span> <span class=o><=</span> <span class=n>time_end_warmup</span><span class=p>):</span>
                    <span class=k>raise</span> <span class=n>__pe</span><span class=p>(</span><span class=sa>f</span><span class=s2>"time_end_warmup=</span><span class=si>{</span><span class=n>time_end_warmup</span><span class=si>}</span><span class=s2> and "</span>
                               <span class=sa>f</span><span class=s2>"time_end_measure=</span><span class=si>{</span><span class=n>time_end_measure</span><span class=si>}</span><span class=s2>"</span><span class=p>,</span>
                               <span class=n>oline</span><span class=p>,</span> <span class=n>line_idx</span><span class=p>)</span>

            <span class=k>elif</span> <span class=n>key</span> <span class=o>==</span> <span class=n>KEY_IN_WAREHOUSE</span><span class=p>:</span>
                <span class=k>if</span> <span class=n>in_warehouse</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
                    <span class=k>raise</span> <span class=n>__pe</span><span class=p>(</span><span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>KEY_IN_WAREHOUSE</span><span class=si>}</span><span class=s2> already defined"</span><span class=p>,</span>
                               <span class=n>oline</span><span class=p>,</span> <span class=n>line_idx</span><span class=p>)</span>
                <span class=k>if</span> <span class=n>n_products</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
                    <span class=k>raise</span> <span class=n>__pe</span><span class=p>(</span><span class=sa>f</span><span class=s2>"Must define </span><span class=si>{</span><span class=n>KEY_N_PRODUCTS</span><span class=si>}</span><span class=s2> before "</span>
                               <span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>KEY_IN_WAREHOUSE</span><span class=si>}</span><span class=s2>."</span><span class=p>,</span> <span class=n>oline</span><span class=p>,</span> <span class=n>line_idx</span><span class=p>)</span>
                <span class=n>in_warehouse</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=nb>map</span><span class=p>(</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=o>.</span><span class=n>split</span><span class=p>(</span>
                    <span class=n>value</span><span class=p>,</span> <span class=n>CSV_SEPARATOR</span><span class=p>)))</span>
                <span class=k>if</span> <span class=nb>list</span><span class=o>.</span><span class=fm>__len__</span><span class=p>(</span><span class=n>in_warehouse</span><span class=p>)</span> <span class=o>!=</span> <span class=n>n_products</span><span class=p>:</span>
                    <span class=k>raise</span> <span class=n>__pe</span><span class=p>(</span>
                        <span class=sa>f</span><span class=s2>"Expected </span><span class=si>{</span><span class=n>n_products</span><span class=si>}</span><span class=s2> products in warehouse, got "</span>
                        <span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>in_warehouse</span><span class=si>}</span><span class=s2>."</span><span class=p>,</span> <span class=n>oline</span><span class=p>,</span> <span class=n>line_idx</span><span class=p>)</span>

            <span class=k>elif</span> <span class=nb>str</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>KEY_ROUTE</span><span class=p>):</span>
                <span class=k>if</span> <span class=n>n_products</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
                    <span class=k>raise</span> <span class=n>__pe</span><span class=p>(</span><span class=sa>f</span><span class=s2>"Must define </span><span class=si>{</span><span class=n>KEY_N_PRODUCTS</span><span class=si>}</span><span class=s2> before "</span>
                               <span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>KEY_ROUTE</span><span class=si>}</span><span class=s2>."</span><span class=p>,</span> <span class=n>oline</span><span class=p>,</span> <span class=n>line_idx</span><span class=p>)</span>
                <span class=k>if</span> <span class=n>n_stations</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
                    <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=sa>f</span><span class=s2>"Must define </span><span class=si>{</span><span class=n>KEY_N_STATIONS</span><span class=si>}</span><span class=s2> before "</span>
                                     <span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>KEY_ROUTE</span><span class=si>}</span><span class=s2>."</span><span class=p>,</span> <span class=n>oline</span><span class=p>,</span> <span class=n>line_idx</span><span class=p>)</span>
                <span class=k>if</span> <span class=n>routes</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
                    <span class=n>routes</span> <span class=o>=</span> <span class=p>[[]</span> <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>n_products</span><span class=p>)]</span>

                <span class=n>product_id</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=n>check_to_int_range</span><span class=p>(</span>
                    <span class=n>__get_key_index</span><span class=p>(</span><span class=n>key</span><span class=p>),</span> <span class=n>KEY_ROUTE</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>n_products</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)</span>
                <span class=n>rlst</span><span class=p>:</span> <span class=nb>list</span><span class=p>[</span><span class=nb>int</span><span class=p>]</span> <span class=o>=</span> <span class=n>routes</span><span class=p>[</span><span class=n>product_id</span><span class=p>]</span>
                <span class=k>if</span> <span class=nb>list</span><span class=o>.</span><span class=fm>__len__</span><span class=p>(</span><span class=n>rlst</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>:</span>
                    <span class=k>raise</span> <span class=n>__pe</span><span class=p>(</span>
                        <span class=sa>f</span><span class=s2>"Already gave </span><span class=si>{</span><span class=n>KEY_ROUTE</span><span class=si>}{</span><span class=n>KEY_IDX_START</span><span class=si>}{</span><span class=n>product_id</span><span class=si>}</span><span class=s2>"</span>
                        <span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>KEY_IDX_END</span><span class=si>}</span><span class=s2>"</span><span class=p>,</span> <span class=n>oline</span><span class=p>,</span> <span class=n>line_idx</span><span class=p>)</span>
                <span class=n>rlst</span><span class=o>.</span><span class=n>extend</span><span class=p>(</span><span class=nb>map</span><span class=p>(</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=n>value</span><span class=p>,</span> <span class=n>CSV_SEPARATOR</span><span class=p>)))</span>
                <span class=k>if</span> <span class=nb>list</span><span class=o>.</span><span class=fm>__len__</span><span class=p>(</span><span class=n>rlst</span><span class=p>)</span> <span class=o><=</span> <span class=mi>0</span><span class=p>:</span>
                    <span class=k>raise</span> <span class=n>__pe</span><span class=p>(</span><span class=sa>f</span><span class=s2>"Route for product </span><span class=si>{</span><span class=n>product_id</span><span class=si>}</span><span class=s2> is empty"</span><span class=p>,</span>
                               <span class=n>oline</span><span class=p>,</span> <span class=n>line_idx</span><span class=p>)</span>

            <span class=k>elif</span> <span class=nb>str</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>KEY_DEMAND</span><span class=p>):</span>
                <span class=k>if</span> <span class=n>n_customers</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
                    <span class=k>raise</span> <span class=n>__pe</span><span class=p>(</span><span class=sa>f</span><span class=s2>"Must define </span><span class=si>{</span><span class=n>KEY_N_CUSTOMERS</span><span class=si>}</span><span class=s2> before "</span>
                               <span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>KEY_DEMAND</span><span class=si>}</span><span class=s2>"</span><span class=p>,</span> <span class=n>oline</span><span class=p>,</span> <span class=n>line_idx</span><span class=p>)</span>
                <span class=k>if</span> <span class=n>n_products</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
                    <span class=k>raise</span> <span class=n>__pe</span><span class=p>(</span><span class=sa>f</span><span class=s2>"Must define </span><span class=si>{</span><span class=n>KEY_N_PRODUCTS</span><span class=si>}</span><span class=s2> before "</span>
                               <span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>KEY_DEMAND</span><span class=si>}</span><span class=s2>."</span><span class=p>,</span> <span class=n>oline</span><span class=p>,</span> <span class=n>line_idx</span><span class=p>)</span>
                <span class=k>if</span> <span class=n>n_demands</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
                    <span class=k>raise</span> <span class=n>__pe</span><span class=p>(</span><span class=sa>f</span><span class=s2>"Must define </span><span class=si>{</span><span class=n>KEY_N_DEMANDS</span><span class=si>}</span><span class=s2> before "</span>
                               <span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>KEY_DEMAND</span><span class=si>}</span><span class=s2>"</span><span class=p>,</span> <span class=n>oline</span><span class=p>,</span> <span class=n>line_idx</span><span class=p>)</span>
                <span class=k>if</span> <span class=n>demands</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
                    <span class=n>demands</span> <span class=o>=</span> <span class=p>[[</span><span class=n>i</span><span class=p>]</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>n_demands</span><span class=p>)]</span>

                <span class=n>demand_id</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=n>check_to_int_range</span><span class=p>(</span>
                    <span class=n>__get_key_index</span><span class=p>(</span><span class=n>key</span><span class=p>),</span> <span class=n>KEY_DEMAND</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>n_demands</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)</span>
                <span class=n>dlst</span><span class=p>:</span> <span class=nb>list</span><span class=p>[</span><span class=nb>int</span> <span class=o>|</span> <span class=nb>float</span><span class=p>]</span> <span class=o>=</span> <span class=n>demands</span><span class=p>[</span><span class=n>demand_id</span><span class=p>]</span>
                <span class=k>if</span> <span class=nb>list</span><span class=o>.</span><span class=fm>__len__</span><span class=p>(</span><span class=n>dlst</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>1</span><span class=p>:</span>
                    <span class=k>raise</span> <span class=n>__pe</span><span class=p>(</span><span class=sa>f</span><span class=s2>"Already gave </span><span class=si>{</span><span class=n>KEY_DEMAND</span><span class=si>}{</span><span class=n>KEY_IDX_START</span><span class=si>}</span><span class=s2>"</span>
                               <span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>demand_id</span><span class=si>}{</span><span class=n>KEY_IDX_END</span><span class=si>}</span><span class=s2>"</span><span class=p>,</span> <span class=n>oline</span><span class=p>,</span> <span class=n>line_idx</span><span class=p>)</span>
                <span class=n>str_lst</span> <span class=o>=</span> <span class=nb>str</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=n>value</span><span class=p>,</span> <span class=n>CSV_SEPARATOR</span><span class=p>)</span>
                <span class=k>if</span> <span class=nb>list</span><span class=o>.</span><span class=fm>__len__</span><span class=p>(</span><span class=n>str_lst</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>5</span><span class=p>:</span>
                    <span class=k>raise</span> <span class=n>__pe</span><span class=p>(</span>
                        <span class=sa>f</span><span class=s2>"Demand </span><span class=si>{</span><span class=n>demand_id</span><span class=si>}</span><span class=s2> must have 5 entries, but got: "</span>
                        <span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>str_lst</span><span class=si>!r}</span><span class=s2>"</span><span class=p>,</span> <span class=n>oline</span><span class=p>,</span> <span class=n>line_idx</span><span class=p>)</span>
                <span class=n>dlst</span><span class=o>.</span><span class=n>extend</span><span class=p>((</span><span class=nb>int</span><span class=p>(</span><span class=n>str_lst</span><span class=p>[</span><span class=mi>0</span><span class=p>]),</span> <span class=nb>int</span><span class=p>(</span><span class=n>str_lst</span><span class=p>[</span><span class=mi>1</span><span class=p>]),</span>
                             <span class=nb>int</span><span class=p>(</span><span class=n>str_lst</span><span class=p>[</span><span class=mi>2</span><span class=p>]),</span> <span class=nb>float</span><span class=p>(</span><span class=n>str_lst</span><span class=p>[</span><span class=mi>3</span><span class=p>]),</span>
                             <span class=nb>float</span><span class=p>(</span><span class=n>str_lst</span><span class=p>[</span><span class=mi>4</span><span class=p>])))</span>

            <span class=k>elif</span> <span class=nb>str</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>KEY_PRODUCTION_TIME</span><span class=p>):</span>
                <span class=k>if</span> <span class=n>n_products</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
                    <span class=k>raise</span> <span class=n>__pe</span><span class=p>(</span><span class=sa>f</span><span class=s2>"Must define </span><span class=si>{</span><span class=n>KEY_N_PRODUCTS</span><span class=si>}</span><span class=s2> before "</span>
                               <span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>KEY_PRODUCTION_TIME</span><span class=si>}</span><span class=s2>"</span><span class=p>,</span> <span class=n>oline</span><span class=p>,</span> <span class=n>line_idx</span><span class=p>)</span>
                <span class=k>if</span> <span class=n>n_stations</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
                    <span class=k>raise</span> <span class=n>__pe</span><span class=p>(</span><span class=sa>f</span><span class=s2>"Must define </span><span class=si>{</span><span class=n>KEY_N_STATIONS</span><span class=si>}</span><span class=s2> before"</span>
                               <span class=sa>f</span><span class=s2>" </span><span class=si>{</span><span class=n>KEY_PRODUCTION_TIME</span><span class=si>}</span><span class=s2>"</span><span class=p>,</span> <span class=n>oline</span><span class=p>,</span> <span class=n>line_idx</span><span class=p>)</span>
                <span class=n>station</span><span class=p>,</span> <span class=n>product</span> <span class=o>=</span> <span class=nb>str</span><span class=o>.</span><span class=n>split</span><span class=p>(</span>
                    <span class=n>__get_key_index</span><span class=p>(</span><span class=n>key</span><span class=p>),</span> <span class=n>CSV_SEPARATOR</span><span class=p>)</span>
                <span class=n>station_id</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=n>check_to_int_range</span><span class=p>(</span>
                    <span class=n>station</span><span class=p>,</span> <span class=s2>"station"</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>n_stations</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)</span>
                <span class=n>product_id</span> <span class=o>=</span> <span class=n>check_to_int_range</span><span class=p>(</span>
                    <span class=n>product</span><span class=p>,</span> <span class=s2>"product"</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>n_products</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)</span>

                <span class=k>if</span> <span class=n>station_product_times</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
                    <span class=n>station_product_times</span> <span class=o>=</span> \
                        <span class=p>[[[]</span> <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>n_products</span><span class=p>)]</span>
                         <span class=k>for</span> <span class=n>__</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>n_stations</span><span class=p>)]</span>

                <span class=k>if</span> <span class=nb>str</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=n>value</span><span class=p>,</span> <span class=n>KEY_PRODUCTION_TIME</span><span class=p>):</span>
                    <span class=n>station</span><span class=p>,</span> <span class=n>product</span> <span class=o>=</span> <span class=nb>str</span><span class=o>.</span><span class=n>split</span><span class=p>(</span>
                        <span class=n>__get_key_index</span><span class=p>(</span><span class=n>value</span><span class=p>),</span> <span class=n>CSV_SEPARATOR</span><span class=p>)</span>
                    <span class=n>use_station_id</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=n>check_to_int_range</span><span class=p>(</span>
                        <span class=n>station</span><span class=p>,</span> <span class=s2>"station"</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>n_stations</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)</span>
                    <span class=n>use_product_id</span> <span class=o>=</span> <span class=n>check_to_int_range</span><span class=p>(</span>
                        <span class=n>product</span><span class=p>,</span> <span class=s2>"product"</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>n_products</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)</span>
                    <span class=n>station_product_times</span><span class=p>[</span><span class=n>station_id</span><span class=p>][</span><span class=n>product_id</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span>
                        <span class=n>station_product_times</span><span class=p>)[</span><span class=n>use_station_id</span><span class=p>][</span><span class=n>use_product_id</span><span class=p>]</span>
                <span class=k>else</span><span class=p>:</span>
                    <span class=n>mpd</span><span class=p>:</span> <span class=nb>list</span><span class=p>[</span><span class=nb>float</span><span class=p>]</span> <span class=o>=</span> <span class=n>station_product_times</span><span class=p>[</span>
                        <span class=n>station_id</span><span class=p>][</span><span class=n>product_id</span><span class=p>]</span>
                    <span class=k>if</span> <span class=nb>list</span><span class=o>.</span><span class=fm>__len__</span><span class=p>(</span><span class=n>mpd</span><span class=p>)</span> <span class=o>></span> <span class=mi>0</span><span class=p>:</span>
                        <span class=k>raise</span> <span class=n>__pe</span><span class=p>(</span>
                            <span class=sa>f</span><span class=s2>"Already gave </span><span class=si>{</span><span class=n>KEY_PRODUCTION_TIME</span><span class=si>}</span><span class=s2>"</span>
                            <span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>KEY_IDX_START</span><span class=si>}{</span><span class=n>station_id</span><span class=si>}{</span><span class=n>CSV_SEPARATOR</span><span class=si>}</span><span class=s2>"</span>
                            <span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>product_id</span><span class=si>}{</span><span class=n>KEY_IDX_END</span><span class=si>}</span><span class=s2>"</span><span class=p>,</span> <span class=n>oline</span><span class=p>,</span> <span class=n>line_idx</span><span class=p>)</span>
                    <span class=n>mpd</span><span class=o>.</span><span class=n>extend</span><span class=p>(</span>
                        <span class=nb>map</span><span class=p>(</span><span class=nb>float</span><span class=p>,</span> <span class=nb>str</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=n>value</span><span class=p>,</span> <span class=n>CSV_SEPARATOR</span><span class=p>)))</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>infos</span><span class=p>[</span><span class=n>key</span><span class=p>]</span> <span class=o>=</span> <span class=n>value</span>

    <span class=k>if</span> <span class=n>name</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
        <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=sa>f</span><span class=s2>"Did not specify instance name (</span><span class=si>{</span><span class=n>KEY_NAME</span><span class=si>}</span><span class=s2>)."</span><span class=p>)</span>
    <span class=k>if</span> <span class=n>n_products</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
        <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>"Did not specify instance n_products"</span>
                         <span class=sa>f</span><span class=s2>" (</span><span class=si>{</span><span class=n>KEY_N_PRODUCTS</span><span class=si>}</span><span class=s2>)."</span><span class=p>)</span>
    <span class=k>if</span> <span class=n>n_customers</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
        <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>"Did not specify instance n_customers"</span>
                         <span class=sa>f</span><span class=s2>" (</span><span class=si>{</span><span class=n>KEY_N_CUSTOMERS</span><span class=si>}</span><span class=s2>)."</span><span class=p>)</span>
    <span class=k>if</span> <span class=n>n_stations</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
        <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>"Did not specify instance n_stations"</span>
                         <span class=sa>f</span><span class=s2>" (</span><span class=si>{</span><span class=n>KEY_N_STATIONS</span><span class=si>}</span><span class=s2>)."</span><span class=p>)</span>
    <span class=k>if</span> <span class=n>n_demands</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
        <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>"Did not specify instance n_demands"</span>
                         <span class=sa>f</span><span class=s2>" (</span><span class=si>{</span><span class=n>KEY_N_DEMANDS</span><span class=si>}</span><span class=s2>)."</span><span class=p>)</span>
    <span class=k>if</span> <span class=n>time_end_warmup</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
        <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>"Did not specify instance time_end_warmup"</span>
                         <span class=sa>f</span><span class=s2>" (</span><span class=si>{</span><span class=n>KEY_TIME_END_WARMUP</span><span class=si>}</span><span class=s2>)."</span><span class=p>)</span>
    <span class=k>if</span> <span class=n>time_end_measure</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
        <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>"Did not specify instance time_end_measure"</span>
                         <span class=sa>f</span><span class=s2>" (</span><span class=si>{</span><span class=n>KEY_TIME_END_MEASURE</span><span class=si>}</span><span class=s2>)."</span><span class=p>)</span>
    <span class=k>if</span> <span class=n>routes</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
        <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=sa>f</span><span class=s2>"Did not specify instance routes (</span><span class=si>{</span><span class=n>KEY_ROUTE</span><span class=si>}</span><span class=s2>)."</span><span class=p>)</span>
    <span class=k>if</span> <span class=n>demands</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
        <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=sa>f</span><span class=s2>"Did not specify instance demands (</span><span class=si>{</span><span class=n>KEY_DEMAND</span><span class=si>}</span><span class=s2>)."</span><span class=p>)</span>
    <span class=k>if</span> <span class=n>in_warehouse</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
        <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>"Did not specify instance warehouse values"</span>
                         <span class=sa>f</span><span class=s2>" (</span><span class=si>{</span><span class=n>KEY_IN_WAREHOUSE</span><span class=si>}</span><span class=s2>)."</span><span class=p>)</span>
    <span class=k>if</span> <span class=n>station_product_times</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
        <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>"Did not specify per-station product production"</span>
                         <span class=sa>f</span><span class=s2>"times (</span><span class=si>{</span><span class=n>KEY_PRODUCTION_TIME</span><span class=si>}</span><span class=s2>)."</span><span class=p>)</span>

    <span class=k>return</span> <span class=n>Instance</span><span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=n>n_products</span><span class=p>,</span> <span class=n>n_customers</span><span class=p>,</span> <span class=n>n_stations</span><span class=p>,</span> <span class=n>n_demands</span><span class=p>,</span>
                    <span class=n>time_end_warmup</span><span class=p>,</span> <span class=n>time_end_measure</span><span class=p>,</span>
                    <span class=n>routes</span><span class=p>,</span> <span class=n>demands</span><span class=p>,</span> <span class=n>in_warehouse</span><span class=p>,</span> <span class=n>station_product_times</span><span class=p>,</span>
                    <span class=n>infos</span><span class=p>)</span></div>



<div class=viewcode-block id=compute_finish_time>
<a class=viewcode-back href=../../../moptipyapps.prodsched.html#moptipyapps.prodsched.instance.compute_finish_time>[docs]</a>
<span class=nd>@numba</span><span class=o>.</span><span class=n>njit</span><span class=p>(</span><span class=n>cache</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>inline</span><span class=o>=</span><span class=s2>"always"</span><span class=p>,</span> <span class=n>fastmath</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>boundscheck</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
<span class=k>def</span><span class=w> </span><span class=nf>compute_finish_time</span><span class=p>(</span><span class=n>start_time</span><span class=p>:</span> <span class=nb>float</span><span class=p>,</span> <span class=n>amount</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span>
                        <span class=n>production_times</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>)</span> <span class=o>-></span> <span class=nb>float</span><span class=p>:</span>
<span class=w>    </span><span class=sd>"""</span>
<span class=sd>    Compute the time when one job is finished.</span>

<span class=sd>    The production times are cyclic intervals of unit production times and</span>
<span class=sd>    interval ends.</span>

<span class=sd>    :param start_time: the starting time of the job</span>
<span class=sd>    :param amount: the number of units to be produced</span>
<span class=sd>    :param production_times: the production times array</span>
<span class=sd>    :return: the end time</span>

<span class=sd>    Here, the production time is 10 time units / 1 product unit, valid until</span>
<span class=sd>    end time 100.</span>

<span class=sd>    >>> compute_finish_time(0.0, 1, np.array((10.0, 100.0), np.float64))</span>
<span class=sd>    10.0</span>

<span class=sd>    Here, the production time is 10 time units / 1 product unit, valid until</span>
<span class=sd>    end time 100. We begin producing at time unit 250. Since the production</span>
<span class=sd>    periods are cyclic, this is OK: we would be halfway through the third</span>
<span class=sd>    production period when the request comes in. It will consume 10 time units</span>
<span class=sd>    and be done at time unit 260.</span>

<span class=sd>    >>> compute_finish_time(250.0, 1, np.array((10.0, 100.0)))</span>
<span class=sd>    260.0</span>

<span class=sd>    Here, the end time of the production time validity is at time unit 100.</span>
<span class=sd>    However, we begin producing 1 product unit at time step 90. This unit will</span>
<span class=sd>    use 10 time units, meaning that its production is exactly finished when</span>
<span class=sd>    the production time validity ends.</span>
<span class=sd>    It will be finished at time step 100.</span>

<span class=sd>    >>> compute_finish_time(90.0, 1, np.array((10.0, 100.0)))</span>
<span class=sd>    100.0</span>

<span class=sd>    Here, the end time of the production time validity is at time unit 100.</span>
<span class=sd>    However, we begin producing 1 product unit at time step 95. This unit would</span>
<span class=sd>    use 10 time units. It will use these units, even though this extends beyond</span>
<span class=sd>    the end of the production time window.</span>

<span class=sd>    >>> compute_finish_time(95.0, 1, np.array((10.0, 100.0)))</span>
<span class=sd>    105.0</span>

<span class=sd>    Now we have two production periods. The production begins again at time</span>
<span class=sd>    step 95. It will use 10 time units, even though this extends into the</span>
<span class=sd>    second period.</span>

<span class=sd>    >>> compute_finish_time(95.0, 1, np.array((10.0, 100.0, 20.0, 200.0)))</span>
<span class=sd>    105.0</span>

<span class=sd>    Now things get more complex. We want to do 10 units of product.</span>
<span class=sd>    We start in the first period, so one unit will be completed there.</span>
<span class=sd>    This takes the starting time for the next job to 105, which is in the</span>
<span class=sd>    second period. Here, one unit of product takes 20 time units. We can</span>
<span class=sd>    finish producing one unit until time 125 and start the production of a</span>
<span class=sd>    second one, taking until 145. Now the remaining three units are produced</span>
<span class=sd>    until time 495</span>
<span class=sd>    >>> compute_finish_time(95.0, 10, np.array((</span>
<span class=sd>    ...     10.0, 100.0, 20.0, 140.0, 50.0, 5000.0)))</span>
<span class=sd>    495.0</span>
<span class=sd>    >>> 95 + (1*10 + 2*20 + 7*50)</span>
<span class=sd>    495</span>

<span class=sd>    We again produce 10 product units starting at time step 95. The first one</span>
<span class=sd>    takes 10 time units, taking us into the second production interval at time</span>
<span class=sd>    105. Then we can again do two units here, which consume 40 time units,</span>
<span class=sd>    taking us over the edge into the third interval at time unit 145. Here we</span>
<span class=sd>    do two units using 50 time units. We ahen are at time 245, which wraps back</span>
<span class=sd>    to 45. So the remaining 5 units take 10 time units each.</span>

<span class=sd>    >>> compute_finish_time(95.0, 10, np.array((</span>
<span class=sd>    ...     10.0, 100.0, 20.0, 140.0, 50.0, 200.0)))</span>
<span class=sd>    295.0</span>
<span class=sd>    >>> 95 + (1*10 + 2*20 + 2*50 + 5*10)</span>
<span class=sd>    295</span>

<span class=sd>    This is the same as the last example, but this time, the last interval</span>
<span class=sd>    (3 time units until 207) is skipped over by the long production of the</span>
<span class=sd>    second 50-time-unit product.</span>

<span class=sd>    >>> compute_finish_time(95.0, 10, np.array((</span>
<span class=sd>    ...     10.0, 100.0, 20.0, 140.0, 50.0, 200.0,  3.0, 207.0)))</span>
<span class=sd>    295.0</span>
<span class=sd>    >>> 95 + (1*10 + 2*20 + 2*50 + 5*10)</span>
<span class=sd>    295</span>

<span class=sd>    Production unit times may extend beyond the intervals.</span>

<span class=sd>    >>> compute_finish_time(0.0, 5, np.array((1000.0, 100.0, 10.0, 110.0)))</span>
<span class=sd>    5000.0</span>
<span class=sd>    >>></span>
<span class=sd>    5 * 1000</span>
<span class=sd>    """</span>
    <span class=n>time_mod</span><span class=p>:</span> <span class=n>Final</span><span class=p>[</span><span class=nb>float</span><span class=p>]</span> <span class=o>=</span> <span class=n>production_times</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
    <span class=n>low_end</span><span class=p>:</span> <span class=n>Final</span><span class=p>[</span><span class=nb>int</span><span class=p>]</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>production_times</span><span class=p>)</span>
    <span class=n>total</span><span class=p>:</span> <span class=n>Final</span><span class=p>[</span><span class=nb>int</span><span class=p>]</span> <span class=o>=</span> <span class=n>low_end</span> <span class=o>//</span> <span class=mi>2</span>

    <span class=c1># First, we need to find the segment in the production cycle</span>
    <span class=c1># where the production begins. We use a binary search for that.</span>
    <span class=n>remaining</span><span class=p>:</span> <span class=nb>int</span> <span class=o>|</span> <span class=nb>float</span> <span class=o>=</span> <span class=n>amount</span>
    <span class=n>seg_start</span><span class=p>:</span> <span class=nb>float</span> <span class=o>=</span> <span class=n>start_time</span> <span class=o>%</span> <span class=n>time_mod</span>
    <span class=n>low</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>0</span>
    <span class=n>high</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=n>total</span>
    <span class=k>while</span> <span class=n>low</span> <span class=o><</span> <span class=n>high</span><span class=p>:</span>
        <span class=n>mid</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=p>(</span><span class=n>low</span> <span class=o>+</span> <span class=n>high</span><span class=p>)</span> <span class=o>//</span> <span class=mi>2</span>
        <span class=n>th</span><span class=p>:</span> <span class=nb>float</span> <span class=o>=</span> <span class=n>production_times</span><span class=p>[</span><span class=n>mid</span> <span class=o>*</span> <span class=mi>2</span> <span class=o>+</span> <span class=mi>1</span><span class=p>]</span>
        <span class=k>if</span> <span class=n>th</span> <span class=o><=</span> <span class=n>seg_start</span><span class=p>:</span>
            <span class=n>low</span> <span class=o>=</span> <span class=n>mid</span> <span class=o>+</span> <span class=mi>1</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>high</span> <span class=o>=</span> <span class=n>mid</span> <span class=o>-</span> <span class=mi>1</span>
    <span class=n>low</span> <span class=o>*=</span> <span class=mi>2</span>

    <span class=c1># Now we can cycle through the production cycle until the product has</span>
    <span class=c1># been produced.</span>
    <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
        <span class=n>max_time</span> <span class=o>=</span> <span class=n>production_times</span><span class=p>[</span><span class=n>low</span> <span class=o>+</span> <span class=mi>1</span><span class=p>]</span>
        <span class=k>while</span> <span class=n>max_time</span> <span class=o><=</span> <span class=n>seg_start</span><span class=p>:</span>
            <span class=n>low</span> <span class=o>+=</span> <span class=mi>2</span>
            <span class=k>if</span> <span class=n>low</span> <span class=o>>=</span> <span class=n>low_end</span><span class=p>:</span>
                <span class=n>low</span> <span class=o>=</span> <span class=mi>0</span>
                <span class=n>seg_start</span> <span class=o>=</span> <span class=mf>0.0</span>
            <span class=n>max_time</span> <span class=o>=</span> <span class=n>production_times</span><span class=p>[</span><span class=n>low</span> <span class=o>+</span> <span class=mi>1</span><span class=p>]</span>

        <span class=n>unit_time</span> <span class=o>=</span> <span class=n>production_times</span><span class=p>[</span><span class=n>low</span><span class=p>]</span>
        <span class=n>can_do</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=n>ceil</span><span class=p>(</span><span class=nb>min</span><span class=p>(</span>
            <span class=n>max_time</span> <span class=o>-</span> <span class=n>seg_start</span><span class=p>,</span> <span class=n>remaining</span><span class=p>)</span> <span class=o>/</span> <span class=n>unit_time</span><span class=p>)</span>
        <span class=n>duration</span> <span class=o>=</span> <span class=n>can_do</span> <span class=o>*</span> <span class=n>unit_time</span>
        <span class=n>seg_start</span> <span class=o>+=</span> <span class=n>duration</span>
        <span class=n>start_time</span> <span class=o>+=</span> <span class=n>duration</span>
        <span class=n>remaining</span> <span class=o>-=</span> <span class=n>can_do</span>
        <span class=k>if</span> <span class=n>remaining</span> <span class=o><=</span> <span class=mi>0</span><span class=p>:</span>
            <span class=k>return</span> <span class=nb>float</span><span class=p>(</span><span class=n>start_time</span><span class=p>)</span></div>



<div class=viewcode-block id=store_instances>
<a class=viewcode-back href=../../../moptipyapps.prodsched.html#moptipyapps.prodsched.instance.store_instances>[docs]</a>
<span class=k>def</span><span class=w> </span><span class=nf>store_instances</span><span class=p>(</span><span class=n>dest</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>instances</span><span class=p>:</span> <span class=n>Iterable</span><span class=p>[</span><span class=n>Instance</span><span class=p>])</span> <span class=o>-></span> <span class=kc>None</span><span class=p>:</span>
<span class=w>    </span><span class=sd>"""</span>
<span class=sd>    Store an iterable of instances to the given directory.</span>

<span class=sd>    :param dest: the destination directory</span>
<span class=sd>    :param instances: the instances</span>
<span class=sd>    """</span>
    <span class=n>dest_dir</span><span class=p>:</span> <span class=n>Final</span><span class=p>[</span><span class=n>Path</span><span class=p>]</span> <span class=o>=</span> <span class=n>Path</span><span class=p>(</span><span class=n>dest</span><span class=p>)</span>
    <span class=n>dest_dir</span><span class=o>.</span><span class=n>ensure_dir_exists</span><span class=p>()</span>

    <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>instances</span><span class=p>,</span> <span class=n>Iterable</span><span class=p>):</span>
        <span class=k>raise</span> <span class=n>type_error</span><span class=p>(</span><span class=n>instances</span><span class=p>,</span> <span class=s2>"instances"</span><span class=p>,</span> <span class=n>Iterable</span><span class=p>)</span>
    <span class=n>names</span><span class=p>:</span> <span class=n>Final</span><span class=p>[</span><span class=nb>set</span><span class=p>[</span><span class=nb>str</span><span class=p>]]</span> <span class=o>=</span> <span class=nb>set</span><span class=p>()</span>
    <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>instance</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>instances</span><span class=p>):</span>
        <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>instance</span><span class=p>,</span> <span class=n>Instance</span><span class=p>):</span>
            <span class=k>raise</span> <span class=n>type_error</span><span class=p>(</span><span class=n>instance</span><span class=p>,</span> <span class=sa>f</span><span class=s2>"instance[</span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s2>]"</span><span class=p>,</span> <span class=n>Instance</span><span class=p>)</span>
        <span class=n>name</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=n>instance</span><span class=o>.</span><span class=n>name</span>
        <span class=k>if</span> <span class=n>name</span> <span class=ow>in</span> <span class=n>names</span><span class=p>:</span>
            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span>
                <span class=sa>f</span><span class=s2>"Name </span><span class=si>{</span><span class=n>name</span><span class=si>!r}</span><span class=s2> of instance </span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s2> already occurred!"</span><span class=p>)</span>
        <span class=n>dest_file</span> <span class=o>=</span> <span class=n>dest_dir</span><span class=o>.</span><span class=n>resolve_inside</span><span class=p>(</span><span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>name</span><span class=si>}</span><span class=s2>.txt"</span><span class=p>)</span>
        <span class=k>if</span> <span class=n>dest_file</span><span class=o>.</span><span class=n>exists</span><span class=p>():</span>
            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=sa>f</span><span class=s2>"File </span><span class=si>{</span><span class=n>dest_file</span><span class=si>!r}</span><span class=s2> already exists, cannot "</span>
                             <span class=sa>f</span><span class=s2>"store </span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s2>th instance </span><span class=si>{</span><span class=n>name</span><span class=si>!r}</span><span class=s2>."</span><span class=p>)</span>
        <span class=k>try</span><span class=p>:</span>
            <span class=k>with</span> <span class=n>dest_file</span><span class=o>.</span><span class=n>open_for_write</span><span class=p>()</span> <span class=k>as</span> <span class=n>stream</span><span class=p>:</span>
                <span class=n>write_lines</span><span class=p>(</span><span class=n>to_stream</span><span class=p>(</span><span class=n>instance</span><span class=p>),</span> <span class=n>stream</span><span class=p>)</span>
        <span class=k>except</span> <span class=ne>OSError</span> <span class=k>as</span> <span class=n>ioe</span><span class=p>:</span>
            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=sa>f</span><span class=s2>"Error when writing instance </span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s2> with name "</span>
                             <span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>name</span><span class=si>!r}</span><span class=s2> to file </span><span class=si>{</span><span class=n>dest_file</span><span class=si>!r}</span><span class=s2>."</span><span class=p>)</span> <span class=kn>from</span><span class=w> </span><span class=nn>ioe</span></div>



<div class=viewcode-block id=instance_sort_key>
<a class=viewcode-back href=../../../moptipyapps.prodsched.html#moptipyapps.prodsched.instance.instance_sort_key>[docs]</a>
<span class=k>def</span><span class=w> </span><span class=nf>instance_sort_key</span><span class=p>(</span><span class=n>inst</span><span class=p>:</span> <span class=n>Instance</span><span class=p>)</span> <span class=o>-></span> <span class=nb>str</span><span class=p>:</span>
<span class=w>    </span><span class=sd>"""</span>
<span class=sd>    Get a sort key for instances.</span>

<span class=sd>    :param inst: the instance</span>
<span class=sd>    :return: the sort key</span>
<span class=sd>    """</span>
    <span class=k>return</span> <span class=n>inst</span><span class=o>.</span><span class=n>name</span></div>



<div class=viewcode-block id=load_instances>
<a class=viewcode-back href=../../../moptipyapps.prodsched.html#moptipyapps.prodsched.instance.load_instances>[docs]</a>
<span class=k>def</span><span class=w> </span><span class=nf>load_instances</span><span class=p>(</span>
        <span class=n>source</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>file_filter</span><span class=p>:</span> <span class=n>Callable</span><span class=p>[[</span><span class=n>Path</span><span class=p>],</span> <span class=nb>bool</span><span class=p>]</span> <span class=o>=</span> <span class=k>lambda</span> <span class=n>_</span><span class=p>:</span> <span class=kc>True</span><span class=p>)</span>\
        <span class=o>-></span> <span class=nb>tuple</span><span class=p>[</span><span class=n>Instance</span><span class=p>,</span> <span class=o>...</span><span class=p>]:</span>
<span class=w>    </span><span class=sd>"""</span>
<span class=sd>    Load the instances from a given irectory.</span>

<span class=sd>    This function iterates over the files in a directory and applies</span>
<span class=sd>    :func:`from_stream` to each text file (ends with `.txt`) that it finds</span>
<span class=sd>    and that is accepted by the filter `file_filter`. (The default file</span>
<span class=sd>    filter always returns `True`, i.e., accepts all files.)</span>

<span class=sd>    :param source: the source directory</span>
<span class=sd>    :param file_filter: a filter for files. Here you can provide a function</span>
<span class=sd>        or lambda that returns `True` if a file should be loaded and `False`</span>
<span class=sd>        otherwise. Notice that only `.txt` files are considered either way.</span>
<span class=sd>    :return: the tuple of instances</span>

<span class=sd>    >>> inst1 = Instance(</span>
<span class=sd>    ...     name="test1", n_products=1, n_customers=1, n_stations=2,</span>
<span class=sd>    ...     n_demands=1, time_end_warmup=10, time_end_measure=4000,</span>
<span class=sd>    ...     routes=[[0, 1]],</span>
<span class=sd>    ...     demands=[[0, 0, 0, 10, 20, 100]],</span>
<span class=sd>    ...     warehous_at_t0=[0],</span>
<span class=sd>    ...     station_product_unit_times=[[[10.0, 10000.0]],</span>
<span class=sd>    ...                                 [[30.0, 10000.0]]])</span>

<span class=sd>    >>> inst2 = Instance(</span>
<span class=sd>    ...     name="test2", n_products=2, n_customers=1, n_stations=2,</span>
<span class=sd>    ...      n_demands=3, time_end_warmup=21, time_end_measure=10000,</span>
<span class=sd>    ...     routes=[[0, 1], [1, 0]],</span>
<span class=sd>    ...     demands=[[0, 0, 1, 10, 20, 90], [1, 0, 0, 5, 22, 200],</span>
<span class=sd>    ...              [2, 0, 1, 7, 30, 200]],</span>
<span class=sd>    ...     warehous_at_t0=[2, 1],</span>
<span class=sd>    ...     station_product_unit_times=[[[10.0, 50.0, 15.0, 100.0],</span>
<span class=sd>    ...                                  [ 5.0, 20.0,  7.0,  35.0, 4.0, 50.0]],</span>
<span class=sd>    ...                                 [[ 5.0, 24.0,  7.0,  80.0],</span>
<span class=sd>    ...                                  [ 3.0, 21.0,  6.0,  50.0,]]])</span>

<span class=sd>    >>> from pycommons.io.temp import temp_dir</span>
<span class=sd>    >>> with temp_dir() as td:</span>
<span class=sd>    ...     store_instances(td, [inst2, inst1])</span>
<span class=sd>    ...     res = load_instances(td)</span>
<span class=sd>    >>> res == (inst1, inst2)</span>
<span class=sd>    True</span>
<span class=sd>    """</span>
    <span class=k>if</span> <span class=ow>not</span> <span class=nb>callable</span><span class=p>(</span><span class=n>file_filter</span><span class=p>):</span>
        <span class=k>raise</span> <span class=n>type_error</span><span class=p>(</span><span class=n>file_filter</span><span class=p>,</span> <span class=s2>"file_filter"</span><span class=p>,</span> <span class=n>call</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
    <span class=n>src</span><span class=p>:</span> <span class=n>Final</span><span class=p>[</span><span class=n>Path</span><span class=p>]</span> <span class=o>=</span> <span class=n>directory_path</span><span class=p>(</span><span class=n>source</span><span class=p>)</span>
    <span class=n>instances</span><span class=p>:</span> <span class=n>Final</span><span class=p>[</span><span class=nb>list</span><span class=p>[</span><span class=n>Instance</span><span class=p>]]</span> <span class=o>=</span> <span class=p>[]</span>
    <span class=k>for</span> <span class=n>file</span> <span class=ow>in</span> <span class=n>src</span><span class=o>.</span><span class=n>list_dir</span><span class=p>(</span><span class=n>files</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>directories</span><span class=o>=</span><span class=kc>False</span><span class=p>):</span>
        <span class=k>if</span> <span class=n>file</span><span class=o>.</span><span class=n>endswith</span><span class=p>(</span><span class=s2>".txt"</span><span class=p>)</span> <span class=ow>and</span> <span class=n>file_filter</span><span class=p>(</span><span class=n>file</span><span class=p>):</span>
            <span class=k>with</span> <span class=n>file</span><span class=o>.</span><span class=n>open_for_read</span><span class=p>()</span> <span class=k>as</span> <span class=n>stream</span><span class=p>:</span>
                <span class=n>instances</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>from_stream</span><span class=p>(</span><span class=n>stream</span><span class=p>))</span>
    <span class=k>if</span> <span class=nb>list</span><span class=o>.</span><span class=fm>__len__</span><span class=p>(</span><span class=n>instances</span><span class=p>)</span> <span class=o><=</span> <span class=mi>0</span><span class=p>:</span>
        <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=sa>f</span><span class=s2>"Found no instances in directory </span><span class=si>{</span><span class=n>src</span><span class=si>!r}</span><span class=s2>."</span><span class=p>)</span>
    <span class=n>instances</span><span class=o>.</span><span class=n>sort</span><span class=p>(</span><span class=n>key</span><span class=o>=</span><span class=n>instance_sort_key</span><span class=p>)</span>
    <span class=k>return</span> <span class=nb>tuple</span><span class=p>(</span><span class=n>instances</span><span class=p>)</span></div>

</pre></div><div class=clearer></div></div></div></div><div aria-label=Main class=sphinxsidebar role=navigation><div class=sphinxsidebarwrapper><search id=searchbox role=search style=display:none> <h3 id=searchlabel>Quick search</h3> <div class=searchformwrapper><form action=../../../search.html class=search><input aria-labelledby=searchlabel autocapitalize=off autocomplete=off autocorrect=off name=q spellcheck=false><input type=submit value=Go></form></div> </search><script>document.getElementById(`searchbox`).style.display=`block`;</script></div></div><div class=clearer></div></div><div aria-label=Related class=related role=navigation><h3>Navigation</h3><ul><li class=right style=margin-right:10px><a title="General Index"href=../../../genindex.html>index</a><li class=right><a title="Python Module Index"href=../../../py-modindex.html>modules</a> |<li class="nav-item nav-item-0"><a href=../../../index.html>moptipyapps 0.8.79 documentation</a> »<li class="nav-item nav-item-1"><a href=../../index.html>Module code</a> »<li class="nav-item nav-item-this"><a href>moptipyapps.prodsched.instance</a></ul></div><div class=footer role=contentinfo>© Copyright 2023-2025, Thomas Weise.</div>
